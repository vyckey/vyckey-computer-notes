"use strict";(self.webpackChunkvyckey_computer_notes=self.webpackChunkvyckey_computer_notes||[]).push([[6818],{45900:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var r=t(74848),i=t(28453);const a={title:"Autowired",tags:["java","spring","autowired"],sidebar_label:"Autowired",sidebar_position:4},s="@Autowired \u548c @Resource \u5b9e\u73b0\u8be6\u89e3",o={id:"framework/spring/spring-framework/ioc-impl/autowired",title:"Autowired",description:"@Autowired \u6ce8\u89e3\u7528\u4e8eBean\u5c5e\u6027\u548c\u65b9\u6cd5\u5c5e\u6027\u8f93\u5165\uff0c\u6240\u4ee5\u5176\u81ea\u52a8\u6ce8\u5165\u9636\u6bb5\u662f\u5728Bean\u5b9e\u4f8b\u5316\u4e4b\u540e\u7684\u5c5e\u6027\u586b\u5145\u9636\u6bb5\uff0c\u5bf9\u5e94\u5230\u5904\u7406\u5668\u4e5f\u5c31\u662f InstantiationAwareBeanPostProcessor#postProcessProperties \u3002\u5728Spring\u7684\u6846\u67b6\u4e2d\u5b58\u5728\u4e24\u4e2a\u6838\u5fc3\u7684\u5904\u7406\u5668\uff1a AutowiredAnnotationBeanPostProcessor \u7528\u4e8e\u89e3\u6790 @Autowired \u548c @Value \u6ce8\u89e3\uff0c CommonAnnotationBeanPostProcessor \u7528\u4e8e\u89e3\u6790 @Resource \u6ce8\u89e3\u3002",source:"@site/java/framework/spring/spring-framework/ioc-impl/autowired.md",sourceDirName:"framework/spring/spring-framework/ioc-impl",slug:"/framework/spring/spring-framework/ioc-impl/autowired",permalink:"/java/framework/spring/spring-framework/ioc-impl/autowired",draft:!1,unlisted:!1,tags:[{label:"java",permalink:"/java/tags/java"},{label:"spring",permalink:"/java/tags/spring"},{label:"autowired",permalink:"/java/tags/autowired"}],version:"current",lastUpdatedBy:"vyckey",lastUpdatedAt:1747456703e3,sidebarPosition:4,frontMatter:{title:"Autowired",tags:["java","spring","autowired"],sidebar_label:"Autowired",sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"BeanDefinition",permalink:"/java/framework/spring/spring-framework/ioc-impl/bean_definition"},next:{title:"Singleton \u4e09\u7ea7\u7f13\u5b58",permalink:"/java/framework/spring/spring-framework/ioc-impl/singleton_cache"}},c={},d=[{value:"\u7c7b\u56fe\u67b6\u6784",id:"\u7c7b\u56fe\u67b6\u6784",level:2},{value:"postProcessMergedBeanDefinition",id:"postprocessmergedbeandefinition",level:2},{value:"findAutowiringMetadata",id:"findautowiringmetadata",level:3},{value:"buildAutowiringMetadata",id:"buildautowiringmetadata",level:3},{value:"postProcessProperties",id:"postprocessproperties",level:2},{value:"InjectionMetadata",id:"injectionmetadata",level:2},{value:"AutowiredFieldElement",id:"autowiredfieldelement",level:3},{value:"AutowiredMethodElement",id:"autowiredmethodelement",level:3},{value:"\u7c7b\u56fe\u67b6\u6784",id:"\u7c7b\u56fe\u67b6\u6784-1",level:2},{value:"\u6784\u9020\u65b9\u6cd5",id:"\u6784\u9020\u65b9\u6cd5",level:2},{value:"postProcessMergedBeanDefinition",id:"postprocessmergedbeandefinition-1",level:2},{value:"buildLifecycleMetadata",id:"buildlifecyclemetadata",level:3},{value:"buildResourceMetadata",id:"buildresourcemetadata",level:3},{value:"postProcessProperties",id:"postprocessproperties-1",level:2},{value:"postProcessBeforeInitialization",id:"postprocessbeforeinitialization",level:2},{value:"postProcessBeforeDestruction",id:"postprocessbeforedestruction",level:2},{value:"ResourceElement",id:"resourceelement",level:2},{value:"\u6784\u9020\u65b9\u6cd5",id:"\u6784\u9020\u65b9\u6cd5-1",level:3},{value:"getResourceToInject",id:"getresourcetoinject",level:3},{value:"getResource \u548c autowireResource",id:"getresource-\u548c-autowireresource",level:3},{value:"resolveDependency",id:"resolvedependency",level:2},{value:"doResolveDependency",id:"doresolvedependency",level:2},{value:"doResolveDependency",id:"doresolvedependency-1",level:2},{value:"findAutowireCandidates",id:"findautowirecandidates",level:3},{value:"determineAutowireCandidate",id:"determineautowirecandidate",level:3}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"autowired-\u548c-resource-\u5b9e\u73b0\u8be6\u89e3",children:"@Autowired \u548c @Resource \u5b9e\u73b0\u8be6\u89e3"}),"\n",(0,r.jsx)(n.h1,{id:"\u57fa\u672c\u539f\u7406",children:"\u57fa\u672c\u539f\u7406"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"@Autowired"})," \u6ce8\u89e3\u7528\u4e8eBean\u5c5e\u6027\u548c\u65b9\u6cd5\u5c5e\u6027\u8f93\u5165\uff0c\u6240\u4ee5\u5176\u81ea\u52a8\u6ce8\u5165\u9636\u6bb5\u662f\u5728Bean\u5b9e\u4f8b\u5316\u4e4b\u540e\u7684\u5c5e\u6027\u586b\u5145\u9636\u6bb5\uff0c\u5bf9\u5e94\u5230\u5904\u7406\u5668\u4e5f\u5c31\u662f ",(0,r.jsx)(n.code,{children:"InstantiationAwareBeanPostProcessor#postProcessProperties"})," \u3002\u5728Spring\u7684\u6846\u67b6\u4e2d\u5b58\u5728\u4e24\u4e2a\u6838\u5fc3\u7684\u5904\u7406\u5668\uff1a ",(0,r.jsx)(n.code,{children:"AutowiredAnnotationBeanPostProcessor"})," \u7528\u4e8e\u89e3\u6790 ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u548c ",(0,r.jsx)(n.code,{children:"@Value"})," \u6ce8\u89e3\uff0c ",(0,r.jsx)(n.code,{children:"CommonAnnotationBeanPostProcessor"})," \u7528\u4e8e\u89e3\u6790 ",(0,r.jsx)(n.code,{children:"@Resource"})," \u6ce8\u89e3\u3002"]}),"\n",(0,r.jsx)(n.h1,{id:"\u5904\u7406\u5668\u7684\u6ce8\u518c",children:"\u5904\u7406\u5668\u7684\u6ce8\u518c"}),"\n",(0,r.jsxs)(n.p,{children:["\u5f53\u6211\u4eec\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext(AppConfig.class)"})," \u542f\u52a8\u5bb9\u5668\u7684\u65f6\u5019\uff0c\u5728\u6784\u9020\u65b9\u6cd5\u4e2d\u4f1a\u8c03\u7528\u5230 ",(0,r.jsx)(n.code,{children:"this()"})," \u65b9\u6cd5\uff0c\u5728 ",(0,r.jsx)(n.code,{children:"this()"})," \u65b9\u6cd5\u4e2d\u4f1a\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"ClassPathBeanDefinitionScanner#scan"})," \uff0c\u6700\u7ec8\u4f1a\u8c03\u7528\u5230 ",(0,r.jsx)(n.code,{children:"AnnotationConfigUtils#registerAnnotationConfigProcessors"})," \u65b9\u6cd5\uff0c\u5728\u8be5\u65b9\u6cd5\u4e2d\uff0cSpring\u4f1a\u5411\u5bb9\u5668\u6ce8\u518c7\u4e2aSpring\u5185\u7f6e\u7684Bean\uff0c\u5176\u4e2d\u5c31\u5305\u62ec ",(0,r.jsx)(n.code,{children:"AutowiredAnnotationBeanPostProcessor"})," \u3002\u5982\u4e0b\u4ee3\u7801\u6240\u793a\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"// ClassPathBeanDefinitionScanner.java\npublic int scan(String... basePackages) {\n    // <1> \u83b7\u53d6\u626b\u63cf\u524d\u7684 BeanDefinition \u6570\u91cf\n    int beanCountAtScanStart = this.registry.getBeanDefinitionCount();\n\n    // <2> \u8fdb\u884c\u626b\u63cf\uff0c\u5c06\u8fc7\u6ee4\u51fa\u6765\u7684\u6240\u6709\u7684 .class \u6587\u4ef6\u751f\u6210\u5bf9\u5e94\u7684 BeanDefinition \u5e76\u6ce8\u518c\n    doScan(basePackages);\n\n    // Register annotation config processors, if necessary.\n    // <3> \u5982\u679c `includeAnnotationConfig` \u4e3a `true`\uff08\u9ed8\u8ba4\uff09\uff0c\u5219\u6ce8\u518c\u51e0\u4e2a\u5173\u4e8e\u6ce8\u89e3\u7684 PostProcessor \u5904\u7406\u5668\uff08\u5173\u952e\uff09\n    // \u5728\u5176\u4ed6\u5730\u65b9\u4e5f\u4f1a\u6ce8\u518c\uff0c\u5185\u90e8\u4f1a\u8fdb\u884c\u5224\u65ad\uff0c\u5df2\u6ce8\u518c\u7684\u5904\u7406\u5668\u4e0d\u4f1a\u518d\u6ce8\u518c\n    if (this.includeAnnotationConfig) {\n        AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);\n    }\n\n    // <4> \u8fd4\u56de\u672c\u6b21\u626b\u63cf\u6ce8\u518c\u7684 BeanDefinition \u6570\u91cf\n    return (this.registry.getBeanDefinitionCount() - beanCountAtScanStart);\n}\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"// AnnotationConfigUtils.java\npublic static void registerAnnotationConfigProcessors(BeanDefinitionRegistry registry) {\n    registerAnnotationConfigProcessors(registry, null);\n}\n\npublic static Set<BeanDefinitionHolder> registerAnnotationConfigProcessors(\n        BeanDefinitionRegistry registry, @Nullable Object source) {\n    //./..\n    Set<BeanDefinitionHolder> beanDefs = new LinkedHashSet<>(8);\n\n    // \u5904\u7406 Spring \u5e94\u7528\u4e0a\u4e0b\u6587\u4e2d\u7684\u914d\u7f6e\u7c7b\n    if (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) {\n        RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class);\n        def.setSource(source);\n        beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));\n    }\n\n    // \u5904\u7406 @Autowired \u4ee5\u53ca @Value \u6ce8\u89e3\n    if (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) {\n        RootBeanDefinition def = new RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);\n        def.setSource(source);\n        beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));\n    }\n\n    //...\n    return beanDefs;\n}\n"})}),"\n",(0,r.jsx)(n.h1,{id:"autowiredannotationbeanpostprocessor",children:"AutowiredAnnotationBeanPostProcessor"}),"\n",(0,r.jsx)(n.h2,{id:"\u7c7b\u56fe\u67b6\u6784",children:"\u7c7b\u56fe\u67b6\u6784"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-mermaid",children:"classDiagram\n\nclass BeanPostProcessor\n\nclass InstantiationAwareBeanPostProcessor\n\nclass SmartInstantiationAwareBeanPostProcessor\n\nclass InstantiationAwareBeanPostProcessorAdapter\n\nclass AutowiredAnnotationBeanPostProcessor\n\nclass MergedBeanDefinitionPostProcessor\n\nBeanPostProcessor <|-- InstantiationAwareBeanPostProcessor\nInstantiationAwareBeanPostProcessor <|-- SmartInstantiationAwareBeanPostProcessor\nSmartInstantiationAwareBeanPostProcessor <|.. InstantiationAwareBeanPostProcessorAdapter\nInstantiationAwareBeanPostProcessorAdapter <|-- AutowiredAnnotationBeanPostProcessor\n\nBeanPostProcessor <|-- MergedBeanDefinitionPostProcessor\nMergedBeanDefinitionPostProcessor <|.. AutowiredAnnotationBeanPostProcessor\n"})}),"\n",(0,r.jsx)(n.h2,{id:"postprocessmergedbeandefinition",children:"postProcessMergedBeanDefinition"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"postProcessMergedBeanDefinition"})," \u65b9\u6cd5\u7528\u4e8e\u5904\u7406\u5408\u5e76Bean\u7684 ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u548c ",(0,r.jsx)(n.code,{children:"@Value"})," \u6ce8\u89e3\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"@Override\npublic void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName) {\n    // \u627e\u5230\u8fd9\u4e2a Bean \u6240\u6709\u9700\u8981\u6ce8\u5165\u7684\u5c5e\u6027\uff08@Autowired \u6216\u8005 @Value \u6ce8\u89e3\uff09\n    InjectionMetadata metadata = findAutowiringMetadata(beanName, beanType, null);\n    metadata.checkConfigMembers(beanDefinition);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"findautowiringmetadata",children:"findAutowiringMetadata"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"private InjectionMetadata findAutowiringMetadata(String beanName, Class<?> clazz, @Nullable PropertyValues pvs) {\n    // Fall back to class name as cache key, for backwards compatibility with custom callers.\n    // \u751f\u6210\u4e00\u4e2a\u7f13\u5b58 Key\n    String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());\n    // Quick check on the concurrent map first, with minimal locking.\n    // \u5148\u5c1d\u8bd5\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\n    InjectionMetadata metadata = this.injectionMetadataCache.get(cacheKey);\n    if (InjectionMetadata.needsRefresh(metadata, clazz)) { // \u662f\u5426\u9700\u8981\u5237\u65b0\uff0c\u4e5f\u5c31\u662f\u5224\u65ad\u7f13\u5b58\u662f\u5426\u547d\u4e2d\n        synchronized (this.injectionMetadataCache) {\n            metadata = this.injectionMetadataCache.get(cacheKey);\n            if (InjectionMetadata.needsRefresh(metadata, clazz)) { // \u52a0\u9501\uff0c\u518d\u5224\u65ad\u4e00\u6b21\n                if (metadata != null) {\n                    metadata.clear(pvs);\n                }\n                // \u6784\u5efa\u4e00\u4e2a\u9700\u8981\u6ce8\u5165\u7684\u5143\u4fe1\u606f\u5bf9\u8c61\n                metadata = buildAutowiringMetadata(clazz);\n                this.injectionMetadataCache.put(cacheKey, metadata);\n            }\n        }\n    }\n    return metadata;\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u9996\u5148\u5c1d\u8bd5\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u5bf9\u5e94\u7684\u6ce8\u5165\u5143\u4fe1\u606f\u5bf9\u8c61\uff0c\u6ca1\u6709\u627e\u5230\u7684\u8bdd\u5219\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"buildAutowiringMetadata(final Class<?> clazz)"})," \u6784\u5efa\u4e00\u4e2a\uff0c\u7136\u540e\u518d\u653e\u5165\u7f13\u5b58\u4e2d\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"buildautowiringmetadata",children:"buildAutowiringMetadata"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'private InjectionMetadata buildAutowiringMetadata(final Class<?> clazz) {\n    List<InjectionMetadata.InjectedElement> elements = new ArrayList<>();\n    Class<?> targetClass = clazz;\n\n    do {\n        // <1> \u521b\u5efa `currElements` \u96c6\u5408\uff0c\u7528\u4e8e\u4fdd\u5b58 @Autowired\u3001@Value \u6ce8\u89e3\u6807\u6ce8\u7684\u5b57\u6bb5\n        final List<InjectionMetadata.InjectedElement> currElements = new ArrayList<>();\n\n        // <2> \u904d\u5386\u8fd9\u4e2a Class \u5bf9\u8c61\u7684\u6240\u6709\u5b57\u6bb5\n        ReflectionUtils.doWithLocalFields(targetClass, field -> {\n            // <2.1> \u627e\u5230\u8be5\u5b57\u6bb5\u7684 @Autowired \u6216\u8005 @Value \u6ce8\u89e3\uff0c\u8fd4\u56de `ann` \u5bf9\u8c61\uff0c\u6ca1\u6709\u7684\u8bdd\u8fd4\u56de\u7a7a\u5bf9\u8c61\uff0c\u5219\u76f4\u63a5\u8df3\u8fc7\u4e0d\u8fdb\u884c\u4e0b\u9762\u7684\u64cd\u4f5c\n            AnnotationAttributes ann = findAutowiredAnnotation(field);\n            if (ann != null) {\n                // <2.2> \u8fdb\u884c\u8fc7\u6ee4\uff0cstatic \u4fee\u9970\u7684\u5b57\u6bb5\u4e0d\u8fdb\u884c\u6ce8\u5165\n                if (Modifier.isStatic(field.getModifiers())) {\n                    if (logger.isInfoEnabled()) {\n                        logger.info("Autowired annotation is not supported on static fields: " + field);\n                    }\n                    return;\n                }\n                // <2.3> \u83b7\u53d6\u6ce8\u89e3\u4e2d\u7684 `required` \u914d\u7f6e\n                boolean required = determineRequiredStatus(ann);\n                // <2.4> \u6839\u636e\u8be5\u5b57\u6bb5\u548c `required` \u6784\u5efa\u4e00\u4e2a AutowiredFieldElement \u5bf9\u8c61\uff0c\u6dfb\u52a0\u81f3 `currElements`\n                currElements.add(new AutowiredFieldElement(field, required));\n            }\n        });\n\n        // <3> \u904d\u5386\u8fd9\u4e2a Class \u5bf9\u8c61\u7684\u6240\u6709\u65b9\u6cd5\n        ReflectionUtils.doWithLocalMethods(targetClass, method -> {\n            // <3.1> \u5c1d\u8bd5\u627e\u5230\u8fd9\u4e2a\u65b9\u6cd5\u7684\u6865\u63a5\u65b9\u6cd5\uff0c\u6ca1\u6709\u7684\u8bdd\u5c31\u662f\u672c\u8eab\u8fd9\u4e2a\u65b9\u6cd5\n            Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);\n            // <3.2> \u5982\u679c\u662f\u6865\u63a5\u65b9\u6cd5\u5219\u76f4\u63a5\u8df3\u8fc7\n            if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) {\n                return;\n            }\n            // <3.3> \u627e\u5230\u8be5\u65b9\u6cd5\u7684 @Autowired \u6216\u8005 @Value \u6ce8\u89e3\uff0c\u8fd4\u56de `ann` \u5bf9\u8c61\uff0c\u6ca1\u6709\u7684\u8bdd\u8fd4\u56de\u7a7a\u5bf9\u8c61\uff0c\u5219\u76f4\u63a5\u8df3\u8fc7\u4e0d\u8fdb\u884c\u4e0b\u9762\u7684\u64cd\u4f5c\n            AnnotationAttributes ann = findAutowiredAnnotation(bridgedMethod);\n            if (ann != null && method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {\n                // <3.4> \u8fdb\u884c\u8fc7\u6ee4\uff0cstatic \u4fee\u9970\u7684\u65b9\u6cd5\u4e0d\u8fdb\u884c\u6ce8\u5165\n                if (Modifier.isStatic(method.getModifiers())) {\n                    if (logger.isInfoEnabled()) {\n                        logger.info("Autowired annotation is not supported on static methods: " + method);\n                    }\n                    return;\n                }\n                if (method.getParameterCount() == 0) {\n                    if (logger.isInfoEnabled()) {\n                        logger.info("Autowired annotation should only be used on methods with parameters: " +\n                                method);\n                    }\n                }\n                // <3.5> \u83b7\u53d6\u6ce8\u89e3\u4e2d\u7684 `required` \u914d\u7f6e\n                boolean required = determineRequiredStatus(ann);\n                PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);\n                // <3.6> \u6784\u5efa\u4e00\u4e2a AutowiredMethodElement \u5bf9\u8c61\uff0c\u6dfb\u52a0\u81f3 `currElements`\n                currElements.add(new AutowiredMethodElement(method, required, pd));\n            }\n        });\n\n        elements.addAll(0, currElements);\n        // <4> \u627e\u5230\u7236\u7c7b\uff0c\u5faa\u73af\u904d\u5386\n        targetClass = targetClass.getSuperclass();\n    }\n    while (targetClass != null && targetClass != Object.class);\n\n    // <5> \u6839\u636e\u4ece\u8fd9\u4e2a Bean \u89e3\u6790\u51fa\u6765\u7684\u6240\u6709 InjectedElement \u5bf9\u8c61\u751f\u6210\u4e00\u4e2a InjectionMetadata \u6ce8\u5165\u5143\u4fe1\u606f\u5bf9\u8c61\uff0c\u5e76\u8fd4\u56de\n    return new InjectionMetadata(clazz, elements);\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8fc7\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u521b\u5efa ",(0,r.jsx)(n.code,{children:"currElements"})," \u96c6\u5408\uff0c\u7528\u4e8e\u4fdd\u5b58 ",(0,r.jsx)(n.code,{children:"@Autowired"}),"\u3001",(0,r.jsx)(n.code,{children:"@Value"})," \u6ce8\u89e3\u6807\u6ce8\u7684\u5b57\u6bb5"]}),"\n",(0,r.jsxs)(n.li,{children:["\u904d\u5386\u8fd9\u4e2a Class \u5bf9\u8c61\u7684\u6240\u6709\u5b57\u6bb5","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u627e\u5230\u8be5\u5b57\u6bb5\u7684 ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u6216\u8005 ",(0,r.jsx)(n.code,{children:"@Value"})," \u6ce8\u89e3\uff0c\u8fd4\u56de ",(0,r.jsx)(n.code,{children:"ann"})," \u5bf9\u8c61\uff0c\u6ca1\u6709\u7684\u8bdd\u8fd4\u56de\u7a7a\u5bf9\u8c61\uff0c\u5219\u76f4\u63a5\u8df3\u8fc7\u4e0d\u8fdb\u884c\u4e0b\u9762\u7684\u64cd\u4f5c"]}),"\n",(0,r.jsxs)(n.li,{children:["\u8fdb\u884c\u8fc7\u6ee4\uff0c",(0,r.jsx)(n.code,{children:"static"})," \u4fee\u9970\u7684\u5b57\u6bb5\u4e0d\u8fdb\u884c\u6ce8\u5165"]}),"\n",(0,r.jsxs)(n.li,{children:["\u83b7\u53d6\u6ce8\u89e3\u4e2d\u7684 ",(0,r.jsx)(n.code,{children:"required"})," \u914d\u7f6e"]}),"\n",(0,r.jsxs)(n.li,{children:["\u6839\u636e\u8be5\u5b57\u6bb5\u548c ",(0,r.jsx)(n.code,{children:"required"})," \u6784\u5efa\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"AutowiredFieldElement"})," \u5bf9\u8c61\uff0c\u6dfb\u52a0\u81f3 ",(0,r.jsx)(n.code,{children:"currElements"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u904d\u5386\u8fd9\u4e2a Class \u5bf9\u8c61\u7684\u6240\u6709\u65b9\u6cd5","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u5c1d\u8bd5\u627e\u5230\u8fd9\u4e2a\u65b9\u6cd5\u7684\u6865\u63a5\u65b9\u6cd5\uff0c\u6ca1\u6709\u7684\u8bdd\u5c31\u662f\u672c\u8eab\u8fd9\u4e2a\u65b9\u6cd5"}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u662f\u6865\u63a5\u65b9\u6cd5\u5219\u76f4\u63a5\u8df3\u8fc7"}),"\n",(0,r.jsxs)(n.li,{children:["\u627e\u5230\u8be5\u65b9\u6cd5\u7684 ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u6216\u8005 ",(0,r.jsx)(n.code,{children:"@Value"})," \u6ce8\u89e3\uff0c\u8fd4\u56de ",(0,r.jsx)(n.code,{children:"ann"})," \u5bf9\u8c61\uff0c\u6ca1\u6709\u7684\u8bdd\u8fd4\u56de\u7a7a\u5bf9\u8c61\uff0c\u5219\u76f4\u63a5\u8df3\u8fc7\u4e0d\u8fdb\u884c\u4e0b\u9762\u7684\u64cd\u4f5c"]}),"\n",(0,r.jsxs)(n.li,{children:["\u8fdb\u884c\u8fc7\u6ee4\uff0c",(0,r.jsx)(n.code,{children:"static"})," \u4fee\u9970\u7684\u65b9\u6cd5\u4e0d\u8fdb\u884c\u6ce8\u5165"]}),"\n",(0,r.jsxs)(n.li,{children:["\u83b7\u53d6\u6ce8\u89e3\u4e2d\u7684 ",(0,r.jsx)(n.code,{children:"required"})," \u914d\u7f6e"]}),"\n",(0,r.jsxs)(n.li,{children:["\u6784\u5efa\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"AutowiredMethodElement"})," \u5bf9\u8c61\uff0c\u6dfb\u52a0\u81f3 ",(0,r.jsx)(n.code,{children:"currElements"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u627e\u5230\u7236\u7c7b\uff0c\u5faa\u73af\u904d\u5386"}),"\n",(0,r.jsxs)(n.li,{children:["\u6839\u636e\u4ece\u8fd9\u4e2a Bean \u89e3\u6790\u51fa\u6765\u7684\u6240\u6709 ",(0,r.jsx)(n.code,{children:"InjectedElement"})," \u5bf9\u8c61\u751f\u6210\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"InjectionMetadata"})," \u6ce8\u5165\u5143\u4fe1\u606f\u5bf9\u8c61\uff0c\u5e76\u8fd4\u56de"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u6574\u4e2a\u8fc7\u7a0b\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u89e3\u6790\u51fa\u6240\u6709 ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u6216\u8005 ",(0,r.jsx)(n.code,{children:"@Value"})," \u6ce8\u89e3\u6807\u6ce8\u7684\u65b9\u6cd5\u6216\u8005\u5b57\u6bb5\uff0c\u7136\u540e\u6784\u5efa\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"InjectionMetadata"})," \u6ce8\u5165\u5143\u4fe1\u606f\u5bf9\u8c61\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"postprocessproperties",children:"postProcessProperties"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"postProcessProperties"})," \u65b9\u6cd5\u7528\u4e8e\u89e3\u6790\u5e76\u5904\u7406 ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u548c ",(0,r.jsx)(n.code,{children:"@Value"})," \u6ce8\u89e3\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@Override\npublic PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) {\n    // \u627e\u5230\u8fd9\u4e2a Bean \u7684\u6ce8\u5165\u5143\u4fe1\u606f\u5bf9\u8c61\n    InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs);\n    try {\n        // \u8fdb\u884c\u6ce8\u5165\n        metadata.inject(bean, beanName, pvs);\n    } catch (BeanCreationException ex) {\n        throw ex;\n    } catch (Throwable ex) {\n        throw new BeanCreationException(beanName, "Injection of autowired dependencies failed", ex);\n    }\n    return pvs;\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"injectionmetadata",children:"InjectionMetadata"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"InjectionMetadata"})," \u7c7b\u4fdd\u5b58\u4e86\u67d0\u4e2a Class \u7684\u6ce8\u5165\u5143\u7d20\uff08\u5c5e\u6027\u548c\u65b9\u6cd5\uff09\u7684\u5143\u6570\u636e\uff0c\u5e76\u63d0\u4f9b\u4e86 ",(0,r.jsx)(n.code,{children:"inject"})," \u7b49\u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public class InjectionMetadata {\n\tprivate final Class<?> targetClass;\n\n\t/**\n\t * \u9700\u8981\u6ce8\u5165\u7684\u5b57\u6bb5\uff08\u6216\u65b9\u6cd5\uff09\u7684\u5143\u4fe1\u606f\n\t */\n\tprivate final Collection<InjectedElement> injectedElements;\n\n\t@Nullable\n\tprivate volatile Set<InjectedElement> checkedElements;\n\n\tpublic InjectionMetadata(Class<?> targetClass, Collection<InjectedElement> elements) {\n\t\tthis.targetClass = targetClass;\n\t\tthis.injectedElements = elements;\n\t}\n\n\tpublic void inject(Object target, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable {\n\t\tCollection<InjectedElement> checkedElements = this.checkedElements;\n\t\tCollection<InjectedElement> elementsToIterate =\n\t\t\t\t(checkedElements != null ? checkedElements : this.injectedElements);\n\t\tif (!elementsToIterate.isEmpty()) {\n\t\t\tfor (InjectedElement element : elementsToIterate) {\n\t\t\t\telement.inject(target, beanName, pvs);\n\t\t\t}\n\t\t}\n\t}\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5bf9\u4e8e\u5c5e\u6027\u4e0a\u52a0\u4e86 ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u6ce8\u89e3\u7684\uff0c\u7ecf\u8fc7\u4e0a\u4e00\u6b65\u89e3\u6790\u540e\uff0c\u4f1a\u5c06\u5b57\u6bb5\u89e3\u6790\u4e3a ",(0,r.jsx)(n.code,{children:"AutowiredFieldElement"})," \u7c7b\u578b\uff1b\u5982\u679c\u662f\u65b9\u6cd5\u4e0a\u52a0\u4e86 ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u6ce8\u89e3\uff0c\u5219\u4f1a\u89e3\u6790\u4e3a ",(0,r.jsx)(n.code,{children:"AutowiredMethodElement"})," \u7c7b\u578b\u3002\u5b83\u4eec\u5747\u662f ",(0,r.jsx)(n.code,{children:"InjectedElement"})," \u7c7b\u7684\u5b50\u7c7b\uff0c\u91cc\u9762\u5c01\u88c5\u4e86\u5c5e\u6027\u540d\uff0c\u5c5e\u6027\u7c7b\u578b\u7b49\u4fe1\u606f\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"autowiredfieldelement",children:"AutowiredFieldElement"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'private class AutowiredFieldElement extends InjectionMetadata.InjectedElement {\n    /** \u662f\u5426\u5fc5\u987b */\n    private final boolean required;\n    /** \u662f\u5426\u7f13\u5b58\u8d77\u6765\u4e86 */\n    private volatile boolean cached = false;\n    /** \u7f13\u5b58\u7684\u5bf9\u8c61 */\n    @Nullable\n    private volatile Object cachedFieldValue;\n\n    public AutowiredFieldElement(Field field, boolean required) {\n        super(field, null);\n        this.required = required;\n    }\n\n    @Override\n    protected void inject(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable {\n        // <1> \u83b7\u53d6 `field` \u5b57\u6bb5\n        Field field = (Field) this.member;\n        Object value;\n        // <2> \u5982\u679c\u8fdb\u884c\u7f13\u5b58\u4e86\uff0c\u5219\u5c1d\u8bd5\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\n        if (this.cached) {\n            value = resolvedCachedArgument(beanName, this.cachedFieldValue);\n        }\n        // <3> \u5426\u5219\uff0c\u5f00\u59cb\u8fdb\u884c\u89e3\u6790\n        else {\n            // <3.1> \u521b\u5efa\u4e00\u4e2a\u4f9d\u8d56\u6ce8\u5165\u63cf\u8ff0\u5668 `desc`\n            DependencyDescriptor desc = new DependencyDescriptor(field, this.required);\n            desc.setContainingClass(bean.getClass());\n            Set<String> autowiredBeanNames = new LinkedHashSet<>(1);\n            Assert.state(beanFactory != null, "No BeanFactory available");\n            TypeConverter typeConverter = beanFactory.getTypeConverter();\n            try {\n                /**\n                 * <3.2> \u901a\u8fc7 {@link org.springframework.beans.factory.support.DefaultListableBeanFactory#resolveDependency} \u65b9\u6cd5\n                 * \u627e\u5230\u8fd9\u4e2a\u5b57\u6bb5\u5bf9\u5e94\u7684 Bean\uff08\u4eec\uff09\n                 */\n                value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);\n            }\n            catch (BeansException ex) {\n                throw new UnsatisfiedDependencyException(null, beanName, new InjectionPoint(field), ex);\n            }\n            // <3.3> \u548c\u7f13\u5b58\u76f8\u5173\uff0c\u5982\u679c\u6709\u5fc5\u8981\u5219\u5c06\u672c\u6b21\u627e\u5230\u7684\u6ce8\u5165\u5bf9\u8c61\u7f13\u5b58\u8d77\u6765\uff0c\u907f\u514d\u4e0b\u6b21\u518d\u8fdb\u884c\u89e3\u6790\n            synchronized (this) {\n                if (!this.cached) {\n                    if (value != null || this.required) {\n                        this.cachedFieldValue = desc;\n                        registerDependentBeans(beanName, autowiredBeanNames);\n                        if (autowiredBeanNames.size() == 1) {\n                            String autowiredBeanName = autowiredBeanNames.iterator().next();\n                            if (beanFactory.containsBean(autowiredBeanName) &&\n                                    beanFactory.isTypeMatch(autowiredBeanName, field.getType())) {\n                                this.cachedFieldValue = new ShortcutDependencyDescriptor(\n                                        desc, autowiredBeanName, field.getType());\n                            }\n                        }\n                    }\n                    else {\n                        this.cachedFieldValue = null;\n                    }\n                    this.cached = true;\n                }\n            }\n        }\n        // <4> \u5982\u679c\u83b7\u53d6\u5230\u8be5\u5b57\u6bb5\u5bf9\u5e94\u7684\u5bf9\u8c61\uff0c\u5219\u8fdb\u884c\u5c5e\u6027\u8d4b\u503c\uff08\u4f9d\u8d56\u6ce8\u5165\uff09\n        if (value != null) {\n            ReflectionUtils.makeAccessible(field);\n            field.set(bean, value);\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u6ce8\u5165\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u83b7\u53d6 ",(0,r.jsx)(n.code,{children:"field"})," \u5b57\u6bb5"]}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u8fdb\u884c\u7f13\u5b58\u4e86\uff0c\u5219\u5c1d\u8bd5\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6"}),"\n",(0,r.jsxs)(n.li,{children:["\u5426\u5219\uff0c\u5f00\u59cb\u8fdb\u884c\u89e3\u6790","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u521b\u5efa\u4e00\u4e2a\u4f9d\u8d56\u6ce8\u5165\u63cf\u8ff0\u5668 ",(0,r.jsx)(n.code,{children:"desc"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u3010\u6838\u5fc3\u3011\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"DefaultListableBeanFactory#resolveDependency(...)"})," \u65b9\u6cd5\uff0c\u627e\u5230\u8fd9\u4e2a\u5b57\u6bb5\u5bf9\u5e94\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff08\u4eec\uff09"]}),"\n",(0,r.jsx)(n.li,{children:"\u548c\u7f13\u5b58\u76f8\u5173\uff0c\u5982\u679c\u6709\u5fc5\u8981\u5219\u5c06\u672c\u6b21\u627e\u5230\u7684\u6ce8\u5165\u5bf9\u8c61\u7f13\u5b58\u8d77\u6765\uff0c\u907f\u514d\u4e0b\u6b21\u518d\u8fdb\u884c\u89e3\u6790"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u83b7\u53d6\u5230\u8be5\u5b57\u6bb5\u5bf9\u5e94\u7684\u5bf9\u8c61\uff0c\u5219\u8fdb\u884c\u5c5e\u6027\u8d4b\u503c\uff08\u4f9d\u8d56\u6ce8\u5165\uff09\uff0c\u5e95\u5c42\u5c31\u662f\u901a\u8fc7\u53cd\u5c04\u673a\u5236\u4e3a\u8be5\u5b57\u6bb5\u8d4b\u503c"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230\u6574\u4e2a\u7684\u6838\u5fc3\u5728\u4e8e\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"DefaultListableBeanFactory#resolveDependency(...)"})," \u65b9\u6cd5\u627e\u5230\u5b57\u6bb5\u5bf9\u5e94\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u8fd9\u91cc\u4e5f\u8bb8\u662f\u4e00\u4e2a\u96c6\u5408\u5bf9\u8c61\uff0c\u6240\u4ee5\u4e5f\u53ef\u80fd\u627e\u5230\u7684\u662f\u591a\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"autowiredmethodelement",children:"AutowiredMethodElement"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'private class AutowiredMethodElement extends InjectionMetadata.InjectedElement {\n    /** \u662f\u5426\u5fc5\u987b */\n    private final boolean required;\n    /** \u662f\u5426\u7f13\u5b58\u8d77\u6765\u4e86 */\n    private volatile boolean cached = false;\n    /** \u7f13\u5b58\u7684\u65b9\u6cd5\u53c2\u6570\u5bf9\u8c61 */\n    @Nullable\n    private volatile Object[] cachedMethodArguments;\n\n    public AutowiredMethodElement(Method method, boolean required, @Nullable PropertyDescriptor pd) {\n        super(method, pd);\n        this.required = required;\n    }\n\n    @Override\n    protected void inject(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable {\n        if (checkPropertySkipping(pvs)) {\n            return;\n        }\n        // <1> \u83b7\u53d6 `method` \u65b9\u6cd5\n        Method method = (Method) this.member;\n        // <2> \u5982\u679c\u8fdb\u884c\u7f13\u5b58\u4e86\uff0c\u5219\u5c1d\u8bd5\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\u65b9\u6cd5\u53c2\u6570\u5bf9\u8c61\n        Object[] arguments;\n        if (this.cached) {\n            // Shortcut for avoiding synchronization...\n            arguments = resolveCachedArguments(beanName);\n        }\n        // <3> \u5426\u5219\uff0c\u5f00\u59cb\u8fdb\u884c\u89e3\u6790\n        else {\n            // <3.1> \u83b7\u53d6\u65b9\u6cd5\u7684\u53c2\u6570\u7c7b\u578b\u96c6\u5408 `paramTypes`\uff0c\u6839\u636e\u53c2\u6570\u4f4d\u7f6e\u786e\u5b9a\u53c2\u6570\n            Class<?>[] paramTypes = method.getParameterTypes();\n            arguments = new Object[paramTypes.length];\n            // <3.2> \u6784\u5efa\u4e00\u4e2a\u4f9d\u8d56\u6ce8\u5165\u63cf\u8ff0\u5668\u6570\u7ec4 `descriptors`\uff0c\u7528\u4e8e\u4fdd\u5b58\u540e\u7eed\u521b\u5efa\u7684\u5bf9\u8c61\n            DependencyDescriptor[] descriptors = new DependencyDescriptor[paramTypes.length];\n            Set<String> autowiredBeans = new LinkedHashSet<>(paramTypes.length);\n            Assert.state(beanFactory != null, "No BeanFactory available");\n            TypeConverter typeConverter = beanFactory.getTypeConverter();\n            // <3.3> \u6839\u636e\u53c2\u6570\u987a\u5e8f\u904d\u5386\u8be5\u65b9\u6cd5\u7684\u53c2\u6570\n            for (int i = 0; i < arguments.length; i++) {\n                // <3.3.1> \u4e3a\u7b2c `i` \u4e2a\u65b9\u6cd5\u53c2\u6570\u521b\u5efa\u4e00\u4e2a MethodParameter \u5bf9\u8c61\n                MethodParameter methodParam = new MethodParameter(method, i);\n                // <3.3.2> \u521b\u5efa\u4f9d\u8d56\u63cf\u8ff0\u5668 `currDesc`\uff0c\u5e76\u6dfb\u52a0\u81f3 `descriptors` \u6570\u7ec4\n                DependencyDescriptor currDesc = new DependencyDescriptor(methodParam, this.required);\n                currDesc.setContainingClass(bean.getClass());\n                descriptors[i] = currDesc;\n                try {\n                    /**\n                     * <3.3.3> \u901a\u8fc7 {@link org.springframework.beans.factory.support.DefaultListableBeanFactory#resolveDependency} \u65b9\u6cd5\n                     * \u627e\u5230\u8fd9\u4e2a\u65b9\u6cd5\u53c2\u6570\u5bf9\u5e94\u7684 Bean\uff08\u4eec\uff09\n                     */\n                    Object arg = beanFactory.resolveDependency(currDesc, beanName, autowiredBeans, typeConverter);\n                    if (arg == null && !this.required) {\n                        arguments = null;\n                        break;\n                    }\n                    arguments[i] = arg;\n                }\n                catch (BeansException ex) {\n                    throw new UnsatisfiedDependencyException(null, beanName, new InjectionPoint(methodParam), ex);\n                }\n            }\n            // <3.4> \u548c\u7f13\u5b58\u76f8\u5173\uff0c\u5982\u679c\u6709\u5fc5\u8981\u5219\u5c06\u672c\u6b21\u627e\u5230\u7684\u65b9\u6cd5\u53c2\u6570\u5bf9\u8c61\u7f13\u5b58\u8d77\u6765\uff0c\u907f\u514d\u4e0b\u6b21\u518d\u8fdb\u884c\u89e3\u6790\n            synchronized (this) {\n                if (!this.cached) {\n                    if (arguments != null) {\n                        Object[] cachedMethodArguments = new Object[paramTypes.length];\n                        System.arraycopy(descriptors, 0, cachedMethodArguments, 0, arguments.length);\n                        registerDependentBeans(beanName, autowiredBeans);\n                        if (autowiredBeans.size() == paramTypes.length) {\n                            Iterator<String> it = autowiredBeans.iterator();\n                            for (int i = 0; i < paramTypes.length; i++) {\n                                String autowiredBeanName = it.next();\n                                if (beanFactory.containsBean(autowiredBeanName) &&\n                                        beanFactory.isTypeMatch(autowiredBeanName, paramTypes[i])) {\n                                    cachedMethodArguments[i] = new ShortcutDependencyDescriptor(\n                                            descriptors[i], autowiredBeanName, paramTypes[i]);\n                                }\n                            }\n                        }\n                        this.cachedMethodArguments = cachedMethodArguments;\n                    }\n                    else {\n                        this.cachedMethodArguments = null;\n                    }\n                    this.cached = true;\n                }\n            }\n        }\n        // <4> \u5982\u679c\u627e\u5230\u8be5\u65b9\u6cd5\u7684\u53c2\u6570\uff08\u4eec\uff09\uff0c\u5219\u8fdb\u884c\u5c5e\u6027\u8d4b\u503c\uff08\u4f9d\u8d56\u6ce8\u5165\uff09\n        if (arguments != null) {\n            try {\n                ReflectionUtils.makeAccessible(method);\n                // \u901a\u8fc7\u53cd\u5c04\u673a\u5236\u8c03\u7528\u8be5\u65b9\u6cd5\n                method.invoke(bean, arguments);\n            }\n            catch (InvocationTargetException ex) {\n                throw ex.getTargetException();\n            }\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u6ce8\u5165\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u83b7\u53d6 ",(0,r.jsx)(n.code,{children:"method"})," \u65b9\u6cd5"]}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u8fdb\u884c\u7f13\u5b58\u4e86\uff0c\u5219\u5c1d\u8bd5\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\u65b9\u6cd5\u53c2\u6570\u5bf9\u8c61"}),"\n",(0,r.jsxs)(n.li,{children:["\u5426\u5219\uff0c\u5f00\u59cb\u8fdb\u884c\u89e3\u6790","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u83b7\u53d6\u65b9\u6cd5\u7684\u53c2\u6570\u7c7b\u578b\u96c6\u5408 ",(0,r.jsx)(n.code,{children:"paramTypes"})," \uff0c\u6839\u636e\u53c2\u6570\u4f4d\u7f6e\u786e\u5b9a\u53c2\u6570"]}),"\n",(0,r.jsxs)(n.li,{children:["\u6784\u5efa\u4e00\u4e2a\u4f9d\u8d56\u6ce8\u5165\u63cf\u8ff0\u5668\u6570\u7ec4 ",(0,r.jsx)(n.code,{children:"descriptors"}),"\uff0c\u7528\u4e8e\u4fdd\u5b58\u540e\u7eed\u521b\u5efa\u7684\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(n.li,{children:["\u6839\u636e\u53c2\u6570\u987a\u5e8f\u904d\u5386\u8be5\u65b9\u6cd5\u7684\u53c2\u6570","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u4e3a\u7b2c ",(0,r.jsx)(n.code,{children:"i"})," \u4e2a\u65b9\u6cd5\u53c2\u6570\u521b\u5efa\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"MethodParameter"})," \u5bf9\u8c61"]}),"\n",(0,r.jsxs)(n.li,{children:["\u521b\u5efa\u4f9d\u8d56\u63cf\u8ff0\u5668 ",(0,r.jsx)(n.code,{children:"currDesc"}),"\uff0c\u5e76\u6dfb\u52a0\u81f3 ",(0,r.jsx)(n.code,{children:"descriptors"})," \u6570\u7ec4"]}),"\n",(0,r.jsxs)(n.li,{children:["\u3010\u6838\u5fc3\u3011\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"DefaultListableBeanFactory#resolveDependency(...)"})," \u65b9\u6cd5\uff0c\u627e\u5230\u8fd9\u4e2a\u65b9\u6cd5\u53c2\u6570\u5bf9\u5e94\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff08\u4eec\uff09"]}),"\n",(0,r.jsx)(n.li,{children:"\u548c\u7f13\u5b58\u76f8\u5173\uff0c\u5982\u679c\u6709\u5fc5\u8981\u5219\u5c06\u672c\u6b21\u627e\u5230\u7684\u65b9\u6cd5\u53c2\u6570\u5bf9\u8c61\u7f13\u5b58\u8d77\u6765\uff0c\u907f\u514d\u4e0b\u6b21\u518d\u8fdb\u884c\u89e3\u6790"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u627e\u5230\u8be5\u65b9\u6cd5\u7684\u53c2\u6570\uff08\u4eec\uff09\uff0c\u5219\u8fdb\u884c\u5c5e\u6027\u8d4b\u503c\uff08\u4f9d\u8d56\u6ce8\u5165\uff09\uff0c\u5e95\u5c42\u5c31\u662f\u901a\u8fc7\u53cd\u5c04\u673a\u5236\u8c03\u7528\u8be5\u65b9\u6cd5"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230\u6574\u4e2a\u7684\u6838\u5fc3\u4e5f\u662f\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"DefaultListableBeanFactory#resolveDependency(...)"})," \u65b9\u6cd5\u627e\u5230\u65b9\u6cd5\u53c2\u6570\u5bf9\u5e94\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u3002"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h1,{id:"commonannotationbeanpostprocessor",children:"CommonAnnotationBeanPostProcessor"}),"\n",(0,r.jsx)(n.h2,{id:"\u7c7b\u56fe\u67b6\u6784-1",children:"\u7c7b\u56fe\u67b6\u6784"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-mermaid",children:"classDiagram\n\nclass BeanPostProcessor\n\nclass MergedBeanDefinitionPostProcessor\n\nclass InstantiationAwareBeanPostProcessor\n\nclass DestructionAwareBeanPostProcessor\n\nclass InitDestroyAnnotationBeanPostProcessor\n\nclass CommonAnnotationBeanPostProcessor\n\n\nBeanPostProcessor <|-- MergedBeanDefinitionPostProcessor\nBeanPostProcessor <|-- InstantiationAwareBeanPostProcessor\nBeanPostProcessor <|-- DestructionAwareBeanPostProcessor\nMergedBeanDefinitionPostProcessor <|.. InitDestroyAnnotationBeanPostProcessor\nDestructionAwareBeanPostProcessor <|.. InitDestroyAnnotationBeanPostProcessor\n\nInstantiationAwareBeanPostProcessor <|.. CommonAnnotationBeanPostProcessor\nInitDestroyAnnotationBeanPostProcessor <|-- CommonAnnotationBeanPostProcessor\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230 ",(0,r.jsx)(n.code,{children:"CommonAnnotationBeanPostProcessor"})," \u5b9e\u73b0\u4e86 ",(0,r.jsx)(n.code,{children:"MergedBeanDefinitionPostProcessor"})," \u548c ",(0,r.jsx)(n.code,{children:"InstantiationAwareBeanPostProcessor"})," \u4e24\u4e2a\u63a5\u53e3\uff0c\u8fd8\u5b9e\u73b0\u4e86 ",(0,r.jsx)(n.code,{children:"DestructionAwareBeanPostProcessor"})," \u63a5\u53e3\uff0c\u7528\u4e8e\u751f\u547d\u5468\u671f\u4e2d\u7684\u521d\u59cb\u5316\u548c\u9500\u6bc1\u7684\u5904\u7406\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"\u6784\u9020\u65b9\u6cd5",children:"\u6784\u9020\u65b9\u6cd5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'public class CommonAnnotationBeanPostProcessor extends InitDestroyAnnotationBeanPostProcessor\n\t\timplements InstantiationAwareBeanPostProcessor, BeanFactoryAware, Serializable {\n\n\t@Nullable\n\tprivate static Class<? extends Annotation> webServiceRefClass;\n\n\t@Nullable\n\tprivate static Class<? extends Annotation> ejbRefClass;\n\n\tstatic {\n\t\ttry {\n\t\t\t@SuppressWarnings("unchecked")\n\t\t\tClass<? extends Annotation> clazz = (Class<? extends Annotation>)\n\t\t\t\t\tClassUtils.forName("javax.xml.ws.WebServiceRef", CommonAnnotationBeanPostProcessor.class.getClassLoader());\n\t\t\twebServiceRefClass = clazz;\n\t\t}\n\t\tcatch (ClassNotFoundException ex) {\n\t\t\twebServiceRefClass = null;\n\t\t}\n\t\ttry {\n\t\t\t@SuppressWarnings("unchecked")\n\t\t\tClass<? extends Annotation> clazz = (Class<? extends Annotation>)\n\t\t\t\t\tClassUtils.forName("javax.ejb.EJB", CommonAnnotationBeanPostProcessor.class.getClassLoader());\n\t\t\tejbRefClass = clazz;\n\t\t}\n\t\tcatch (ClassNotFoundException ex) {\n\t\t\tejbRefClass = null;\n\t\t}\n\t}\n\n\t/**\n\t * Create a new CommonAnnotationBeanPostProcessor,\n\t * with the init and destroy annotation types set to\n\t * {@link javax.annotation.PostConstruct} and {@link javax.annotation.PreDestroy},\n\t * respectively.\n\t */\n\tpublic CommonAnnotationBeanPostProcessor() {\n\t\tsetOrder(Ordered.LOWEST_PRECEDENCE - 3);\n\t\tsetInitAnnotationType(PostConstruct.class);\n\t\tsetDestroyAnnotationType(PreDestroy.class);\n\t\tignoreResourceType("javax.xml.ws.WebServiceContext");\n\t}\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public class InitDestroyAnnotationBeanPostProcessor\n\t\timplements DestructionAwareBeanPostProcessor, MergedBeanDefinitionPostProcessor, PriorityOrdered, Serializable {\n\n\tprotected transient Log logger = LogFactory.getLog(getClass());\n\n\t/**\n\t * \u521d\u59cb\u5316\u6ce8\u89e3\uff0c\u9ed8\u8ba4\u4e3a @PostConstruct\n\t */\n\t@Nullable\n\tprivate Class<? extends Annotation> initAnnotationType;\n\n\t/**\n\t * \u9500\u6bc1\u6ce8\u89e3\uff0c\u9ed8\u8ba4\u4e3a @PreDestroy\n\t */\n\t@Nullable\n\tprivate Class<? extends Annotation> destroyAnnotationType;\n\n\tprivate int order = Ordered.LOWEST_PRECEDENCE;\n\n\t@Nullable\n\tprivate final transient Map<Class<?>, LifecycleMetadata> lifecycleMetadataCache = new ConcurrentHashMap<>(256);\n\n\tpublic void setInitAnnotationType(Class<? extends Annotation> initAnnotationType) {\n\t\tthis.initAnnotationType = initAnnotationType;\n\t}\n\n\tpublic void setDestroyAnnotationType(Class<? extends Annotation> destroyAnnotationType) {\n\t\tthis.destroyAnnotationType = destroyAnnotationType;\n\t}\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230\u4f1a\u8bbe\u7f6e\u521d\u59cb\u5316\u6ce8\u89e3\u4e3a ",(0,r.jsx)(n.code,{children:"@PostConstruct"}),"\uff0c\u9500\u6bc1\u6ce8\u89e3\u4e3a ",(0,r.jsx)(n.code,{children:"@PreDestroy"}),"\uff0c\u8fd9\u4e24\u4e2a\u6ce8\u89e3\u90fd\u662f ",(0,r.jsx)(n.code,{children:"JSR-250"})," \u6ce8\u89e3\uff1b\u53e6\u5916\u5982\u679c\u5b58\u5728 ",(0,r.jsx)(n.code,{children:"javax.xml.ws.WebServiceRef"})," \u548c ",(0,r.jsx)(n.code,{children:"javax.ejb.EJB"})," \u6ce8\u89e3\u4e5f\u662f\u4f1a\u8fdb\u884c\u8bbe\u7f6e\u7684\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"postprocessmergedbeandefinition-1",children:"postProcessMergedBeanDefinition"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"postProcessMergedBeanDefinition"})," \u65b9\u6cd5\u4f1a\u627e\u5230 ",(0,r.jsx)(n.code,{children:"@PostConstruct"})," \u548c ",(0,r.jsx)(n.code,{children:"@PreDestroy"})," \u6ce8\u89e3\u6807\u6ce8\u7684\u65b9\u6cd5\uff0c\u5e76\u6784\u5efa ",(0,r.jsx)(n.code,{children:"LifecycleMetadata"})," \u5bf9\u8c61\uff0c\u627e\u5230 ",(0,r.jsx)(n.code,{children:"@Resource"})," \u6ce8\u89e3\u6807\u6ce8\u7684\u5b57\u6bb5\uff08\u6216\u65b9\u6cd5\uff09\u7684\u5143\u4fe1\u606f\uff0c\u5982\u4e0b\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"// CommonAnnotationBeanPostProcessor.java\n@Override\npublic void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName) {\n    // \u5148\u8c03\u7528\u7236\u7c7b\u7684\u65b9\u6cd5\uff0c\u627e\u5230 @PostConstruct \u548c @PreDestroy \u6ce8\u89e3\u6807\u6ce8\u7684\u65b9\u6cd5\uff0c\u5e76\u6784\u5efa LifecycleMetadata \u5bf9\u8c61\n    super.postProcessMergedBeanDefinition(beanDefinition, beanType, beanName);\n    // \u627e\u5230 @Resource \u6ce8\u89e3\u6807\u6ce8\u7684\u5b57\u6bb5\uff08\u6216\u65b9\u6cd5\uff09\uff0c\u6784\u5efa\u4e00\u4e2a InjectionMetadata \u5bf9\u8c61\uff0c\u7528\u4e8e\u540e\u7eed\u7684\u5c5e\u6027\u6ce8\u5165\n    InjectionMetadata metadata = findResourceMetadata(beanName, beanType, null);\n    metadata.checkConfigMembers(beanDefinition);\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6574\u4e2a\u7684\u8fc7\u7a0b\u539f\u7406\u548c ",(0,r.jsx)(n.code,{children:"AutowiredAnnotationBeanPostProcessor"})," \u5dee\u4e0d\u591a\uff0c\u5148\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u672a\u547d\u4e2d\u5219\u8c03\u7528\u5bf9\u5e94\u7684\u65b9\u6cd5\u8fdb\u884c\u6784\u5efa\uff0c\u4e0b\u9762\u5148\u6765\u770b\u770b\u7236\u7c7b\u4e2d\u7684\u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"buildlifecyclemetadata",children:"buildLifecycleMetadata"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'// InitDestroyAnnotationBeanPostProcessor.java\nprivate LifecycleMetadata buildLifecycleMetadata(final Class<?> clazz) {\n    List<LifecycleElement> initMethods = new ArrayList<>();\n    List<LifecycleElement> destroyMethods = new ArrayList<>();\n    Class<?> targetClass = clazz;\n\n    do {\n        final List<LifecycleElement> currInitMethods = new ArrayList<>();\n        final List<LifecycleElement> currDestroyMethods = new ArrayList<>();\n\n        ReflectionUtils.doWithLocalMethods(targetClass, method -> {\n            if (this.initAnnotationType != null && method.isAnnotationPresent(this.initAnnotationType)) {\n                LifecycleElement element = new LifecycleElement(method);\n                currInitMethods.add(element);\n                if (logger.isTraceEnabled()) {\n                    logger.trace("Found init method on class [" + clazz.getName() + "]: " + method);\n                }\n            }\n            if (this.destroyAnnotationType != null && method.isAnnotationPresent(this.destroyAnnotationType)) {\n                currDestroyMethods.add(new LifecycleElement(method));\n                if (logger.isTraceEnabled()) {\n                    logger.trace("Found destroy method on class [" + clazz.getName() + "]: " + method);\n                }\n            }\n        });\n\n        initMethods.addAll(0, currInitMethods);\n        destroyMethods.addAll(currDestroyMethods);\n        targetClass = targetClass.getSuperclass();\n    }\n    while (targetClass != null && targetClass != Object.class);\n\n    return new LifecycleMetadata(clazz, initMethods, destroyMethods);\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u6574\u4e2a\u8fc7\u7a0b\u6bd4\u8f83\u7b80\u5355\uff0c\u627e\u5230\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u4e2d ",(0,r.jsx)(n.code,{children:"@PostConstruct"})," \u548c ",(0,r.jsx)(n.code,{children:"@PreDestroy"})," \u6ce8\u89e3\u6807\u6ce8\u7684\u65b9\u6cd5\uff0c\u7136\u540e\u6784\u5efa\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"LifecycleMetadata"})," \u751f\u547d\u5468\u671f\u5143\u4fe1\u606f\u5bf9\u8c61\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"buildresourcemetadata",children:"buildResourceMetadata"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'// CommonAnnotationBeanPostProcessor.java\nprivate InjectionMetadata buildResourceMetadata(final Class<?> clazz) {\n    List<InjectionMetadata.InjectedElement> elements = new ArrayList<>();\n    Class<?> targetClass = clazz;\n\n    do {\n        final List<InjectionMetadata.InjectedElement> currElements = new ArrayList<>();\n\n        ReflectionUtils.doWithLocalFields(targetClass, field -> {\n            if (webServiceRefClass != null && field.isAnnotationPresent(webServiceRefClass)) {\n                if (Modifier.isStatic(field.getModifiers())) {\n                    throw new IllegalStateException("@WebServiceRef annotation is not supported on static fields");\n                }\n                currElements.add(new WebServiceRefElement(field, field, null));\n            } else if (ejbRefClass != null && field.isAnnotationPresent(ejbRefClass)) {\n                if (Modifier.isStatic(field.getModifiers())) {\n                    throw new IllegalStateException("@EJB annotation is not supported on static fields");\n                }\n                currElements.add(new EjbRefElement(field, field, null));\n            } else if (field.isAnnotationPresent(Resource.class)) {\n                if (Modifier.isStatic(field.getModifiers())) {\n                    throw new IllegalStateException("@Resource annotation is not supported on static fields");\n                }\n                if (!this.ignoredResourceTypes.contains(field.getType().getName())) {\n                    currElements.add(new ResourceElement(field, field, null));\n                }\n            }\n        });\n\n        ReflectionUtils.doWithLocalMethods(targetClass, method -> {\n            Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);\n            if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) {\n                return;\n            }\n            if (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {\n                if (webServiceRefClass != null && bridgedMethod.isAnnotationPresent(webServiceRefClass)) {\n                    if (Modifier.isStatic(method.getModifiers())) {\n                        throw new IllegalStateException("@WebServiceRef annotation is not supported on static methods");\n                    }\n                    if (method.getParameterCount() != 1) {\n                        throw new IllegalStateException("@WebServiceRef annotation requires a single-arg method: " + method);\n                    }\n                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);\n                    currElements.add(new WebServiceRefElement(method, bridgedMethod, pd));\n                } else if (ejbRefClass != null && bridgedMethod.isAnnotationPresent(ejbRefClass)) {\n                    if (Modifier.isStatic(method.getModifiers())) {\n                        throw new IllegalStateException("@EJB annotation is not supported on static methods");\n                    }\n                    if (method.getParameterCount() != 1) {\n                        throw new IllegalStateException("@EJB annotation requires a single-arg method: " + method);\n                    }\n                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);\n                    currElements.add(new EjbRefElement(method, bridgedMethod, pd));\n                } else if (bridgedMethod.isAnnotationPresent(Resource.class)) {\n                    if (Modifier.isStatic(method.getModifiers())) {\n                        throw new IllegalStateException("@Resource annotation is not supported on static methods");\n                    }\n                    Class<?>[] paramTypes = method.getParameterTypes();\n                    if (paramTypes.length != 1) {\n                        throw new IllegalStateException("@Resource annotation requires a single-arg method: " + method);\n                    }\n                    if (!this.ignoredResourceTypes.contains(paramTypes[0].getName())) {\n                        PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);\n                        currElements.add(new ResourceElement(method, bridgedMethod, pd));\n                    }\n                }\n            }\n        });\n\n        elements.addAll(0, currElements);\n        targetClass = targetClass.getSuperclass();\n    }\n    while (targetClass != null && targetClass != Object.class);\n\n    return new InjectionMetadata(clazz, elements);\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u6574\u4e2a\u8fc7\u7a0b\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u89e3\u6790\u51fa\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u5e26\u6709 ",(0,r.jsx)(n.code,{children:"@Resource"})," \u6ce8\u89e3\u7684\u6240\u6709\u5b57\u6bb5\uff08\u6216\u65b9\u6cd5\uff09\uff0c\u6784\u5efa\u6210\u5bf9\u5e94\u7684 ",(0,r.jsx)(n.code,{children:"ResourceElement"})," \u5bf9\u8c61\uff0c\u7136\u540e\u518d\u6784\u5efa\u6210\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"InjectionMetadata"})," \u6ce8\u5165\u5143\u4fe1\u606f\u5bf9\u8c61\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"postprocessproperties-1",children:"postProcessProperties"}),"\n",(0,r.jsxs)(n.p,{children:["\u6839\u636e ",(0,r.jsx)(n.code,{children:"@Resource"})," \u6ce8\u89e3\u6807\u6ce8\u7684\u5b57\u6bb5\uff08\u6216\u65b9\u6cd5\uff09\u7684\u5143\u4fe1\u606f\u8fdb\u884c\u4f9d\u8d56\u6ce8\u5165\uff0c\u5982\u4e0b\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) {\n    InjectionMetadata metadata = findResourceMetadata(beanName, bean.getClass(), pvs);\n    try {\n        // \u8fdb\u884c\u6ce8\u5165\n        metadata.inject(bean, beanName, pvs);\n    } catch (Throwable ex) {\n        throw new BeanCreationException(beanName, "Injection of resource dependencies failed", ex);\n    }\n    return pvs;\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u5148\u627e\u5230\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u6ce8\u5165\u5143\u4fe1\u606f\u5bf9\u8c61\uff0c\u4e0a\u9762\u5df2\u7ecf\u8bb2\u8fc7\u4e86\uff0c\u7136\u540e\u8c03\u7528\u5176 ",(0,r.jsx)(n.code,{children:"inject(...)"})," \u65b9\u6cd5\uff0c\u8be5\u5bf9\u8c61\u4e0a\u9762\u5df2\u7ecf\u8bb2\u8fc7\u4e86\uff0c\u5b9e\u9645\u5c31\u662f\u8c03\u7528\u5176\u5185\u90e8 ",(0,r.jsx)(n.code,{children:"InjectedElement"})," \u7684 ",(0,r.jsx)(n.code,{children:"inject(...)"})," \u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"postprocessbeforeinitialization",children:"postProcessBeforeInitialization"}),"\n",(0,r.jsxs)(n.p,{children:["\u521d\u59cb\u5316 ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u65f6\u5019\u4f1a\u5148\u6267\u884c ",(0,r.jsx)(n.code,{children:"@PostConstruct"})," \u6807\u6ce8\u7684\u521d\u59cb\u5316\u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'// InitDestroyAnnotationBeanPostProcessor.java\n@Override\npublic Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {\n    // \u627e\u5230 @PostConstruct \u548c @PreDestroy \u6ce8\u89e3\u6807\u6ce8\u7684\u65b9\u6cd5\u4eec\u6240\u5bf9\u5e94\u7684 LifecycleMetadata \u5bf9\u8c61\n    LifecycleMetadata metadata = findLifecycleMetadata(bean.getClass());\n    try {\n        // \u6267\u884c @PostConstruct \u6807\u6ce8\u7684\u521d\u59cb\u5316\u65b9\u6cd5\n        metadata.invokeInitMethods(bean, beanName);\n    }\n    catch (InvocationTargetException ex) {\n        throw new BeanCreationException(beanName, "Invocation of init method failed", ex.getTargetException());\n    }\n    catch (Throwable ex) {\n        throw new BeanCreationException(beanName, "Failed to invoke init method", ex);\n    }\n    return bean;\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'// InitDestroyAnnotationBeanPostProcessor.LifecycleMetadata\npublic void invokeInitMethods(Object target, String beanName) throws Throwable {\n    Collection<LifecycleElement> checkedInitMethods = this.checkedInitMethods;\n    Collection<LifecycleElement> initMethodsToIterate =\n            (checkedInitMethods != null ? checkedInitMethods : this.initMethods);\n    if (!initMethodsToIterate.isEmpty()) {\n        for (LifecycleElement element : initMethodsToIterate) {\n            if (logger.isTraceEnabled()) {\n                logger.trace("Invoking init method on bean \'" + beanName + "\': " + element.getMethod());\n            }\n            element.invoke(target);\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"postprocessbeforedestruction",children:"postProcessBeforeDestruction"}),"\n",(0,r.jsxs)(n.p,{children:["\u9500\u6bc1 ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u65f6\u5019\u5148\u6267\u884c ",(0,r.jsx)(n.code,{children:"@PreDestroy"})," \u6ce8\u89e3\u6807\u6ce8\u7684\u9500\u6bc1\u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'// InitDestroyAnnotationBeanPostProcessor.java\n@Override\npublic void postProcessBeforeDestruction(Object bean, String beanName) throws BeansException {\n    // \u627e\u5230 @PostConstruct \u548c @PreDestroy \u6ce8\u89e3\u6807\u6ce8\u7684\u65b9\u6cd5\u4eec\u6240\u5bf9\u5e94\u7684 LifecycleMetadata \u5bf9\u8c61\n    LifecycleMetadata metadata = findLifecycleMetadata(bean.getClass());\n    try {\n        // \u6267\u884c @PreDestroy \u6807\u6ce8\u7684\u9500\u6bc1\u65b9\u6cd5\n        metadata.invokeDestroyMethods(bean, beanName);\n    }\n    catch (InvocationTargetException ex) {\n        String msg = "Destroy method on bean with name \'" + beanName + "\' threw an exception";\n        if (logger.isDebugEnabled()) {\n            logger.warn(msg, ex.getTargetException());\n        }\n        else {\n            logger.warn(msg + ": " + ex.getTargetException());\n        }\n    }\n    catch (Throwable ex) {\n        logger.warn("Failed to invoke destroy method on bean with name \'" + beanName + "\'", ex);\n    }\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'// InitDestroyAnnotationBeanPostProcessor.LifecycleMetadata\npublic void invokeDestroyMethods(Object target, String beanName) throws Throwable {\n    Collection<LifecycleElement> checkedDestroyMethods = this.checkedDestroyMethods;\n    Collection<LifecycleElement> destroyMethodsToUse =\n            (checkedDestroyMethods != null ? checkedDestroyMethods : this.destroyMethods);\n    if (!destroyMethodsToUse.isEmpty()) {\n        for (LifecycleElement element : destroyMethodsToUse) {\n            if (logger.isTraceEnabled()) {\n                logger.trace("Invoking destroy method on bean \'" + beanName + "\': " + element.getMethod());\n            }\n            element.invoke(target);\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"resourceelement",children:"ResourceElement"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"CommonAnnotationBeanPostProcessor"})," \u7684\u79c1\u6709\u5185\u90e8\u7c7b\uff0c",(0,r.jsx)(n.code,{children:"@Resource"})," \u6ce8\u5165\u5b57\u6bb5\uff08\u6216\u65b9\u6cd5\uff09\u5bf9\u8c61\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"\u6784\u9020\u65b9\u6cd5-1",children:"\u6784\u9020\u65b9\u6cd5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'protected abstract class LookupElement extends InjectionMetadata.InjectedElement {\n\n    /** Bean \u7684\u540d\u79f0 */\n    protected String name = "";\n\t/** \u662f\u5426\u4e3a\u9ed8\u8ba4\u7684\u540d\u79f0\uff08\u901a\u8fc7\u6ce8\u89e3\u5b9a\u4e49\u7684\uff09 */\n    protected boolean isDefaultName = false;\n\t/** Bean \u7684\u7c7b\u578b */\n    protected Class<?> lookupType = Object.class;\n\n    @Nullable\n    protected String mappedName;\n\n    public LookupElement(Member member, @Nullable PropertyDescriptor pd) {\n        super(member, pd);\n    }\n    \n    public final DependencyDescriptor getDependencyDescriptor() {\n        if (this.isField) {\n            return new LookupDependencyDescriptor((Field) this.member, this.lookupType);\n        }\n        else {\n            return new LookupDependencyDescriptor((Method) this.member, this.lookupType);\n        }\n    }\n}\n\nprivate class ResourceElement extends LookupElement {\n\t/** \u662f\u5426\u5ef6\u8fdf\u52a0\u8f7d */\n    private final boolean lazyLookup;\n\n    public ResourceElement(Member member, AnnotatedElement ae, @Nullable PropertyDescriptor pd) {\n        super(member, pd);\n        Resource resource = ae.getAnnotation(Resource.class);\n        String resourceName = resource.name();\n        Class<?> resourceType = resource.type();\n        this.isDefaultName = !StringUtils.hasLength(resourceName);\n        if (this.isDefaultName) {\n            resourceName = this.member.getName();\n            if (this.member instanceof Method && resourceName.startsWith("set") && resourceName.length() > 3) {\n                resourceName = Introspector.decapitalize(resourceName.substring(3));\n            }\n        }\n        else if (embeddedValueResolver != null) {\n            resourceName = embeddedValueResolver.resolveStringValue(resourceName);\n        }\n        if (Object.class != resourceType) {\n            checkResourceType(resourceType);\n        }\n        else {\n            // No resource type specified... check field/method.\n            resourceType = getResourceType();\n        }\n        this.name = (resourceName != null ? resourceName : "");\n        this.lookupType = resourceType;\n        String lookupValue = resource.lookup();\n        this.mappedName = (StringUtils.hasLength(lookupValue) ? lookupValue : resource.mappedName());\n        Lazy lazy = ae.getAnnotation(Lazy.class);\n        this.lazyLookup = (lazy != null && lazy.value());\n    }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ResourceElement"})," \u7684\u6784\u9020\u65b9\u6cd5\u4f1a\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"@Resource"})," \u6ce8\u89e3\u548c\u8be5\u5b57\u6bb5\uff08\u6216\u65b9\u6cd5\uff09\u89e3\u6790\u51fa\u57fa\u672c\u4fe1\u606f\uff0c\u53ef\u4ee5\u770b\u5230\u8fd8\u7ee7\u627f\u4e86 ",(0,r.jsx)(n.code,{children:"InjectionMetadata"})," \u7684\u9759\u6001\u5185\u90e8\u7c7b ",(0,r.jsx)(n.code,{children:"InjectedElement"})," \u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"getresourcetoinject",children:"getResourceToInject"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"@Override\nprotected Object getResourceToInject(Object target, @Nullable String requestingBeanName) {\n    return (this.lazyLookup ? buildLazyResourceProxy(this, requestingBeanName) :\n            getResource(this, requestingBeanName));\n}\n\nprotected Object buildLazyResourceProxy(final LookupElement element, final @Nullable String requestingBeanName) {\n    TargetSource ts = new TargetSource() {\n        @Override\n        public Class<?> getTargetClass() {\n            return element.lookupType;\n        }\n        @Override\n        public boolean isStatic() {\n            return false;\n        }\n        @Override\n        public Object getTarget() {\n            return getResource(element, requestingBeanName);\n        }\n        @Override\n        public void releaseTarget(Object target) {\n        }\n    };\n    ProxyFactory pf = new ProxyFactory();\n    pf.setTargetSource(ts);\n    if (element.lookupType.isInterface()) {\n        pf.addInterface(element.lookupType);\n    }\n    ClassLoader classLoader = (this.beanFactory instanceof ConfigurableBeanFactory ?\n            ((ConfigurableBeanFactory) this.beanFactory).getBeanClassLoader() : null);\n    return pf.getProxy(classLoader);\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u662f\u5ef6\u8fdf\u52a0\u8f7d\uff0c\u5219\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"buildLazyResourceProxy(...)"})," \u65b9\u6cd5\u8fd4\u56de\u4e00\u4e2a\u4ee3\u7406\u5bf9\u8c61\uff0c\u5426\u5219\uff0c\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"getResource(...)"})," \u65b9\u6cd5\u83b7\u53d6\u6ce8\u5165\u5bf9\u8c61\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"getresource-\u548c-autowireresource",children:"getResource \u548c autowireResource"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'protected Object getResource(LookupElement element, @Nullable String requestingBeanName)\n        throws NoSuchBeanDefinitionException {\n\n    if (StringUtils.hasLength(element.mappedName)) {\n        return this.jndiFactory.getBean(element.mappedName, element.lookupType);\n    }\n    if (this.alwaysUseJndiLookup) {\n        return this.jndiFactory.getBean(element.name, element.lookupType);\n    }\n    if (this.resourceFactory == null) {\n        throw new NoSuchBeanDefinitionException(element.lookupType,\n                "No resource factory configured - specify the \'resourceFactory\' property");\n    }\n    return autowireResource(this.resourceFactory, element, requestingBeanName);\n}\n\nprotected Object autowireResource(BeanFactory factory, LookupElement element, @Nullable String requestingBeanName)\n        throws NoSuchBeanDefinitionException {\n\n    Object resource;\n    Set<String> autowiredBeanNames;\n    String name = element.name;\n\n    if (factory instanceof AutowireCapableBeanFactory) {\n        AutowireCapableBeanFactory beanFactory = (AutowireCapableBeanFactory) factory;\n        DependencyDescriptor descriptor = element.getDependencyDescriptor();\n        if (this.fallbackToDefaultTypeMatch && element.isDefaultName && !factory.containsBean(name)) {\n            autowiredBeanNames = new LinkedHashSet<>();\n            resource = beanFactory.resolveDependency(descriptor, requestingBeanName, autowiredBeanNames, null);\n            if (resource == null) {\n                throw new NoSuchBeanDefinitionException(element.getLookupType(), "No resolvable resource object");\n            }\n        }\n        else {\n            resource = beanFactory.resolveBeanByName(name, descriptor);\n            autowiredBeanNames = Collections.singleton(name);\n        }\n    }\n    else {\n        resource = factory.getBean(name, element.lookupType);\n        autowiredBeanNames = Collections.singleton(name);\n    }\n\n    if (factory instanceof ConfigurableBeanFactory) {\n        ConfigurableBeanFactory beanFactory = (ConfigurableBeanFactory) factory;\n        for (String autowiredBeanName : autowiredBeanNames) {\n            if (requestingBeanName != null && beanFactory.containsBean(autowiredBeanName)) {\n                beanFactory.registerDependentBean(autowiredBeanName, requestingBeanName);\n            }\n        }\n    }\n\n    return resource;\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"@Resource"})," \u6ce8\u89e3\u76f8\u6bd4\u4e8e ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u6ce8\u89e3\u7684\u5904\u7406\u66f4\u52a0\u590d\u6742\u70b9\uff0c\u53ef\u4ee5\u5982\u679c ",(0,r.jsx)(n.code,{children:"@Resource"})," \u6307\u5b9a\u4e86\u540d\u79f0\uff0c\u5219\u76f4\u63a5\u901a\u8fc7\u4f9d\u8d56\u67e5\u627e\u83b7\u53d6\u8be5\u540d\u79f0\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u5426\u5219\uff0c\u548c ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u4e00\u6837\u53bb\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"DefaultListableBeanFactory#resolveDependency(...)"})," \u65b9\u6cd5\uff0c\u627e\u5230\u5bf9\u5e94\u7684\u6ce8\u5165\u5bf9\u8c61\uff0c\u8be5\u65b9\u6cd5\u5728\u540e\u9762\u8fdb\u884c\u5206\u6790\u3002"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h1,{id:"defaultlistablebeanfactoryresolvedependency",children:"DefaultListableBeanFactory#resolveDependency"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"DefaultListableBeanFactory#resolveDependency"})," \u65b9\u6cd5\u7684\u4f5c\u7528\u662f\u627e\u5230 ",(0,r.jsx)(n.code,{children:"Bean"})," \u5bf9\u5e94\u7684\u4f9d\u8d56\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"resolvedependency",children:"resolveDependency"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"// DefaultListableBeanFactory.java\n@Override\n@Nullable\npublic Object resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName,\n        @Nullable Set<String> autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException {\n\n    // <1> \u8bbe\u7f6e\u53c2\u6570\u540d\u79f0\u63a2\u6d4b\u5668\uff0c\u4f8b\u5982\u901a\u8fc7\u5b83\u83b7\u53d6\u65b9\u6cd5\u53c2\u6570\u7684\u540d\u79f0\n    descriptor.initParameterNameDiscovery(getParameterNameDiscoverer());\n    // <2> \u5982\u679c\u4f9d\u8d56\u7c7b\u578b\u4e3a Optional \u7c7b\u578b\n    if (Optional.class == descriptor.getDependencyType()) {\n        // \u8c03\u7528 `createOptionalDependency(...)` \u65b9\u6cd5\uff0c\u5148\u5c06 `descriptor` \u6ce8\u5165\u8868\u8ff0\u5668\u5c01\u88c5\u6210 NestedDependencyDescriptor \u5bf9\u8c61\n        // \u5e95\u5c42\u5904\u7406\u548c\u4e0b\u9762\u7684 `5.2` \u76f8\u540c\n        return createOptionalDependency(descriptor, requestingBeanName);\n    }\n    // <3> \u5426\u5219\uff0c\u5982\u679c\u4f9d\u8d56\u7c7b\u578b\u4e3a ObjectFactory \u6216 ObjectProvider \u7c7b\u578b\n    else if (ObjectFactory.class == descriptor.getDependencyType() || ObjectProvider.class == descriptor.getDependencyType()) {\n        // \u8fd4\u56de\u4e00\u4e2a DependencyObjectProvider \u79c1\u6709\u5185\u90e8\u7c7b\u5bf9\u8c61\uff0c\u5e76\u6ca1\u6709\u83b7\u53d6\u5230\u5b9e\u4f8b\u7684 Bean\uff0c\u9700\u8981\u8c03\u7528\u5176 getObject() \u65b9\u6cd5\u83b7\u53d6\u76ee\u6807\u5bf9\u8c61\n        return new DependencyObjectProvider(descriptor, requestingBeanName);\n    }\n    // <4> \u5426\u5219\uff0c\u5982\u679c\u4f9d\u8d56\u7c7b\u578b\u4e3a javax.inject.Provider \u7c7b\u578b\n    else if (javaxInjectProviderClass == descriptor.getDependencyType()) {\n        // \u8fd4\u56de\u4e00\u4e2a Jsr330Provider \u79c1\u6709\u5185\u90e8\u7c7b\u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u4e5f\u7ee7\u627f DependencyObjectProvider\n        return new Jsr330Factory().createDependencyProvider(descriptor, requestingBeanName);\n    }\n    // <5> \u5426\u5219\uff0c\u901a\u7528\u7684\u5904\u7406\u903b\u8f91\n    else {\n        // <5.1> \u5148\u901a\u8fc7 AutowireCandidateResolver \u5c1d\u8bd5\u83b7\u53d6\u4e00\u4e2a\u4ee3\u7406\u5bf9\u8c61\uff0c\u5ef6\u8fdf\u4f9d\u8d56\u6ce8\u5165\u5219\u4f1a\u8fd4\u56de\u4e00\u4e2a\u4ee3\u7406\u5bf9\u8c61\n        Object result = getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(descriptor, requestingBeanName);\n        // <5.2> \u5982\u679c\u4e0a\u9762\u6ca1\u6709\u8fd4\u56de\u4ee3\u7406\u5bf9\u8c61\uff0c\u5219\u8fdb\u884c\u5904\u7406\uff0c\u8c03\u7528 `doResolveDependency(...)` \u65b9\u6cd5\n        if (result == null) {\n            result = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);\n        }\n        return result;\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8fc7\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u8bbe\u7f6e\u53c2\u6570\u540d\u79f0\u63a2\u6d4b\u5668\uff0c\u4f8b\u5982\u901a\u8fc7\u5b83\u83b7\u53d6\u65b9\u6cd5\u53c2\u6570\u7684\u540d\u79f0"}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u4f9d\u8d56\u7c7b\u578b\u4e3a ",(0,r.jsx)(n.code,{children:"Optional"})," \u7c7b\u578b\uff0c\u5219\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"createOptionalDependency(...)"})," \u65b9\u6cd5\uff0c\u5148\u5c06 ",(0,r.jsx)(n.code,{children:"descriptor"})," \u6ce8\u5165\u8868\u8ff0\u5668\u5c01\u88c5\u6210 ",(0,r.jsx)(n.code,{children:"NestedDependencyDescriptor"})," \u5bf9\u8c61\uff0c\u5e95\u5c42\u5904\u7406\u548c\u4e0b\u9762\u7684 ",(0,r.jsx)(n.code,{children:"5.2"})," \u76f8\u540c"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5426\u5219\uff0c\u5982\u679c\u4f9d\u8d56\u7c7b\u578b\u4e3a ",(0,r.jsx)(n.code,{children:"ObjectFactory"})," \u6216 ",(0,r.jsx)(n.code,{children:"ObjectProvider"})," \u7c7b\u578b\uff0c\u76f4\u63a5\u8fd4\u56de\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"DependencyObjectProvider"})," \u79c1\u6709\u5185\u90e8\u7c7b\u5bf9\u8c61\uff0c\u5e76\u6ca1\u6709\u83b7\u53d6\u5230\u5b9e\u4f8b\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u9700\u8981\u8c03\u7528\u5176 ",(0,r.jsx)(n.code,{children:"getObject()"})," \u65b9\u6cd5\u83b7\u53d6\u76ee\u6807\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5426\u5219\uff0c\u5982\u679c\u4f9d\u8d56\u7c7b\u578b\u4e3a ",(0,r.jsx)(n.code,{children:"javax.inject.Provider"})," \u7c7b\u578b\uff0c\u76f4\u63a5\u8fd4\u56de\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"Jsr330Provider"})," \u79c1\u6709\u5185\u90e8\u7c7b\u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u4e5f\u7ee7\u627f ",(0,r.jsx)(n.code,{children:"DependencyObjectProvider"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u5426\u5219\uff0c\u901a\u7528\u7684\u5904\u7406\u903b\u8f91","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5148\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"AutowireCandidateResolver"})," \u5c1d\u8bd5\u83b7\u53d6\u4e00\u4e2a\u4ee3\u7406\u5bf9\u8c61\uff0c\u5ef6\u8fdf\u4f9d\u8d56\u6ce8\u5165\u5219\u4f1a\u8fd4\u56de\u4e00\u4e2a\u4ee3\u7406\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u4e0a\u9762\u6ca1\u6709\u8fd4\u56de\u4ee3\u7406\u5bf9\u8c61\uff0c\u5219\u8fdb\u884c\u5904\u7406\uff0c\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"doResolveDependency(...)"})," \u65b9\u6cd5"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u6211\u4eec\u9700\u8981\u5173\u6ce8\u7684\u662f\u4e0a\u9762\u7684\u7b2c ",(0,r.jsx)(n.code,{children:"5.2"})," \u6b65\u6240\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"doResolveDependency(...)"})," \u65b9\u6cd5\uff0c\u8fd9\u4e00\u6b65\u662f\u5e95\u5c42\u5b9e\u73b0\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"doresolvedependency",children:"doResolveDependency"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"// DefaultListableBeanFactory.java\n@Nullable\npublic Object doResolveDependency(DependencyDescriptor descriptor, @Nullable String beanName,\n        @Nullable Set<String> autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException {\n\n    // \u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u7684\u6ce8\u5165\u70b9\uff0c\u5e76\u8fd4\u56de\u4e0a\u6b21\u7684\u6ce8\u5165\u70b9\uff0c\u5c5e\u4e8e\u5d4c\u5957\u6ce8\u5165\u7684\u4e00\u4e2a\u4fdd\u62a4\u70b9\n    InjectionPoint previousInjectionPoint = ConstructorResolver.setCurrentInjectionPoint(descriptor);\n    try {\n        // <1> \u9488\u5bf9\u7ed9\u5b9a\u7684\u5de5\u5382\u7ed9\u5b9a\u4e00\u4e2a\u5feb\u6377\u5b9e\u73b0\u7684\u65b9\u5f0f\uff0c\u6682\u65f6\u5ffd\u7565\n        // \u4f8b\u5982\u8003\u8651\u4e00\u4e9b\u9884\u5148\u89e3\u6790\u7684\u4fe1\u606f\uff0c\u5728\u8fdb\u5165\u6240\u6709 Bean \u7684\u5e38\u89c4\u7c7b\u578b\u5339\u914d\u7b97\u6cd5\u4e4b\u524d\uff0c\u89e3\u6790\u7b97\u6cd5\u5c06\u9996\u5148\u5c1d\u8bd5\u901a\u8fc7\u6b64\u65b9\u6cd5\u89e3\u6790\u5feb\u6377\u65b9\u5f0f\n        Object shortcut = descriptor.resolveShortcut(this);\n        if (shortcut != null) {\n            // \u8fd4\u56de\u5feb\u6377\u7684\u89e3\u6790\u4fe1\u606f\n            return shortcut;\n        }\n\n        // \u4f9d\u8d56\u7684\u7c7b\u578b\n        Class<?> type = descriptor.getDependencyType();\n        // <2> \u83b7\u53d6\u6ce8\u89e3\u4e2d\u7684 value \u5bf9\u5e94\u7684\u503c\uff0c\u4f8b\u5982 @Value\u3001@Qualifier \u6ce8\u89e3\u914d\u7f6e\u7684 value \u5c5e\u6027\u503c\uff0c\u6ce8\u610f @Autowired \u6ca1\u6709 value \u5c5e\u6027\u914d\u7f6e\n        Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor);\n        if (value != null) {\n            if (value instanceof String) {\n                // <2.1> \u89e3\u6790\u6ce8\u89e3\u4e2d\u7684 value\uff0c\u56e0\u4e3a\u53ef\u80fd\u662f\u5360\u4f4d\u7b26\uff0c\u9700\u8981\u83b7\u53d6\u5230\u76f8\u5e94\u7684\u6570\u636e\n                String strVal = resolveEmbeddedValue((String) value);\n                BeanDefinition bd = (beanName != null && containsBean(beanName) ?\n                        getMergedBeanDefinition(beanName) : null);\n                value = evaluateBeanDefinitionString(strVal, bd);\n            }\n            TypeConverter converter = (typeConverter != null ? typeConverter : getTypeConverter());\n            try {\n                // <2.2> \u8fdb\u884c\u7c7b\u578b\u8f6c\u6362\uff0c\u5e76\u8fd4\u56de\n                return converter.convertIfNecessary(value, type, descriptor.getTypeDescriptor());\n            }\n            catch (UnsupportedOperationException ex) {\n                // A custom TypeConverter which does not support TypeDescriptor resolution...\n                return (descriptor.getField() != null ?\n                        converter.convertIfNecessary(value, type, descriptor.getField()) :\n                        converter.convertIfNecessary(value, type, descriptor.getMethodParameter()));\n            }\n        }\n\n        // <3> \u89e3\u6790\u590d\u5408\u7684\u4f9d\u8d56\u5bf9\u8c61\uff08Array\u3001Collection\u3001Map \u7c7b\u578b\uff09\uff0c\u83b7\u53d6\u8be5\u5c5e\u6027\u5143\u7d20\u7c7b\u578b\u7684 Bean \u4eec\n        // \u5e95\u5c42\u548c\u7b2c `4` \u539f\u7406\u4e00\u6837\uff0c\u8fd9\u91cc\u4f1a\u5c06 `descriptor` \u5c01\u88c5\u6210 MultiElementDescriptor \u7c7b\u578b\n        Object multipleBeans = resolveMultipleBeans(descriptor, beanName, autowiredBeanNames, typeConverter);\n        if (multipleBeans != null) {\n            return multipleBeans;\n        }\n\n        // <4> \u67e5\u627e\u4e0e\u7c7b\u578b\u76f8\u5339\u914d\u7684 Bean \u4eec\n        // \u8fd4\u56de\u7ed3\u679c\uff1akey -> beanName\uff1bvalue -> \u5bf9\u5e94\u7684 Bean\n        Map<String, Object> matchingBeans = findAutowireCandidates(beanName, type, descriptor);\n        // <5> \u5982\u679c\u4e00\u4e2a\u90fd\u6ca1\u627e\u5230\n        if (matchingBeans.isEmpty()) {\n            // <5.1> \u5982\u679c @Autowired \u914d\u7f6e\u7684 required \u4e3a true\uff0c\u8868\u793a\u5fc5\u987b\uff0c\u5219\u629b\u51fa\u5f02\u5e38\n            if (isRequired(descriptor)) {\n                raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);\n            }\n            // <5.2> \u5426\u5219\uff0c\u8fd4\u56de\u4e00\u4e2a\u7a7a\u5bf9\u8c61\n            return null;\n        }\n\n        String autowiredBeanName;\n        Object instanceCandidate;\n\n        // <6> \u5982\u679c\u5339\u914d\u7684 Bean \u6709\u591a\u4e2a\uff0c\u5219\u9700\u8981\u627e\u51fa\u6700\u4f18\u5148\u7684\u90a3\u4e2a\n        if (matchingBeans.size() > 1) {\n            // <6.1> \u627e\u5230\u6700\u5339\u914d\u7684\u90a3\u4e2a Bean\uff0c\u901a\u8fc7 @Primary \u6216\u8005 @Priority \u6765\u51b3\u5b9a\uff0c\u6216\u8005\u901a\u8fc7\u540d\u79f0\u51b3\u5b9a\n            autowiredBeanName = determineAutowireCandidate(matchingBeans, descriptor);\n            if (autowiredBeanName == null) {\n                if (isRequired(descriptor) || !indicatesMultipleBeans(type)) {\n                    // <6.2> \u5982\u679c\u6ca1\u6709\u627e\u5230\u6700\u5339\u914d\u7684 Bean\uff0c\u5219\u629b\u51fa NoUniqueBeanDefinitionException \u5f02\u5e38\n                    return descriptor.resolveNotUnique(descriptor.getResolvableType(), matchingBeans);\n                }\n                else {\n                    // In case of an optional Collection/Map, silently ignore a non-unique case:\n                    // possibly it was meant to be an empty collection of multiple regular beans\n                    // (before 4.3 in particular when we didn't even look for collection beans).\n                    return null;\n                }\n            }\n            // <6.3> \u83b7\u53d6\u5230\u6700\u5339\u914d\u7684 Bean\uff0c\u4f20\u503c\u5f15\u7528\u7ed9 `instanceCandidate`\n            instanceCandidate = matchingBeans.get(autowiredBeanName);\n        }\n        // <7> \u5426\u5219\uff0c\u53ea\u6709\u4e00\u4e2a Bean\uff0c\u5219\u76f4\u63a5\u4f7f\u7528\u5176\u4f5c\u4e3a\u6700\u5339\u914d\u7684 Bean\n        else {\n            // We have exactly one match.\n            Map.Entry<String, Object> entry = matchingBeans.entrySet().iterator().next();\n            autowiredBeanName = entry.getKey();\n            instanceCandidate = entry.getValue();\n        }\n\n        // <8> \u5c06\u4f9d\u8d56\u6ce8\u5165\u7684 Bean \u7684\u540d\u79f0\u6dfb\u52a0\u81f3\u65b9\u6cd5\u5165\u53c2 `autowiredBeanNames` \u96c6\u5408\uff0c\u91cc\u9762\u4fdd\u5b58\u4f9d\u8d56\u6ce8\u5165\u7684 beanName\n        if (autowiredBeanNames != null) {\n            autowiredBeanNames.add(autowiredBeanName);\n        }\n        // <9> \u5982\u679c\u5339\u914d\u7684 Bean \u662f Class \u5bf9\u8c61\uff0c\u5219\u6839\u636e\u5176 beanName \u4f9d\u8d56\u67e5\u627e\u5230\u5bf9\u5e94\u7684 Bean\n        if (instanceCandidate instanceof Class) {\n            instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);\n        }\n        Object result = instanceCandidate;\n        if (result instanceof NullBean) {\n            if (isRequired(descriptor)) {\n                raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);\n            }\n            result = null;\n        }\n        if (!ClassUtils.isAssignableValue(type, result)) {\n            throw new BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());\n        }\n        // <10> \u8fd4\u56de\u4f9d\u8d56\u6ce8\u5165\u7684 Bean\n        return result;\n    }\n    finally {\n        // \u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u7684\u6ce8\u5165\u70b9\u4e3a\u4e0a\u4e00\u6b21\u7684\u6ce8\u5165\u70b9\uff0c\u56e0\u4e3a\u672c\u6b21\u6ce8\u5165\u7ed3\u675f\u4e86\n        ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"doresolvedependency-1",children:"doResolveDependency"}),"\n",(0,r.jsx)(n.p,{children:"\u4f9d\u8d56\u5904\u7406\u7684\u8fc7\u7a0b\u7a0d\u5fae\u6709\u70b9\u590d\u6742\uff0c\u5982\u4e0b\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u9488\u5bf9\u7ed9\u5b9a\u7684\u5de5\u5382\u7ed9\u5b9a\u4e00\u4e2a\u5feb\u6377\u5b9e\u73b0\u7684\u65b9\u5f0f\uff0c\u6682\u65f6\u5ffd\u7565\u3002\n\u4f8b\u5982\u8003\u8651\u4e00\u4e9b\u9884\u5148\u89e3\u6790\u7684\u4fe1\u606f\uff0c\u5728\u8fdb\u5165\u6240\u6709 ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u5e38\u89c4\u7c7b\u578b\u5339\u914d\u7b97\u6cd5\u4e4b\u524d\uff0c\u89e3\u6790\u7b97\u6cd5\u5c06\u9996\u5148\u5c1d\u8bd5\u901a\u8fc7\u6b64\u65b9\u6cd5\u89e3\u6790\u5feb\u6377\u65b9\u5f0f"]}),"\n",(0,r.jsxs)(n.li,{children:["\u83b7\u53d6\u6ce8\u89e3\u4e2d\u7684 ",(0,r.jsx)(n.code,{children:"value"})," \u5bf9\u5e94\u7684\u503c\uff0c\u4f8b\u5982 ",(0,r.jsx)(n.code,{children:"@Value"}),"\u3001",(0,r.jsx)(n.code,{children:"@Qualifier"})," \u6ce8\u89e3\u914d\u7f6e\u7684 ",(0,r.jsx)(n.code,{children:"value"})," \u5c5e\u6027\u503c\uff0c\u6ce8\u610f ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u6ca1\u6709 ",(0,r.jsx)(n.code,{children:"value"})," \u5c5e\u6027\u914d\u7f6e","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u89e3\u6790\u6ce8\u89e3\u4e2d\u7684 ",(0,r.jsx)(n.code,{children:"value"}),"\uff0c\u56e0\u4e3a\u53ef\u80fd\u662f\u5360\u4f4d\u7b26\uff0c\u9700\u8981\u83b7\u53d6\u5230\u76f8\u5e94\u7684\u6570\u636e"]}),"\n",(0,r.jsx)(n.li,{children:"\u8fdb\u884c\u7c7b\u578b\u8f6c\u6362\uff0c\u5e76\u8fd4\u56de"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u89e3\u6790\u590d\u5408\u7684\u4f9d\u8d56\u5bf9\u8c61\uff08",(0,r.jsx)(n.code,{children:"Array"}),"\u3001",(0,r.jsx)(n.code,{children:"Collection"}),"\u3001",(0,r.jsx)(n.code,{children:"Map"})," \u7c7b\u578b\uff09\uff0c\u83b7\u53d6\u8be5\u5c5e\u6027\u5143\u7d20\u7c7b\u578b\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u4eec\uff0c\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"resolveMultipleBeans(...)"})," \u65b9\u6cd5\n\u5e95\u5c42\u548c\u4e0b\u9762\u7b2c ",(0,r.jsx)(n.code,{children:"4"})," \u6b65\u539f\u7406\u4e00\u6837\uff0c\u8fd9\u91cc\u4f1a\u5c06 ",(0,r.jsx)(n.code,{children:"descriptor"})," \u5c01\u88c5\u6210 ",(0,r.jsx)(n.code,{children:"MultiElementDescriptor"})," \u7c7b\u578b\uff0c\u5982\u679c\u627e\u5230\u4e86\u5219\u76f4\u63a5\u8fd4\u56de"]}),"\n",(0,r.jsxs)(n.li,{children:["\u67e5\u627e\u4e0e\u7c7b\u578b\u76f8\u5339\u914d\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u4eec\uff0c\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"findAutowireCandidates(...)"})," \u65b9\u6cd5\n\u8fd4\u56de\u7ed3\u679c\uff1a",(0,r.jsx)(n.code,{children:"key"})," -> ",(0,r.jsx)(n.code,{children:"beanName"}),"\uff1b",(0,r.jsx)(n.code,{children:"value"})," -> \u5bf9\u5e94\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u4e00\u4e2a\u90fd\u6ca1\u627e\u5230","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c ",(0,r.jsx)(n.code,{children:"@Autowired"})," \u914d\u7f6e\u7684 ",(0,r.jsx)(n.code,{children:"required"})," \u4e3a ",(0,r.jsx)(n.code,{children:"true"}),"\uff0c\u8868\u793a\u5fc5\u987b\uff0c\u5219\u629b\u51fa\u5f02\u5e38"]}),"\n",(0,r.jsx)(n.li,{children:"\u5426\u5219\uff0c\u8fd4\u56de\u4e00\u4e2a\u7a7a\u5bf9\u8c61"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u5339\u914d\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u6709\u591a\u4e2a\uff0c\u5219\u9700\u8981\u627e\u51fa\u6700\u4f18\u5148\u7684\u90a3\u4e2a","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u627e\u5230\u6700\u5339\u914d\u7684\u90a3\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"@Primary"})," \u6216\u8005 ",(0,r.jsx)(n.code,{children:"@Priority"})," \u6765\u51b3\u5b9a\uff0c\u6216\u8005\u901a\u8fc7\u540d\u79f0\u51b3\u5b9a\uff0c\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"determineAutowireCandidate(...)"})," \u65b9\u6cd5"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u6ca1\u6709\u627e\u5230\u6700\u5339\u914d\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u5219\u629b\u51fa ",(0,r.jsx)(n.code,{children:"NoUniqueBeanDefinitionException"})," \u5f02\u5e38"]}),"\n",(0,r.jsxs)(n.li,{children:["\u83b7\u53d6\u5230\u6700\u5339\u914d\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u4f20\u503c\u5f15\u7528\u7ed9 ",(0,r.jsx)(n.code,{children:"instanceCandidate"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5426\u5219\uff0c\u53ea\u6709\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u5219\u76f4\u63a5\u4f7f\u7528\u5176\u4f5c\u4e3a\u6700\u5339\u914d\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u5c06\u4f9d\u8d56\u6ce8\u5165\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u540d\u79f0\u6dfb\u52a0\u81f3\u65b9\u6cd5\u5165\u53c2 ",(0,r.jsx)(n.code,{children:"autowiredBeanNames"})," \u96c6\u5408\uff0c\u91cc\u9762\u4fdd\u5b58\u4f9d\u8d56\u6ce8\u5165\u7684 ",(0,r.jsx)(n.code,{children:"beanName"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u5339\u914d\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u662f Class \u5bf9\u8c61\uff0c\u5219\u6839\u636e\u5176 ",(0,r.jsx)(n.code,{children:"beanName"})," \u4f9d\u8d56\u67e5\u627e\u5230\u5bf9\u5e94\u7684 Bean"]}),"\n",(0,r.jsxs)(n.li,{children:["\u8fd4\u56de\u4f9d\u8d56\u6ce8\u5165\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5173\u4e8e\u4e0a\u9762\u7b2c ",(0,r.jsx)(n.code,{children:"3"})," \u6b65\u5bf9\u4e8e\u7b26\u5408\u4f9d\u8d56\u5bf9\u8c61\u7684\u5904\u7406\u8fd9\u91cc\u4e0d\u505a\u8be6\u7ec6\u5206\u6790\uff0c\u56e0\u4e3a\u5e95\u5c42\u548c\u7b2c ",(0,r.jsx)(n.code,{children:"4"})," \u6b65\u4e00\u6837\uff0c\u63a5\u4e0b\u6765\u5206\u6790\u4e0a\u9762\u7b2c ",(0,r.jsx)(n.code,{children:"4"})," \u3001",(0,r.jsx)(n.code,{children:"6"})," \u6b65\u6240\u8c03\u7528\u7684\u65b9\u6cd5"]}),"\n",(0,r.jsx)(n.h3,{id:"findautowirecandidates",children:"findAutowireCandidates"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"// DefaultListableBeanFactory.java\nprotected Map<String, Object> findAutowireCandidates(\n        @Nullable String beanName, Class<?> requiredType, DependencyDescriptor descriptor) {\n\n    // <1> \u4ece\u5f53\u524d\u4e0a\u4e0b\u6587\u627e\u5230\u8be5\u7c7b\u578b\u7684 Bean \u4eec\uff08\u6839\u636e\u7c7b\u578b\uff09\n    String[] candidateNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(\n            this, requiredType, true, descriptor.isEager());\n    // <2> \u5b9a\u4e49\u4e00\u4e2a Map \u5bf9\u8c61 `result`\uff0c\u7528\u4e8e\u4fdd\u5b58\u7b26\u5408\u6761\u4ef6\u7684 Bean\n    Map<String, Object> result = new LinkedHashMap<>(candidateNames.length);\n    /**\n     * <3> \u904d\u5386 Spring \u5185\u90e8\u5df2\u5904\u7406\u7684\u4f9d\u8d56\u5bf9\u8c61\u96c6\u5408\uff0c\u53ef\u4ee5\u8df3\u5230 AbstractApplicationContext#prepareBeanFactory \u65b9\u6cd5\u4e2d\u770b\u770b\n     * \u4f1a\u6709\u4e00\u4e0b\u51e0\u4e2a\u5185\u7f6e\u5904\u7406\u5bf9\u8c61\uff1a\n     * BeanFactory \u7c7b\u578b -> \u8fd4\u56de DefaultListableBeanFactory\n     * ResourceLoader\u3001ApplicationEventPublisher\u3001ApplicationContext \u7c7b\u578b ->  \u8fd4\u56de ApplicationContext \u5bf9\u8c61\n     */\n    for (Map.Entry<Class<?>, Object> classObjectEntry : this.resolvableDependencies.entrySet()) {\n        Class<?> autowiringType = classObjectEntry.getKey();\n        if (autowiringType.isAssignableFrom(requiredType)) {\n            Object autowiringValue = classObjectEntry.getValue();\n            autowiringValue = AutowireUtils.resolveAutowiringValue(autowiringValue, requiredType);\n            if (requiredType.isInstance(autowiringValue)) {\n                result.put(ObjectUtils.identityToString(autowiringValue), autowiringValue);\n                break;\n            }\n        }\n    }\n\n    // <4> \u904d\u5386\u7b2c `1` \u6b65\u627e\u5230\u7684 Bean \u7684\u540d\u79f0\u4eec\n    for (String candidate : candidateNames) {\n        // <4.1> \u5982\u679c\u6ee1\u8db3\u4e0b\u9762\u4e24\u4e2a\u6761\u4ef6\uff0c\u5219\u6dfb\u52a0\u81f3 `result` \u96c6\u5408\u4e2d\n        if (!isSelfReference(beanName, candidate) // \u5982\u679c\u4e0d\u662f\u81ea\u5f15\u7528\uff08\u8fd9\u4e2a Bean \u4e0d\u662f\u5728\u9700\u8981\u4f9d\u8d56\u5b83\u7684 Bean \u7684\u5185\u90e8\u5b9a\u4e49\u7684\uff09\n                && isAutowireCandidate(candidate, descriptor)) { // \u7b26\u5408\u6ce8\u5165\u7684\u6761\u4ef6\n            addCandidateEntry(result, candidate, descriptor, requiredType);\n        }\n    }\n    // <5> \u5982\u679c\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684 Bean\uff0c\u5219\u518d\u5c1d\u8bd5\u83b7\u53d6\n    if (result.isEmpty()) {\n        boolean multiple = indicatesMultipleBeans(requiredType);\n        // Consider fallback matches if the first pass failed to find anything...\n        DependencyDescriptor fallbackDescriptor = descriptor.forFallbackMatch();\n        // <5.1> \u518d\u6b21\u904d\u5386\u7b2c `1` \u6b65\u627e\u5230\u7684 Bean \u7684\u540d\u79f0\u4eec\n        for (String candidate : candidateNames) {\n            // <5.2> \u5982\u679c\u6ee1\u8db3\u4e0b\u9762\u4e09\u4e2a\u6761\u4ef6\uff0c\u5219\u6dfb\u52a0\u81f3 `result` \u96c6\u5408\u4e2d\n            if (!isSelfReference(beanName, candidate) // \u5982\u679c\u4e0d\u662f\u81ea\u5f15\u7528\uff08\u8fd9\u4e2a Bean \u4e0d\u662f\u5728\u9700\u8981\u4f9d\u8d56\u5b83\u7684 Bean \u7684\u5185\u90e8\u5b9a\u4e49\u7684\uff09\n                    && isAutowireCandidate(candidate, fallbackDescriptor) // \u7b26\u5408\u6ce8\u5165\u7684\u6761\u4ef6\n                    && (!multiple || getAutowireCandidateResolver().hasQualifier(descriptor))) { // \u4e0d\u662f\u590d\u5408\u7c7b\u578b\uff0c\u6216\u8005\u6709 @Qualifier \u6ce8\u89e3\n                addCandidateEntry(result, candidate, descriptor, requiredType);\n            }\n        }\n        // <6> \u5982\u679c\u8fd8\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684 Bean\uff0c\u5219\u518d\u5c1d\u8bd5\u83b7\u53d6\n        // \u548c\u4e0a\u9762\u7b2c `5` \u6b65\u7684\u533a\u522b\u5728\u4e8e\u5fc5\u987b\u662f\u81ea\u5f15\u7528\uff08\u8fd9\u4e2a Bean \u4e0d\u662f\u5728\u9700\u8981\u4f9d\u8d56\u5b83\u7684 Bean \u7684\u5185\u90e8\u5b9a\u4e49\u7684\uff09\n        if (result.isEmpty() && !multiple) {\n            // Consider self references as a final pass...\n            // but in the case of a dependency collection, not the very same bean itself.\n            for (String candidate : candidateNames) {\n                if (isSelfReference(beanName, candidate)\n                        && (!(descriptor instanceof MultiElementDescriptor) || !beanName.equals(candidate))\n                        && isAutowireCandidate(candidate, fallbackDescriptor)) {\n                    addCandidateEntry(result, candidate, descriptor, requiredType);\n                }\n            }\n        }\n    }\n    // <7> \u8fd4\u56de `result`\uff0c\u7b26\u5408\u6761\u4ef6\u7684 Bean\n    return result;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8fc7\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u4ece\u5f53\u524d\u4e0a\u4e0b\u6587\u627e\u5230\u8be5\u7c7b\u578b\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u4eec\uff08\u6839\u636e\u7c7b\u578b\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5b9a\u4e49\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"Map"})," \u5bf9\u8c61 ",(0,r.jsx)(n.code,{children:"result"})," \uff0c\u7528\u4e8e\u4fdd\u5b58\u7b26\u5408\u6761\u4ef6\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u904d\u5386 ",(0,r.jsx)(n.code,{children:"Spring"})," \u5185\u90e8\u5df2\u5904\u7406\u7684\u4f9d\u8d56\u5bf9\u8c61\u96c6\u5408\uff0c\u4f8b\u5982\u4f60\u4f9d\u8d56\u6ce8\u5165 ",(0,r.jsx)(n.code,{children:"BeanFactory"})," \u7c7b\u578b\u7684\u5bf9\u8c61\uff0c\u5219\u62ff\u5230\u7684\u662f ",(0,r.jsx)(n.code,{children:"DefaultListableBeanFactory"})," \u5bf9\u8c61\uff0c\u4f9d\u8d56\u6ce8\u5165 ",(0,r.jsx)(n.code,{children:"ResourceLoader"}),"\u3001",(0,r.jsx)(n.code,{children:"ApplicationEventPublisher"}),"\u3001",(0,r.jsx)(n.code,{children:"ApplicationContext"})," \u7c7b\u578b\u7684\u5bf9\u8c61\uff0c \u62ff\u5230\u7684\u5c31\u662f\u5f53\u524d ",(0,r.jsx)(n.code,{children:"Spring"})," \u4e0a\u4e0b\u6587 ",(0,r.jsx)(n.code,{children:"ApplicationContext"})," \u5bf9\u8c61"]}),"\n",(0,r.jsxs)(n.li,{children:["\u904d\u5386\u7b2c ",(0,r.jsx)(n.code,{children:"1"})," \u6b65\u627e\u5230\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u540d\u79f0\u4eec","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u6ee1\u8db3\u4e0b\u9762\u4e24\u4e2a\u6761\u4ef6\uff0c\u5219\u6dfb\u52a0\u81f3 ",(0,r.jsx)(n.code,{children:"result"})," \u96c6\u5408\u4e2d\u3002\u5982\u679c\u4e0d\u662f\u81ea\u5f15\u7528\uff08\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u4e0d\u662f\u5728\u9700\u8981\u4f9d\u8d56\u5b83\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u5185\u90e8\u5b9a\u4e49\u7684\uff09\u3001\u7b26\u5408\u6ce8\u5165\u7684\u6761\u4ef6"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \uff0c\u5219\u518d\u5c1d\u8bd5\u83b7\u53d6","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u518d\u6b21\u904d\u5386\u7b2c ",(0,r.jsx)(n.code,{children:"1"})," \u6b65\u627e\u5230\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u540d\u79f0\u4eec"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u6ee1\u8db3\u4e0b\u9762\u4e09\u4e2a\u6761\u4ef6\uff0c\u5219\u6dfb\u52a0\u81f3 ",(0,r.jsx)(n.code,{children:"result"})," \u96c6\u5408\u4e2d\n\u5982\u679c\u4e0d\u662f\u81ea\u5f15\u7528\uff08\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u4e0d\u662f\u5728\u9700\u8981\u4f9d\u8d56\u5b83\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u5185\u90e8\u5b9a\u4e49\u7684\uff09\u3001\u7b26\u5408\u6ce8\u5165\u7684\u6761\u4ef6\u3001\u4e0d\u662f\u590d\u5408\u7c7b\u578b\uff0c\u6216\u8005\u6709 ",(0,r.jsx)(n.code,{children:"@Qualifier"})," \u6ce8\u89e3"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u8fd8\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u5219\u518d\u5c1d\u8bd5\u83b7\u53d6\uff0c\u548c\u4e0a\u9762\u7b2c ",(0,r.jsx)(n.code,{children:"5"})," \u6b65\u7684\u533a\u522b\u5728\u4e8e\u5fc5\u987b\u662f\u81ea\u5f15\u7528\uff08\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u662f\u5728\u9700\u8981\u4f9d\u8d56\u5b83\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u5185\u90e8\u5b9a\u4e49\u7684\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:["\u8fd4\u56de ",(0,r.jsx)(n.code,{children:"result"})," \uff0c\u7b26\u5408\u6761\u4ef6\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u603b\u7ed3\u4e0b\u6765\uff1a\u4ece\u5f53\u524d\u4e0a\u4e0b\u6587\u627e\u5230\u6240\u6709\u8be5\u7c7b\u578b\u7684\u4f9d\u8d56\u6ce8\u5165\u5bf9\u8c61\u7136\u540e\u8fd4\u56de\uff0c\u6ce8\u610f\uff0c\u5982\u679c\u4f60\u4f9d\u8d56\u6ce8\u5165\u7684\u5bf9\u8c61\u5c31\u662f\u672c\u8eab\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u5185\u90e8\u5b9a\u4e49\u7684\u5bf9\u8c61\u6709\u7279\u6b8a\u5904\u7406\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4f8b\u5982\u6ce8\u5165\u4e00\u4e2a\u96c6\u5408\u5bf9\u8c61\uff0c\u5143\u7d20\u7c7b\u578b\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u6709\u4e00\u4e2a\u662f\u5b9a\u4e49\u5728\u672c\u8eab\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u7684\u5185\u90e8\uff0c\u5982\u679c\u4ec5\u6709\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u5219\u4f1a\u6ce8\u5165\u8fdb\u884c\uff1b\u5982\u679c\u9664\u4e86\u672c\u8eab\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u5185\u90e8\u5b9a\u4e49\u4e86\uff0c\u5176\u4ed6\u5730\u65b9\u4e5f\u5b9a\u4e49\u4e86\uff0c\u90a3\u4e48\u672c\u8eab\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"})," \u5185\u90e8\u5b9a\u4e49\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u662f\u4e0d\u4f1a\u88ab\u6ce8\u5165\u7684\uff1b\u56e0\u4e3a\u662f\u81ea\u5f15\u7528\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})," \u4e0d\u4f1a\u4f18\u5148\u8003\u8651\uff0c\u9664\u975e\u4e00\u4e2a\u90fd\u6ca1\u627e\u5230\uff0c\u624d\u4f1a\u5c1d\u8bd5\u83b7\u53d6\u81ea\u5f15\u7528\u7684 ",(0,r.jsx)(n.code,{children:"Bean"})]}),"\n",(0,r.jsx)(n.h3,{id:"determineautowirecandidate",children:"determineAutowireCandidate"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"@Nullable\nprotected String determineAutowireCandidate(Map<String, Object> candidates, DependencyDescriptor descriptor) {\n    Class<?> requiredType = descriptor.getDependencyType();\n    // <1> \u5c1d\u8bd5\u83b7\u53d6\u4e00\u4e2a @Primary \u6ce8\u89e3\u6807\u6ce8\u7684 Bean\uff0c\u5982\u679c\u6709\u627e\u5230\u591a\u4e2a\u5219\u4f1a\u629b\u51fa\u5f02\u5e38\n    String primaryCandidate = determinePrimaryCandidate(candidates, requiredType);\n    // <2> \u5982\u679c\u7b2c `1` \u6b65\u627e\u5230\u4e86\u5219\u76f4\u63a5\u8fd4\u56de\n    if (primaryCandidate != null) {\n        return primaryCandidate;\n    }\n    // <3> \u5c1d\u8bd5\u627e\u5230 @Priority \u6ce8\u89e3\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u90a3\u4e2a Bean\uff0c\u5982\u679c\u5b58\u5728\u76f8\u540c\u7684\u4f18\u5148\u7ea7\u5219\u4f1a\u629b\u51fa\u5f02\u5e38\n    String priorityCandidate = determineHighestPriorityCandidate(candidates, requiredType);\n    // <4> \u5982\u679c\u7b2c `3` \u6b65\u627e\u5230\u4e86\u5219\u76f4\u63a5\u8fd4\u56de\n    if (priorityCandidate != null) {\n        return priorityCandidate;\n    }\n    // Fallback\n    // <5> \u515c\u5e95\u65b9\u6cd5\uff0c\u904d\u5386\u6240\u6709\u7684 Bean\n    for (Map.Entry<String, Object> entry : candidates.entrySet()) {\n        String candidateName = entry.getKey();\n        Object beanInstance = entry.getValue();\n        // <5.1> \u5982\u679c\u6ee1\u8db3\u4e0b\u9762\u5176\u4e2d\u4e00\u4e2a\u6761\u4ef6\u5219\u76f4\u63a5\u8fd4\u56de\n        if ((beanInstance != null \n            && this.resolvableDependencies.containsValue(beanInstance)) // \u8be5 Bean \u4e3a Spring \u5185\u90e8\u53ef\u5904\u7406\u7684 Bean\uff0c\u4f8b\u5982 ApplicationContext\n            || matchesBeanName(candidateName, descriptor.getDependencyName())) { // \u540d\u79f0\u76f8\u5339\u914d\n            return candidateName;\n        }\n    }\n    // <6> \u4e0a\u9762\u90fd\u6ca1\u9009\u51fa\u6765\u5219\u8fd4\u56de\u4e00\u4e2a\u7a7a\u5bf9\u8c61\n    return null;\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u627e\u5230\u4e86\u591a\u4e2a\u5339\u914d\u7684\u4f9d\u8d56\u6ce8\u5165\u5bf9\u8c61\uff0c\u5219\u9700\u8981\u627e\u5230\u6700\u5339\u914d\u7684\u90a3\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u8fc7\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5c1d\u8bd5\u83b7\u53d6\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"@Primary"})," \u6ce8\u89e3\u6807\u6ce8\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u5982\u679c\u6709\u627e\u5230\u591a\u4e2a\u5219\u4f1a\u629b\u51fa\u5f02\u5e38"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u7b2c ",(0,r.jsx)(n.code,{children:"1"})," \u6b65\u627e\u5230\u4e86\u5219\u76f4\u63a5\u8fd4\u56de"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5c1d\u8bd5\u627e\u5230 ",(0,r.jsx)(n.code,{children:"@Priority"})," \u6ce8\u89e3\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u90a3\u4e2a ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u5982\u679c\u5b58\u5728\u76f8\u540c\u7684\u4f18\u5148\u7ea7\u5219\u4f1a\u629b\u51fa\u5f02\u5e38"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u7b2c ",(0,r.jsx)(n.code,{children:"3"})," \u6b65\u627e\u5230\u4e86\u5219\u76f4\u63a5\u8fd4\u56de"]}),"\n",(0,r.jsxs)(n.li,{children:["\u515c\u5e95\u65b9\u6cd5\uff0c\u904d\u5386\u6240\u6709\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u6ee1\u8db3\u4e0b\u9762\u5176\u4e2d\u4e00\u4e2a\u6761\u4ef6\u5219\u76f4\u63a5\u8fd4\u56de\uff1a\u8be5 ",(0,r.jsx)(n.code,{children:"Bean"})," \u4e3a ",(0,r.jsx)(n.code,{children:"Spring"})," \u5185\u90e8\u53ef\u5904\u7406\u7684 ",(0,r.jsx)(n.code,{children:"Bean"}),"\uff08\u4f8b\u5982 ",(0,r.jsx)(n.code,{children:"ApplicationContext"}),"\u3001",(0,r.jsx)(n.code,{children:"BeanFactory"}),"\uff09\u3001\u540d\u79f0\u76f8\u5339\u914d"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u4e0a\u9762\u90fd\u6ca1\u9009\u51fa\u6765\u5219\u8fd4\u56de\u4e00\u4e2a\u7a7a\u5bf9\u8c61"}),"\n"]}),"\n",(0,r.jsx)(n.h1,{id:"\u53c2\u8003\u8d44\u6599",children:"\u53c2\u8003\u8d44\u6599"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://juejin.cn/post/6844903957135884295#heading-2",children:"\u6398\u91d1 - @Autowired\u6ce8\u89e3\u7684\u5b9e\u73b0\u539f\u7406"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.cnblogs.com/lifullmoon/p/14453011.html",children:"CSDN -\u6b7b\u78d5Spring\u4e4bIoC\u7bc7 - @Autowired \u7b49\u6ce8\u89e3\u7684\u5b9e\u73b0\u539f\u7406"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var r=t(96540);const i={},a=r.createContext(i);function s(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);