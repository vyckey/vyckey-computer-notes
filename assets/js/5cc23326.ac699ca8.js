"use strict";(self.webpackChunkvyckey_computer_notes=self.webpackChunkvyckey_computer_notes||[]).push([[6262],{1509:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>t,contentTitle:()=>d,default:()=>o,frontMatter:()=>r,metadata:()=>s,toc:()=>i});var a=l(74848),c=l(28453);const r={title:"ThreadLocal",tags:["java","concurrent","threadlocal"],sidebar_label:"ThreadLocal",sidebar_position:1},d="ThreadLocal",s={id:"java/concurrent/threadlocal",title:"ThreadLocal",description:"\u4ecb\u7ecd",source:"@site/java/java/concurrent/threadlocal.md",sourceDirName:"java/concurrent",slug:"/java/concurrent/threadlocal",permalink:"/java/java/concurrent/threadlocal",draft:!1,unlisted:!1,tags:[{label:"java",permalink:"/java/tags/java"},{label:"concurrent",permalink:"/java/tags/concurrent"},{label:"threadlocal",permalink:"/java/tags/threadlocal"}],version:"current",lastUpdatedBy:"vyckey",lastUpdatedAt:174745298e4,sidebarPosition:1,frontMatter:{title:"ThreadLocal",tags:["java","concurrent","threadlocal"],sidebar_label:"ThreadLocal",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Thread",permalink:"/java/java/concurrent/thread"},next:{title:"Transimittable ThreadLocal",permalink:"/java/java/concurrent/transmittable_threadlocal"}},t={},i=[{value:"\u4ecb\u7ecd",id:"\u4ecb\u7ecd",level:2},{value:"\u4f7f\u7528\u573a\u666f",id:"\u4f7f\u7528\u573a\u666f",level:2},{value:"\u6570\u636e\u7ed3\u6784",id:"\u6570\u636e\u7ed3\u6784",level:2},{value:"ThreadLocal\u6570\u636e\u7ed3\u6784",id:"threadlocal\u6570\u636e\u7ed3\u6784",level:3},{value:"ThreadLocalMap\u6570\u636e\u7ed3\u6784",id:"threadlocalmap\u6570\u636e\u7ed3\u6784",level:3},{value:"ThreadLocal\u7684Entry\u8bbe\u8ba1",id:"threadlocal\u7684entry\u8bbe\u8ba1",level:3},{value:"\u4e3a\u4ec0\u4e48Entry\u8981\u4f7f\u7528\u5f31\u5f15\u7528\uff1f",id:"\u4e3a\u4ec0\u4e48entry\u8981\u4f7f\u7528\u5f31\u5f15\u7528",level:4},{value:"\u4e3a\u4ec0\u4e48\u8fd8\u662f\u4f1a\u51fa\u73b0\u5185\u5b58\u6cc4\u9732\uff1f",id:"\u4e3a\u4ec0\u4e48\u8fd8\u662f\u4f1a\u51fa\u73b0\u5185\u5b58\u6cc4\u9732",level:4},{value:"\u5728 ThreadLocal.get()\u7684\u65f6\u5019\uff0c\u53d1\u751fGC\u4e4b\u540e\uff0ckey \u662f\u5426\u4e3anull\uff1f",id:"\u5728-threadlocalget\u7684\u65f6\u5019\u53d1\u751fgc\u4e4b\u540ekey-\u662f\u5426\u4e3anull",level:4},{value:"ThreadLocal\u5e95\u5c42\u5b9e\u73b0",id:"threadlocal\u5e95\u5c42\u5b9e\u73b0",level:2},{value:"ThreadLocal\u7684Hash\u7b97\u6cd5",id:"threadlocal\u7684hash\u7b97\u6cd5",level:3},{value:"ThreadLocalMap\u7684Hash\u51b2\u7a81",id:"threadlocalmap\u7684hash\u51b2\u7a81",level:3},{value:"ThreadLocalMap\u7684get\u539f\u7406",id:"threadlocalmap\u7684get\u539f\u7406",level:3},{value:"ThreadLocalMap\u7684set\u539f\u7406",id:"threadlocalmap\u7684set\u539f\u7406",level:3},{value:"ThreadLocalMap\u6e05\u7406\u673a\u5236",id:"threadlocalmap\u6e05\u7406\u673a\u5236",level:3},{value:"\u63a2\u6d4b\u5f0f\u6e05\u7406",id:"\u63a2\u6d4b\u5f0f\u6e05\u7406",level:4},{value:"replaceStaleEntry()",id:"replacestaleentry",level:5},{value:"expungeStaleEntry()",id:"expungestaleentry",level:5},{value:"\u542f\u53d1\u5f0f\u6e05\u7406",id:"\u542f\u53d1\u5f0f\u6e05\u7406",level:4},{value:"ThreadLocalMap\u6269\u5bb9\u673a\u5236",id:"threadlocalmap\u6269\u5bb9\u673a\u5236",level:3},{value:"ThreadLocal\u7684\u591a\u7ebf\u7a0b\u7ee7\u627f",id:"threadlocal\u7684\u591a\u7ebf\u7a0b\u7ee7\u627f",level:2},{value:"InheritableThreadLocal",id:"inheritablethreadlocal",level:3},{value:"TransmittableThreadLocal",id:"transmittablethreadlocal",level:3},{value:"TTL\u4f7f\u7528\u6559\u7a0b",id:"ttl\u4f7f\u7528\u6559\u7a0b",level:4},{value:"\u6838\u5fc3\u539f\u7406\u4ecb\u7ecd",id:"\u6838\u5fc3\u539f\u7406\u4ecb\u7ecd",level:4},{value:"\u53c2\u8003\u8d44\u6599",id:"\u53c2\u8003\u8d44\u6599",level:2}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"threadlocal",children:"ThreadLocal"}),"\n",(0,a.jsx)(n.h2,{id:"\u4ecb\u7ecd",children:"\u4ecb\u7ecd"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its get or set method) has its own, independently initialized copy of the variable. ThreadLocal instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID)."}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u662f\u4e00\u4e2a\u5c06\u5728\u591a\u7ebf\u7a0b\u4e2d\u4e3a\u6bcf\u4e00\u4e2a\u7ebf\u7a0b\u521b\u5efa\u5355\u72ec\u7684\u53d8\u91cf\u526f\u672c\u7684\u7c7b; \u5f53\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u6765\u7ef4\u62a4\u53d8\u91cf\u65f6, ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u4f1a\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u521b\u5efa\u5355\u72ec\u7684\u53d8\u91cf\u526f\u672c, \u907f\u514d\u56e0\u591a\u7ebf\u7a0b\u64cd\u4f5c\u5171\u4eab\u53d8\u91cf\u800c\u5bfc\u81f4\u7684\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002"]}),"\n",(0,a.jsx)(n.h2,{id:"\u4f7f\u7528\u573a\u666f",children:"\u4f7f\u7528\u573a\u666f"}),"\n",(0,a.jsx)(n.h2,{id:"\u6570\u636e\u7ed3\u6784",children:"\u6570\u636e\u7ed3\u6784"}),"\n",(0,a.jsx)(n.h3,{id:"threadlocal\u6570\u636e\u7ed3\u6784",children:"ThreadLocal\u6570\u636e\u7ed3\u6784"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"Thread"})," \u7c7b\u6709\u4e00\u4e2a\u7c7b\u578b\u4e3a ",(0,a.jsx)(n.code,{children:"ThreadLocal.ThreadLocalMap"})," \u7684\u5b9e\u4f8b\u53d8\u91cf ",(0,a.jsx)(n.code,{children:"threadLocals"})," \uff0c\u4e5f\u5c31\u662f\u8bf4\u6bcf\u4e2a\u7ebf\u7a0b\u6709\u4e00\u4e2a\u81ea\u5df1\u7684 ",(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u3002",(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u6709\u81ea\u5df1\u7684\u72ec\u7acb\u5b9e\u73b0\uff0c\u53ef\u4ee5\u7b80\u5355\u5730\u5c06\u5b83\u7684 ",(0,a.jsx)(n.code,{children:"key"})," \u89c6\u4f5c ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \uff08\u5b9e\u9645\u4e0a ",(0,a.jsx)(n.code,{children:"key"})," \u5e76\u4e0d\u662f ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u672c\u8eab\uff0c\u800c\u662f\u5b83\u7684\u4e00\u4e2a\u5f31\u5f15\u7528\uff09\uff0c ",(0,a.jsx)(n.code,{children:"value"})," \u4e3a\u4ee3\u7801\u4e2d\u653e\u5165\u7684\u503c\u3002\u6bcf\u4e2a\u7ebf\u7a0b\u5728\u5f80 ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u91cc\u653e\u503c\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u5f80\u81ea\u5df1\u7684 ",(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u91cc\u5b58\uff0c\u8bfb\u4e5f\u662f\u4ee5 ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u4f5c\u4e3a\u5f15\u7528\uff0c\u5728\u81ea\u5df1\u7684 ",(0,a.jsx)(n.code,{children:"map"})," \u91cc\u627e\u5bf9\u5e94\u7684 ",(0,a.jsx)(n.code,{children:"key"})," \uff0c\u4ece\u800c\u5b9e\u73b0\u4e86\u7ebf\u7a0b\u9694\u79bb\u3002 ",(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u6709\u70b9\u7c7b\u4f3c ",(0,a.jsx)(n.code,{children:"HashMap"})," \u7684\u7ed3\u6784\uff0c\u53ea\u662f ",(0,a.jsx)(n.code,{children:"HashMap"})," \u662f\u7531\u6570\u7ec4+\u94fe\u8868\u5b9e\u73b0\u7684\uff0c\u800c ",(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u4e2d\u5e76\u6ca1\u6709\u94fe\u8868\u7ed3\u6784\u3002\u6211\u4eec\u8fd8\u8981\u6ce8\u610f ",(0,a.jsx)(n.code,{children:"Entry"})," \uff0c \u5b83\u7684 ",(0,a.jsx)(n.code,{children:"key"})," \u662f ",(0,a.jsx)(n.code,{children:"ThreadLocal<?> k "}),"\uff0c\u7ee7\u627f\u81ea ",(0,a.jsx)(n.code,{children:"WeakReference"})," \uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u5f31\u5f15\u7528\u7c7b\u578b\u3002"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(8574).A+"",width:"1486",height:"1490"})}),"\n",(0,a.jsxs)(n.p,{children:["\u4e0b\u9762\u662f\u6765\u81ea ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u7684\u90e8\u5206\u6838\u5fc3\u6e90\u7801\uff0c\u53ef\u4ee5\u5f88\u6e05\u6670\u5730\u770b\u51fa\u4e0a\u56fe\u7684\u539f\u7406\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public class ThreadLocal<T> {\n    public T get() {\n        Thread t = Thread.currentThread();\n        ThreadLocalMap map = getMap(t);\n        if (map != null) {\n            ThreadLocalMap.Entry e = map.getEntry(this);\n            if (e != null) {\n                T result = (T)e.value;\n                return result;\n            }\n        }\n        return setInitialValue();\n    }\n\n    ThreadLocalMap getMap(Thread t) {\n        return t.threadLocals;\n    }\n\n    public void set(T value) {\n        Thread t = Thread.currentThread();\n        ThreadLocalMap map = getMap(t);\n        if (map != null) {\n            map.set(this, value);\n        } else {\n            createMap(t, value);\n        }\n    }\n\n    void createMap(Thread t, T firstValue) {\n        t.threadLocals = new ThreadLocalMap(this, firstValue);\n    }\n\n    public void remove() {\n         ThreadLocalMap m = getMap(Thread.currentThread());\n         if (m != null) {\n             m.remove(this);\n         }\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"threadlocalmap\u6570\u636e\u7ed3\u6784",children:"ThreadLocalMap\u6570\u636e\u7ed3\u6784"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"static class ThreadLocalMap {\n    /**\n     * The initial capacity -- MUST be a power of two.\n     */\n    private static final int INITIAL_CAPACITY = 16;\n\n    /**\n     * The table, resized as necessary.\n     * table.length MUST always be a power of two.\n     */\n    private Entry[] table;\n\n    /**\n     * The number of entries in the table.\n     */\n    private int size = 0;\n\n    /**\n     * The next size value at which to resize.\n     */\n    private int threshold; // Default to 0\n\n    static class Entry extends WeakReference<ThreadLocal<?>> {\n        /** The value associated with this ThreadLocal. */\n        Object value;\n\n        Entry(ThreadLocal<?> k, Object v) {\n            super(k);\n            value = v;\n        }\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"threadlocal\u7684entry\u8bbe\u8ba1",children:"ThreadLocal\u7684Entry\u8bbe\u8ba1"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(66485).A+"",width:"1080",height:"555"})}),"\n",(0,a.jsx)(n.h4,{id:"\u4e3a\u4ec0\u4e48entry\u8981\u4f7f\u7528\u5f31\u5f15\u7528",children:"\u4e3a\u4ec0\u4e48Entry\u8981\u4f7f\u7528\u5f31\u5f15\u7528\uff1f"}),"\n",(0,a.jsx)(n.p,{children:"\u5f31\u5f15\u7528\u5bf9\u8c61\u6709\u66f4\u77ed\u6682\u7684\u751f\u547d\u5468\u671f\uff0c\u4e0d\u7ba1\u5185\u5b58\u7a7a\u95f4\u662f\u5426\u5269\u4f59\uff0c\u90fd\u6709\u53ef\u80fd\u4f1a\u88ab\u56de\u6536\u3002"}),"\n",(0,a.jsxs)(n.p,{children:["\u5047\u5982\u6bcf\u4e2a ",(0,a.jsx)(n.code,{children:"key"})," \u90fd\u5f3a\u5f15\u7528\u6307\u5411 ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u7684\u5bf9\u8c61\uff0c\u4e5f\u5c31\u662f\u4e0a\u56fe\u865a\u7ebf\u90a3\u91cc\u662f\u4e2a\u5f3a\u5f15\u7528\uff0c\u90a3\u4e48\u8fd9\u4e2a ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u5bf9\u8c61\u5c31\u4f1a\u56e0\u4e3a\u548c ",(0,a.jsx)(n.code,{children:"Entry"})," \u5bf9\u8c61\u5b58\u5728\u5f3a\u5f15\u7528\u5173\u8054\u800c\u65e0\u6cd5\u88abGC\u56de\u6536\uff0c\u9020\u6210",(0,a.jsx)(n.strong,{children:"\u5185\u5b58\u6cc4\u6f0f"}),"\uff0c\u9664\u975e\u7ebf\u7a0b\u7ed3\u675f\u540e\uff0c\u7ebf\u7a0b\u88ab\u56de\u6536\u4e86\uff0c ",(0,a.jsx)(n.code,{children:"map"})," \u4e5f\u8ddf\u7740\u56de\u6536\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"\u4e3a\u4ec0\u4e48\u8fd8\u662f\u4f1a\u51fa\u73b0\u5185\u5b58\u6cc4\u9732",children:"\u4e3a\u4ec0\u4e48\u8fd8\u662f\u4f1a\u51fa\u73b0\u5185\u5b58\u6cc4\u9732\uff1f"}),"\n",(0,a.jsxs)(n.p,{children:["\u5f53\u628a ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u5bf9\u8c61\u7684\u5f15\u7528\u7f6e\u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u540e\uff0c\u6ca1\u6709\u4efb\u4f55\u5f3a\u5f15\u7528\u6307\u5411\u5185\u5b58\u4e2d\u7684 ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u5b9e\u4f8b\uff0c",(0,a.jsx)(n.code,{children:"threadLocals"})," \u7684 ",(0,a.jsx)(n.code,{children:"key"})," \u662f\u5b83\u7684\u5f31\u5f15\u7528\uff0c\u6545\u5b83\u5c06\u4f1a\u88abGC\u56de\u6536\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u4f46\u7ebf\u7a0b\u4e2d ",(0,a.jsx)(n.code,{children:"threadLocals"})," \u91cc\u7684 ",(0,a.jsx)(n.code,{children:"value"})," \u5374\u6ca1\u6709\u88ab\u56de\u6536\uff0c\u56e0\u4e3a\u5b58\u5728\u7740\u4e00\u6761\u4ece\u5f53\u524d\u7ebf\u7a0b\u5bf9\u8c61\u8fde\u63a5\u8fc7\u6765\u7684\u5f3a\u5f15\u7528\uff0c\u4e14\u56e0\u4e3a\u65e0\u6cd5\u518d\u901a\u8fc7 ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u5bf9\u8c61\u7684 ",(0,a.jsx)(n.code,{children:"get"})," \u65b9\u6cd5\u83b7\u53d6\u5230\u8fd9\u4e2a ",(0,a.jsx)(n.code,{children:"value"})," \uff0c\u5b83\u6c38\u8fdc\u4e0d\u4f1a\u88ab\u8bbf\u95ee\u5230\u4e86\uff0c\u6240\u4ee5\u8fd8\u5b58\u5728\u5185\u5b58\u6cc4\u6f0f\u95ee\u9898\u3002\n\u540c\u6837\u7684\uff0c\u53ea\u6709\u5728\u5f53\u524d\u7ebf\u7a0b\u7ed3\u675f\u540e\uff0c\u7ebf\u7a0b\u5bf9\u8c61\u7684\u5f15\u7528\u4e0d\u518d\u5b58\u5728\u4e8e\u6808\u4e2d\uff0c\u5f3a\u5f15\u7528\u65ad\u5f00\uff0c\u5185\u5b58\u4e2d\u7684 Current ",(0,a.jsx)(n.code,{children:"Thread"}),"\u3001",(0,a.jsx)(n.code,{children:"ThreadLocalMap"}),"\u3001",(0,a.jsx)(n.code,{children:"value"})," \u624d\u4f1a\u5168\u90e8\u88abGC\u56de\u6536\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u89e3\u51b3\u5185\u5b58\u6cc4\u9732\u7684\u65b9\u6cd5\uff1a\u5f53\u7ebf\u7a0b\u7684\u67d0\u4e2a ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u5bf9\u8c61\u4f7f\u7528\u5b8c\u4e86\uff0c\u9a6c\u4e0a\u8c03\u7528 ",(0,a.jsx)(n.code,{children:"remove"})," \u65b9\u6cd5\uff0c\u5220\u9664 ",(0,a.jsx)(n.code,{children:"Entry"})," \u5bf9\u8c61\u3002\u53ea\u8981\u8fd9\u4e2a\u7ebf\u7a0b\u5bf9\u8c61\u53ca\u65f6\u88abGC\u56de\u6536\uff0c\u8fd9\u4e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898\u5f71\u54cd\u4e0d\u5927\uff0c\u53ea\u53d1\u751f\u5728 ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u5bf9\u8c61\u7684\u5f15\u7528\u8bbe\u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u5230\u7ebf\u7a0b\u7ed3\u675f\u7684\u8fd9\u6bb5\u65f6\u95f4\u5185\u3002\u4f46\u5728\u4f7f\u7528\u7ebf\u7a0b\u6c60\u7684\u65f6\u5019\uff0c\u7ebf\u7a0b\u7ed3\u675f\u662f\u4e0d\u4f1a\u88ab\u9500\u6bc1\u7684\uff0c\u4f1a\u518d\u6b21\u4f7f\u7528\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0\u771f\u6b63\u7684\u5185\u5b58\u6cc4\u9732\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"\u5728-threadlocalget\u7684\u65f6\u5019\u53d1\u751fgc\u4e4b\u540ekey-\u662f\u5426\u4e3anull",children:"\u5728 ThreadLocal.get()\u7684\u65f6\u5019\uff0c\u53d1\u751fGC\u4e4b\u540e\uff0ckey \u662f\u5426\u4e3anull\uff1f"}),"\n",(0,a.jsxs)(n.p,{children:["\u7f51\u4e0a\u6709\u76f8\u5173\u7684\u6e90\u7801\u8c03\u8bd5\u53ef\u4ee5\u8fdb\u884c\u6d4b\uff1a",(0,a.jsx)(n.a,{href:"https://blog.csdn.net/thewindkee/article/details/103726942",children:"CSDN - \u6d4b\u8bd5ThreadLocal \u5728gc\u540e\u5f15\u53d1\u7684threadLocalMap\u7684key\u4e3anull,\u4f46value\u4e0d\u4e3anull\u7684\u60c5\u51b5"}),"\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"ThreadLocal.get()"})," \u64cd\u4f5c\uff0c ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u7684\u5bf9\u8c61\u5f15\u7528\u88abStack\u6301\u6709\uff0c\u6b64\u65f6\u8fd8\u662f\u6709\u5f3a\u5f15\u7528\u5b58\u5728\u7684\uff0c\u6240\u4ee5 ",(0,a.jsx)(n.code,{children:"key"})," \u5e76\u4e0d\u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \uff0c\u4e5f\u5c31\u662f\u4e0d\u4f1a\u88abGC\u56de\u6536\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(45802).A+"",width:"1219",height:"394"})}),"\n",(0,a.jsx)(n.h2,{id:"threadlocal\u5e95\u5c42\u5b9e\u73b0",children:"ThreadLocal\u5e95\u5c42\u5b9e\u73b0"}),"\n",(0,a.jsx)(n.h3,{id:"threadlocal\u7684hash\u7b97\u6cd5",children:"ThreadLocal\u7684Hash\u7b97\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public class ThreadLocal<T> {\n    private final int threadLocalHashCode = nextHashCode();\n    private static AtomicInteger nextHashCode = new AtomicInteger();\n    private static final int HASH_INCREMENT = 0x61c88647;\n\n    private static int nextHashCode() {\n        return nextHashCode.getAndAdd(HASH_INCREMENT);\n    }\n\n    static class ThreadLocalMap {\n        ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {\n            table = new Entry[INITIAL_CAPACITY];\n            // Entry\u504f\u79fb\u91cfhash\u8ba1\u7b97\u65b9\u5f0f\n            int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);\n\n            table[i] = new Entry(firstKey, firstValue);\n            size = 1;\n            setThreshold(INITIAL_CAPACITY);\n        }\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u4e2dhash\u7b97\u6cd5\u5f88\u7b80\u5355\uff0c",(0,a.jsx)(n.code,{children:"firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1)"})," \u7684\u503c\u5c31\u662f\u5f53\u524d ",(0,a.jsx)(n.code,{children:"key"})," \u5728\u6563\u5217\u8868\u4e2d\u5bf9\u5e94\u7684\u6570\u7ec4\u4e0b\u6807\u4f4d\u7f6e\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u6bcf\u5f53\u521b\u5efa\u4e00\u4e2a ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u5bf9\u8c61\uff0c\u8fd9\u4e2a ",(0,a.jsx)(n.code,{children:"ThreadLocal.nextHashCode"})," \u8fd9\u4e2a\u503c\u5c31\u4f1a\u589e\u957f ",(0,a.jsx)(n.code,{children:"0x61c88647"})," \u3002\u8fd9\u4e2a\u503c\u662f",(0,a.jsx)(n.strong,{children:"\u6590\u6ce2\u90a3\u5951\u6570"}),"\uff0c\u4e5f\u53eb",(0,a.jsx)(n.strong,{children:"\u9ec4\u91d1\u5206\u5272\u6570"}),"\uff0c\u53ef\u4ee5\u4f7f\u6563\u5217\u6548\u679c\u975e\u5e38\u597d\u3002"]}),"\n",(0,a.jsx)(n.h3,{id:"threadlocalmap\u7684hash\u51b2\u7a81",children:"ThreadLocalMap\u7684Hash\u51b2\u7a81"}),"\n",(0,a.jsxs)(n.p,{children:["\u867d\u7136 ",(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u4e2d\u4f7f\u7528\u4e86\u9ec4\u91d1\u5206\u5272\u6570\u6765\u4f5c\u4e3a ",(0,a.jsx)(n.code,{children:"hash"})," \u8ba1\u7b97\u56e0\u5b50\uff0c\u5927\u5927\u51cf\u5c11\u4e86 ",(0,a.jsx)(n.code,{children:"hash"})," \u51b2\u7a81\u7684\u6982\u7387\uff0c\u4f46\u662f\u4ecd\u7136\u4f1a\u5b58\u5728\u51b2\u7a81\u3002",(0,a.jsx)(n.code,{children:"HashMap"})," \u4e2d\u89e3\u51b3\u51b2\u7a81\u7684\u65b9\u6cd5\u662f\u5728\u6570\u7ec4\u4e0a\u6784\u9020\u4e00\u4e2a\u94fe\u8868\u7ed3\u6784\uff0c\u51b2\u7a81\u7684\u6570\u636e\u6302\u8f7d\u5230\u94fe\u8868\u4e0a\uff0c\u5982\u679c\u94fe\u8868\u957f\u5ea6\u8d85\u8fc7\u4e00\u5b9a\u6570\u91cf\u5219\u4f1a\u8f6c\u5316\u6210\u7ea2\u9ed1\u6811\u3002\u800c ",(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u4e2d\u5e76\u6ca1\u6709\u94fe\u8868\u7ed3\u6784\uff0c\u6240\u4ee5\u8fd9\u91cc\u4e0d\u80fd\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"HashMap"})," \u89e3\u51b3\u51b2\u7a81\u7684\u65b9\u5f0f\u4e86\u3002"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(45925).A+"",width:"1478",height:"424"})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"\u6ce8\u660e\uff1a\u793a\u4f8b\u56fe\u4e2d\uff0c\u7eff\u8272\u5757Entry\u4ee3\u8868\u6b63\u5e38\u6570\u636e\uff0c\u7070\u8272\u5757\u4ee3\u8868Entry\u7684key\u503c\u4e3anull\uff0c\u5df2\u88ab\u5783\u573e\u56de\u6536\u3002\u767d\u8272\u5757\u8868\u793aEntry\u4e3anull\u3002"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u5982\u679c\u6211\u4eec\u63d2\u5165\u4e00\u4e2a ",(0,a.jsx)(n.code,{children:"value=27"})," \u7684\u6570\u636e\uff0c\u901a\u8fc7 ",(0,a.jsx)(n.code,{children:"hash"})," \u8ba1\u7b97\u540e\u5e94\u8be5\u843d\u5165\u69fd\u4f4d ",(0,a.jsx)(n.code,{children:"4"})," \u4e2d\uff0c\u800c\u69fd\u4f4d ",(0,a.jsx)(n.code,{children:"4"})," \u5df2\u7ecf\u6709\u4e86 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e\u3002\u6b64\u65f6\u5c31\u4f1a\u7ebf\u6027\u5411\u540e\u67e5\u627e\uff0c\u4e00\u76f4\u627e\u5230 ",(0,a.jsx)(n.code,{children:"Entry"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u7684\u69fd\u4f4d\u624d\u4f1a\u505c\u6b62\u67e5\u627e\uff0c\u5c06\u5f53\u524d\u5143\u7d20\u653e\u5165\u6b64\u69fd\u4f4d\u4e2d\u3002\u5f53\u7136\u8fed\u4ee3\u8fc7\u7a0b\u4e2d\u8fd8\u6709\u5176\u4ed6\u7684\u60c5\u51b5\uff0c\u6bd4\u5982\u9047\u5230\u4e86 ",(0,a.jsx)(n.code,{children:"Entry"})," \u4e0d\u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u4e14 ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u76f8\u7b49\u7684\u60c5\u51b5\uff0c\u8fd8\u6709 ",(0,a.jsx)(n.code,{children:"Entry"})," \u4e2d\u7684 ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u7684\u60c5\u51b5\u7b49\u7b49\u90fd\u4f1a\u6709\u4e0d\u540c\u7684\u5904\u7406\uff0c\u540e\u9762\u4f1a\u4e00\u4e00\u8be6\u7ec6\u8bb2\u89e3\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u8fd9\u91cc\u8fd8\u753b\u4e86\u4e00\u4e2a ",(0,a.jsx)(n.code,{children:"Entry"})," \u4e2d\u7684 ",(0,a.jsx)(n.code,{children:"key"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u7684\u6570\u636e\uff08",(0,a.jsx)(n.code,{children:"Entry=2"})," \u7684\u7070\u8272\u5757\u6570\u636e\uff09\uff0c\u56e0\u4e3a ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u662f\u5f31\u5f15\u7528\u7c7b\u578b\uff0c\u6240\u4ee5\u4f1a\u6709\u8fd9\u79cd\u6570\u636e\u5b58\u5728\u3002\u5728 ",(0,a.jsx)(n.code,{children:"set"})," \u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u9047\u5230\u4e86 ",(0,a.jsx)(n.code,{children:"key"})," \u8fc7\u671f\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e\uff0c\u5b9e\u9645\u4e0a\u662f\u4f1a\u8fdb\u884c\u4e00\u8f6e\u63a2\u6d4b\u5f0f\u6e05\u7406\u64cd\u4f5c\u7684\uff0c\u5177\u4f53\u64cd\u4f5c\u65b9\u5f0f\u540e\u9762\u4f1a\u8bb2\u5230\u3002"]}),"\n",(0,a.jsx)(n.h3,{id:"threadlocalmap\u7684get\u539f\u7406",children:"ThreadLocalMap\u7684get\u539f\u7406"}),"\n",(0,a.jsxs)(n.p,{children:["\u4e0b\u9762\u662f ",(0,a.jsx)(n.code,{children:"ThreadLocalMap.get()"})," \u65b9\u6cd5\u7684\u6838\u5fc3\u4ee3\u7801\u5b9e\u73b0\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"    private Entry getEntry(ThreadLocal<?> key) {\n        int i = key.threadLocalHashCode & (table.length - 1);\n        Entry e = table[i];\n        if (e != null && e.get() == key)\n            return e;\n        else\n            return getEntryAfterMiss(key, i, e);\n    }\n    \n    private Entry getEntryAfterMiss(ThreadLocal<?> key, int i, Entry e) {\n        Entry[] tab = table;\n        int len = tab.length;\n\n        while (e != null) {\n            ThreadLocal<?> k = e.get();\n            if (k == key)\n                return e;\n            if (k == null)\n                expungeStaleEntry(i);\n            else\n                i = nextIndex(i, len);\n            e = tab[i];\n        }\n        return null;\n    }\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u7b2c\u4e00\u79cd\u60c5\u51b5\uff1a \u901a\u8fc7\u67e5\u627e ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u8ba1\u7b97\u51fa\u6563\u5217\u8868\u4e2d ",(0,a.jsx)(n.code,{children:"slot"})," \u4f4d\u7f6e\uff0c\u7136\u540e\u8be5 ",(0,a.jsx)(n.code,{children:"slot"})," \u4f4d\u7f6e\u4e2d\u7684 ",(0,a.jsx)(n.code,{children:"Entry.key"})," \u548c\u67e5\u627e\u7684 ",(0,a.jsx)(n.code,{children:"key"})," \u4e00\u81f4\uff0c\u5219\u76f4\u63a5\u8fd4\u56de\uff1a"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(39520).A+"",width:"1342",height:"404"})}),"\n",(0,a.jsxs)(n.p,{children:["\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff1a ",(0,a.jsx)(n.code,{children:"slot"})," \u4f4d\u7f6e\u4e2d\u7684 ",(0,a.jsx)(n.code,{children:"Entry.key"})," \u548c\u8981\u67e5\u627e\u7684 ",(0,a.jsx)(n.code,{children:"key"})," \u4e0d\u4e00\u81f4\u3002\u6211\u4eec\u4ee5 ",(0,a.jsx)(n.code,{children:"get(ThreadLocal1)"})," \u4e3a\u4f8b\uff0c\u901a\u8fc7 ",(0,a.jsx)(n.code,{children:"hash"})," \u8ba1\u7b97\u540e\uff0c\u6b63\u786e\u7684 ",(0,a.jsx)(n.code,{children:"slot"})," \u4f4d\u7f6e\u5e94\u8be5\u662f ",(0,a.jsx)(n.code,{children:"4"})," \uff0c\u800c ",(0,a.jsx)(n.code,{children:"index=4"})," \u7684\u69fd\u4f4d\u5df2\u7ecf\u6709\u4e86\u6570\u636e\uff0c\u4e14 ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u4e0d\u7b49\u4e8e ",(0,a.jsx)(n.code,{children:"ThreadLocal1"})," \uff0c\u6240\u4ee5\u9700\u8981\u7ee7\u7eed\u5f80\u540e\u8fed\u4ee3\u67e5\u627e\u3002"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(17851).A+"",width:"1288",height:"423"})}),"\n",(0,a.jsxs)(n.p,{children:["\u8fed\u4ee3\u5230 ",(0,a.jsx)(n.code,{children:"index=5"})," \u7684\u6570\u636e\u65f6\uff0c\u6b64\u65f6 ",(0,a.jsx)(n.code,{children:"Entry.key=null"})," \uff0c\u89e6\u53d1\u4e00\u6b21",(0,a.jsx)(n.strong,{children:"\u63a2\u6d4b\u5f0f\u6570\u636e\u56de\u6536"}),"\u64cd\u4f5c\uff0c\u5373\u6267\u884c ",(0,a.jsx)(n.code,{children:"expungeStaleEntry()"})," \u65b9\u6cd5\uff08\u53c2\u8003\u540e\u7eed\u7684\u4ecb\u7ecd\uff09\uff0c\u6267\u884c\u5b8c\u540e\uff0c",(0,a.jsx)(n.code,{children:"index 5,8"}),"\u7684\u6570\u636e\u90fd\u4f1a\u88ab\u56de\u6536\uff0c\u800c",(0,a.jsx)(n.code,{children:"index 6,7"}),"\u7684\u6570\u636e\u90fd\u4f1a\u524d\u79fb\u3002",(0,a.jsx)(n.code,{children:"index 6,7"}),"\u524d\u79fb\u4e4b\u540e\uff0c\u7ee7\u7eed\u4ece ",(0,a.jsx)(n.code,{children:"index=5"})," \u5f80\u540e\u8fed\u4ee3\uff0c\u4e8e\u662f\u5c31\u5728 ",(0,a.jsx)(n.code,{children:"index=5"})," \u627e\u5230\u4e86 ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u76f8\u7b49\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(3026).A+"",width:"1443",height:"421"})}),"\n",(0,a.jsx)(n.h3,{id:"threadlocalmap\u7684set\u539f\u7406",children:"ThreadLocalMap\u7684set\u539f\u7406"}),"\n",(0,a.jsxs)(n.p,{children:["\u4e0b\u9762\u662f ",(0,a.jsx)(n.code,{children:"ThreadLocalMap.set()"})," \u65b9\u6cd5\u7684\u6838\u5fc3\u4ee3\u7801\u5b9e\u73b0\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"    private void set(ThreadLocal<?> key, Object value) {\n        // We don't use a fast path as with get() because it is at\n        // least as common to use set() to create new entries as\n        // it is to replace existing ones, in which case, a fast\n        // path would fail more often than not.\n\n        Entry[] tab = table;\n        int len = tab.length;\n        int i = key.threadLocalHashCode & (len-1);\n\n        for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {\n            ThreadLocal<?> k = e.get();\n            if (k == key) {\n                e.value = value;\n                return;\n            }\n            if (k == null) {\n                replaceStaleEntry(key, value, i);\n                return;\n            }\n        }\n\n        tab[i] = new Entry(key, value);\n        int sz = ++size;\n        if (!cleanSomeSlots(i, sz) && sz >= threshold)\n            rehash();\n    }\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5f80 ",(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u4e2d ",(0,a.jsx)(n.code,{children:"set"})," \u6570\u636e\uff08\u65b0\u589e\u6216\u8005\u66f4\u65b0\u6570\u636e\uff09\u5206\u4e3a\u597d\u51e0\u79cd\u60c5\u51b5\uff0c\u9488\u5bf9\u4e0d\u540c\u7684\u60c5\u51b5\u6211\u4eec\u753b\u56fe\u6765\u8bf4\u660e\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"\u7b2c\u4e00\u79cd\u60c5\u51b5\uff1a \u901a\u8fc7hash\u8ba1\u7b97\u540e\u7684\u69fd\u4f4d\u5bf9\u5e94\u7684Entry\u6570\u636e\u4e3a\u7a7a\uff0c\u8fd9\u91cc\u76f4\u63a5\u5c06\u6570\u636e\u653e\u5230\u8be5\u69fd\u4f4d\u5373\u53ef\uff1a"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(23212).A+"",width:"1494",height:"363"})}),"\n",(0,a.jsxs)(n.p,{children:["\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff1a \u69fd\u4f4d\u6570\u636e\u4e0d\u4e3a\u7a7a\uff0c",(0,a.jsx)(n.code,{children:"key"})," \u503c\u4e0e\u5f53\u524d ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u901a\u8fc7 ",(0,a.jsx)(n.code,{children:"hash"})," \u8ba1\u7b97\u83b7\u53d6\u7684 ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u4e00\u81f4\uff1a\u8fd9\u91cc\u76f4\u63a5\u66f4\u65b0\u8be5\u69fd\u4f4d\u7684\u6570\u636e\u3002"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(43271).A+"",width:"1212",height:"376"})}),"\n",(0,a.jsxs)(n.p,{children:["\u7b2c\u4e09\u79cd\u60c5\u51b5\uff1a \u69fd\u4f4d\u6570\u636e\u4e0d\u4e3a\u7a7a\uff0c\u5f80\u540e\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u5728\u627e\u5230 ",(0,a.jsx)(n.code,{children:"Entry"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u7684\u69fd\u4f4d\u4e4b\u524d\uff0c\u6ca1\u6709\u9047\u5230 ",(0,a.jsx)(n.code,{children:"key"})," \u8fc7\u671f\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u3002\u904d\u5386\u6563\u5217\u6570\u7ec4\uff0c\u7ebf\u6027\u5f80\u540e\u67e5\u627e\uff0c\u5982\u679c\u627e\u5230 ",(0,a.jsx)(n.code,{children:"Entry"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u7684\u69fd\u4f4d\uff0c\u5219\u5c06\u6570\u636e\u653e\u5165\u8be5\u69fd\u4f4d\u4e2d\uff0c\u6216\u8005\u5f80\u540e\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u9047\u5230\u4e86 ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u76f8\u7b49\u7684\u6570\u636e\uff0c\u76f4\u63a5\u66f4\u65b0\u5373\u53ef\u3002"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(24958).A+"",width:"1238",height:"398"})}),"\n",(0,a.jsxs)(n.p,{children:["\u7b2c\u56db\u79cd\u60c5\u51b5\uff1a \u69fd\u4f4d\u6570\u636e\u4e0d\u4e3a\u7a7a\uff0c\u5f80\u540e\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u5728\u627e\u5230 ",(0,a.jsx)(n.code,{children:"Entry"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u7684\u69fd\u4f4d\u4e4b\u524d\uff0c\u9047\u5230 ",(0,a.jsx)(n.code,{children:"key"})," \u8fc7\u671f\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \uff0c\u5982\u4e0b\u56fe\uff0c\u5f80\u540e\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u9047\u5230\u4e86 ",(0,a.jsx)(n.code,{children:"index=7"})," \u7684\u69fd\u4f4d\u6570\u636e Entry \u7684 ",(0,a.jsx)(n.code,{children:"key=null"}),"\uff1a"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(65969).A+"",width:"1318",height:"404"})}),"\n",(0,a.jsxs)(n.p,{children:["\u6563\u5217\u6570\u7ec4\u4e0b\u6807\u4e3a ",(0,a.jsx)(n.code,{children:"7"})," \u4f4d\u7f6e\u5bf9\u5e94\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e ",(0,a.jsx)(n.code,{children:"key"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \uff0c\u8868\u660e\u6b64\u6570\u636e ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u5df2\u7ecf\u88ab\u5783\u573e\u56de\u6536\u6389\u4e86\u3002\u6b64\u65f6\u5c31\u4f1a\u6267\u884c ",(0,a.jsx)(n.code,{children:"replaceStaleEntry()"})," \u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u542b\u4e49\u662f\u66ff\u6362\u8fc7\u671f\u6570\u636e\u7684\u903b\u8f91\uff0c\u4ee5 ",(0,a.jsx)(n.code,{children:"index=7"})," \u4f4d\u8d77\u70b9\u5f00\u59cb\u904d\u5386\uff0c\u8fdb\u884c",(0,a.jsx)(n.strong,{children:"\u63a2\u6d4b\u5f0f\u6570\u636e\u6e05\u7406"}),"\u5de5\u4f5c\uff08\u540e\u4e00\u7ae0\u8282\u4f1a\u8be6\u7ec6\u4ecb\u7ecd\uff09\uff0c\u6700\u540e\u66ff\u6362\u65b0\u7684\u503c \u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u66ff\u6362\u5b8c\u6210\u540e\u4e5f\u662f\u8fdb\u884c\u8fc7\u671f\u5143\u7d20\u6e05\u7406\u5de5\u4f5c\uff0c\u6e05\u7406\u5de5\u4f5c\u4e3b\u8981\u662f\u6709\u4e24\u4e2a\u65b9\u6cd5\uff1a",(0,a.jsx)(n.code,{children:"expungeStaleEntry()"})," \u548c ",(0,a.jsx)(n.code,{children:"cleanSomeSlots()"})," \uff0c\u5177\u4f53\u7ec6\u8282\u540e\u7eed\u7ae0\u8282\u8be6\u7ec6\u4ecb\u7ecd\u3002"]}),"\n",(0,a.jsx)(n.h3,{id:"threadlocalmap\u6e05\u7406\u673a\u5236",children:"ThreadLocalMap\u6e05\u7406\u673a\u5236"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"ThreadLocalMap"})," \u8fc7\u671f ",(0,a.jsx)(n.code,{children:"key"})," \u7684\u4e24\u79cd\u6e05\u7406\u65b9\u5f0f\uff1a",(0,a.jsxs)(n.strong,{children:["\u63a2\u6d4b\u5f0f\u6e05\u7406(",(0,a.jsx)(n.code,{children:"expungeStaleEntry()"}),")"]}),"\u3001",(0,a.jsxs)(n.strong,{children:["\u542f\u53d1\u5f0f\u6e05\u7406(",(0,a.jsx)(n.code,{children:"cleanSomeSlots()"}),")"]}),"\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"\u63a2\u6d4b\u5f0f\u6e05\u7406",children:"\u63a2\u6d4b\u5f0f\u6e05\u7406"}),"\n",(0,a.jsx)(n.h5,{id:"replacestaleentry",children:"replaceStaleEntry()"}),"\n",(0,a.jsxs)(n.p,{children:["\u8be5\u65b9\u6cd5\u4e3b\u8981\u7528\u5728 ",(0,a.jsx)(n.code,{children:"ThreadLocalMap.set()"})," \u65b9\u6cd5\uff0c\u7528\u6765\u6e05\u7406\u6570\u636e\uff0c\u5e76\u8fdb\u884c\u586b\u5145 ",(0,a.jsx)(n.code,{children:"Entry"}),"\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"    private void replaceStaleEntry(ThreadLocal<?> key, Object value, int staleSlot) {\n        Entry[] tab = table;\n        int len = tab.length;\n        Entry e;\n\n        // Back up to check for prior stale entry in current run.\n        // We clean out whole runs at a time to avoid continual\n        // incremental rehashing due to garbage collector freeing\n        // up refs in bunches (i.e., whenever the collector runs).\n        int slotToExpunge = staleSlot;\n        for (int i = prevIndex(staleSlot, len); (e = tab[i]) != null; i = prevIndex(i, len))\n            if (e.get() == null)\n                slotToExpunge = i;\n\n        // Find either the key or trailing null slot of run, whichever\n        // occurs first\n        for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {\n            ThreadLocal<?> k = e.get();\n\n            // If we find key, then we need to swap it\n            // with the stale entry to maintain hash table order.\n            // The newly stale slot, or any other stale slot\n            // encountered above it, can then be sent to expungeStaleEntry\n            // to remove or rehash all of the other entries in run.\n            if (k == key) {\n                e.value = value;\n                tab[i] = tab[staleSlot];\n                tab[staleSlot] = e;\n\n                // Start expunge at preceding stale entry if it exists\n                if (slotToExpunge == staleSlot)\n                    slotToExpunge = i;\n                cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n                return;\n            }\n\n            // If we didn't find stale entry on backward scan, the\n            // first stale entry seen while scanning for key is the\n            // first still present in the run.\n            if (k == null && slotToExpunge == staleSlot)\n                slotToExpunge = i;\n        }\n\n        // If key not found, put new entry in stale slot\n        tab[staleSlot].value = null;\n        tab[staleSlot] = new Entry(key, value);\n\n        // If there are any other stale entries in run, expunge them\n        if (slotToExpunge != staleSlot)\n            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n    }\n"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\u5047\u5b9a\u6563\u5217\u6570\u7ec4\u4e0b\u6807\u4e3a ",(0,a.jsx)(n.code,{children:"7"})," \u4f4d\u7f6e\u5bf9\u5e94\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e ",(0,a.jsx)(n.code,{children:"key"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \uff1a"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(65969).A+"",width:"1318",height:"404"})}),"\n",(0,a.jsxs)(n.ol,{start:"2",children:["\n",(0,a.jsxs)(n.li,{children:["\u4ee5\u5f53\u524d ",(0,a.jsx)(n.code,{children:"staleSlot"})," \u5f00\u59cb\u5411\u524d\u8fed\u4ee3\u67e5\u627e\uff0c\u627e\u5176\u4ed6\u8fc7\u671f\u7684\u6570\u636e\uff0c\u7136\u540e\u66f4\u65b0\u8fc7\u671f\u6570\u636e\u8d77\u59cb\u626b\u63cf\u4e0b\u6807 ",(0,a.jsx)(n.code,{children:"slotToExpunge"})," \u3002",(0,a.jsx)(n.code,{children:"for"})," \u5faa\u73af\u8fed\u4ee3\uff0c\u76f4\u5230\u78b0\u5230 ",(0,a.jsx)(n.code,{children:"Entry"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u7ed3\u675f\u3002\u521d\u59cb\u5316\u63a2\u6d4b\u5f0f\u6e05\u7406\u8fc7\u671f\u6570\u636e\u626b\u63cf\u7684\u5f00\u59cb\u4f4d\u7f6e\uff1a",(0,a.jsx)(n.code,{children:"slotToExpunge = staleSlot = 7"})," \u3002\u4ee5\u5f53\u524d\u8282\u70b9(",(0,a.jsx)(n.code,{children:"index=7"}),")\u5411\u524d\u8fed\u4ee3\uff0c\u68c0\u6d4b\u662f\u5426\u6709\u8fc7\u671f\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e\uff0c\u5982\u679c\u6709\u5219\u66f4\u65b0 ",(0,a.jsx)(n.code,{children:"slotToExpunge"})," \u503c\u3002\u78b0\u5230 ",(0,a.jsx)(n.code,{children:"null"})," \u5219\u7ed3\u675f\u63a2\u6d4b\u3002\u4ee5\u4e0a\u56fe\u4e3a\u4f8b ",(0,a.jsx)(n.code,{children:"slotToExpunge"})," \u88ab\u66f4\u65b0\u4e3a ",(0,a.jsx)(n.code,{children:"0"})," \u3002"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(51752).A+"",width:"1347",height:"470"})}),"\n",(0,a.jsxs)(n.ol,{start:"3",children:["\n",(0,a.jsxs)(n.li,{children:["\u63a5\u7740\u5f00\u59cb\u4ee5 ",(0,a.jsx)(n.code,{children:"staleSlot"})," \u4f4d\u7f6e(",(0,a.jsx)(n.code,{children:"index=7"}),")\u5411\u540e\u8fed\u4ee3\uff0c\u5982\u679c\u627e\u5230\u4e86\u76f8\u540c ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e\uff1a"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(53379).A+"",width:"1353",height:"487"})}),"\n",(0,a.jsxs)(n.ol,{start:"4",children:["\n",(0,a.jsxs)(n.li,{children:["\u4ece\u5f53\u524d\u8282\u70b9 ",(0,a.jsx)(n.code,{children:"staleSlot"})," \u5411\u540e\u67e5\u627e ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u76f8\u7b49\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u5143\u7d20\uff0c\u627e\u5230\u540e\u66f4\u65b0 ",(0,a.jsx)(n.code,{children:"Entry"})," \u7684\u503c\u5e76\u4ea4\u6362 ",(0,a.jsx)(n.code,{children:"staleSlot"})," \u5143\u7d20\u7684\u4f4d\u7f6e( ",(0,a.jsx)(n.code,{children:"staleSlot"})," \u4f4d\u7f6e\u4e3a\u8fc7\u671f\u5143\u7d20)\uff0c\u66f4\u65b0 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e\uff0c\u7136\u540e\u5f00\u59cb\u8fdb\u884c\u8fc7\u671f ",(0,a.jsx)(n.code,{children:"Entry"})," \u7684\u6e05\u7406\u5de5\u4f5c\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(35802).A+"",width:"1336",height:"361"})}),"\n",(0,a.jsxs)(n.ol,{start:"5",children:["\n",(0,a.jsxs)(n.li,{children:["\u5411\u540e\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u6ca1\u6709\u627e\u5230\u76f8\u540c ",(0,a.jsx)(n.code,{children:"key"})," \u503c\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e\uff0c\u76f4\u5230 ",(0,a.jsx)(n.code,{children:"Entry"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u5219\u505c\u6b62\u5bfb\u627e\u3002\u521b\u5efa\u65b0\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \uff0c\u66ff\u6362 ",(0,a.jsx)(n.code,{children:"table[stableSlot]"})," \u4f4d\u7f6e\uff1a"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.img,{src:l(35661).A+"",width:"1336",height:"397"}),"\n",(0,a.jsx)(n.img,{src:l(95716).A+"",width:"1341",height:"398"})]}),"\n",(0,a.jsx)(n.h5,{id:"expungestaleentry",children:"expungeStaleEntry()"}),"\n",(0,a.jsxs)(n.p,{children:["\u63a2\u6d4b\u5f0f\u6e05\u7406 ",(0,a.jsx)(n.code,{children:"expungeStaleEntry"})," \u65b9\u6cd5\uff0c\u904d\u5386\u6563\u5217\u6570\u7ec4\uff0c\u4ece\u5f00\u59cb\u4f4d\u7f6e\u5411\u540e\u63a2\u6d4b\u6e05\u7406\u8fc7\u671f\u6570\u636e\uff0c\u5c06\u8fc7\u671f\u6570\u636e\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u8bbe\u7f6e\u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \uff0c\u6cbf\u9014\u4e2d\u78b0\u5230\u672a\u8fc7\u671f\u7684\u6570\u636e\u5219\u5c06\u6b64\u6570\u636e ",(0,a.jsx)(n.code,{children:"rehash"})," \u540e\u91cd\u65b0\u5728 ",(0,a.jsx)(n.code,{children:"table"})," \u6570\u7ec4\u4e2d\u5b9a\u4f4d\uff0c\u5982\u679c\u5b9a\u4f4d\u7684\u4f4d\u7f6e\u5df2\u7ecf\u6709\u4e86\u6570\u636e\uff0c\u5219\u4f1a\u5c06\u672a\u8fc7\u671f\u7684\u6570\u636e\u653e\u5230\u6700\u9760\u8fd1\u6b64\u4f4d\u7f6e\u7684 ",(0,a.jsx)(n.code,{children:"Entry=null"})," \u7684\u6876\u4e2d\uff0c\u4f7f ",(0,a.jsx)(n.code,{children:"rehash"})," \u540e\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e\u8ddd\u79bb\u6b63\u786e\u7684\u6876\u7684\u4f4d\u7f6e\u66f4\u8fd1\u4e00\u4e9b\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"    private int expungeStaleEntry(int staleSlot) {\n        Entry[] tab = table;\n        int len = tab.length;\n\n        // expunge entry at staleSlot\n        tab[staleSlot].value = null;\n        tab[staleSlot] = null;\n        size--;\n\n        // Rehash until we encounter null\n        Entry e;\n        int i;\n        for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {\n            ThreadLocal<?> k = e.get();\n            if (k == null) {\n                e.value = null;\n                tab[i] = null;\n                size--;\n            } else {\n                int h = k.threadLocalHashCode & (len - 1);\n                if (h != i) {\n                    tab[i] = null;\n                    // Unlike Knuth 6.4 Algorithm R, we must scan until\n                    // null because multiple entries could have been stale.\n                    while (tab[h] != null)\n                        h = nextIndex(h, len);\n                    tab[h] = e;\n                }\n            }\n        }\n        return i;\n    }\n"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\u5982\u4e0b\u56fe\uff0c",(0,a.jsx)(n.code,{children:"set(27)"})," \u7ecf\u8fc7 ",(0,a.jsx)(n.code,{children:"hash"})," \u8ba1\u7b97\u540e\u5e94\u8be5\u843d\u5230 ",(0,a.jsx)(n.code,{children:"index=4"})," \u7684\u6876\u4e2d\uff0c\u7531\u4e8e ",(0,a.jsx)(n.code,{children:"index=4"})," \u6876\u5df2\u7ecf\u6709\u4e86\u6570\u636e\uff0c\u6240\u4ee5\u5f80\u540e\u8fed\u4ee3\u6700\u7ec8\u6570\u636e\u653e\u5165\u5230 ",(0,a.jsx)(n.code,{children:"index=7"})," \u7684\u6876\u4e2d\uff0c\u653e\u5165\u540e\u4e00\u6bb5\u65f6\u95f4\u540e ",(0,a.jsx)(n.code,{children:"index=5"})," \u4e2d\u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e ",(0,a.jsx)(n.code,{children:"key"})," \u53d8\u4e3a\u4e86 ",(0,a.jsx)(n.code,{children:"null"})," \u3002\u5982\u679c\u518d\u6709\u5176\u4ed6\u6570\u636e ",(0,a.jsx)(n.code,{children:"set"})," \u5230 ",(0,a.jsx)(n.code,{children:"map"})," \u4e2d\uff0c\u5c31\u4f1a\u89e6\u53d1\u63a2\u6d4b\u5f0f\u6e05\u7406\u64cd\u4f5c\u3002"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(41288).A+"",width:"1373",height:"324"})}),"\n",(0,a.jsxs)(n.ol,{start:"2",children:["\n",(0,a.jsxs)(n.li,{children:["\u6267\u884c\u63a2\u6d4b\u5f0f\u6e05\u7406\u540e\uff0c",(0,a.jsx)(n.code,{children:"index=5"})," \u7684\u6570\u636e\u88ab\u6e05\u7406\u6389\uff0c\u7ee7\u7eed\u5f80\u540e\u8fed\u4ee3\uff0c\u5230 ",(0,a.jsx)(n.code,{children:"index=7"})," \u7684\u5143\u7d20\u65f6\uff0c\u7ecf\u8fc7 ",(0,a.jsx)(n.code,{children:"rehash"})," \u540e\u53d1\u73b0\u8be5\u5143\u7d20\u6b63\u786e\u7684 ",(0,a.jsx)(n.code,{children:"index=4"})," \uff0c\u800c\u6b64\u4f4d\u7f6e\u5df2\u7ecf\u6709\u4e86\u6570\u636e\uff0c\u5f80\u540e\u67e5\u627e\u79bb ",(0,a.jsx)(n.code,{children:"index=4"})," \u6700\u8fd1\u7684 ",(0,a.jsx)(n.code,{children:"Entry=null"})," \u7684\u8282\u70b9(\u521a\u88ab\u63a2\u6d4b\u5f0f\u6e05\u7406\u6389\u7684\u6570\u636e\uff1a",(0,a.jsx)(n.code,{children:"index=5"})," )\uff0c\u627e\u5230\u540e\u79fb\u52a8 ",(0,a.jsx)(n.code,{children:"index=7"})," \u7684\u6570\u636e\u5230 ",(0,a.jsx)(n.code,{children:"index=5"})," \u4e2d\uff0c\u6b64\u65f6\u6876\u7684\u4f4d\u7f6e\u79bb\u6b63\u786e\u7684\u4f4d\u7f6e ",(0,a.jsx)(n.code,{children:"index=4"})," \u66f4\u8fd1\u4e86\u3002\u7ecf\u8fc7\u4e00\u8f6e\u63a2\u6d4b\u5f0f\u6e05\u7406\u540e\uff0c ",(0,a.jsx)(n.code,{children:"key"})," \u8fc7\u671f\u7684\u6570\u636e\u4f1a\u88ab\u6e05\u7406\u6389\uff0c\u6ca1\u8fc7\u671f\u7684\u6570\u636e\u7ecf\u8fc7 ",(0,a.jsx)(n.code,{children:"rehash"})," \u91cd\u5b9a\u4f4d\u540e\u6240\u5904\u7684\u6876\u4f4d\u7f6e\u7406\u8bba\u4e0a\u66f4\u63a5\u8fd1 ",(0,a.jsx)(n.code,{children:"i = key.hashCode & (tab.len - 1)"})," \u7684\u4f4d\u7f6e\u3002\u8fd9\u79cd\u4f18\u5316\u4f1a\u63d0\u9ad8\u6574\u4e2a\u6563\u5217\u8868\u67e5\u8be2\u6027\u80fd\u3002"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(78147).A+"",width:"1351",height:"384"})}),"\n",(0,a.jsx)(n.h4,{id:"\u542f\u53d1\u5f0f\u6e05\u7406",children:"\u542f\u53d1\u5f0f\u6e05\u7406"}),"\n",(0,a.jsxs)(n.p,{children:["\u63a2\u6d4b\u5f0f\u6e05\u7406\u662f\u4ee5\u5f53\u524d ",(0,a.jsx)(n.code,{children:"Entry"})," \u5f80\u540e\u6e05\u7406\uff0c\u9047\u5230\u503c\u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u5219\u7ed3\u675f\u6e05\u7406\uff0c\u5c5e\u4e8e\u7ebf\u6027\u63a2\u6d4b\u6e05\u7406\u3002\u800c\u542f\u53d1\u5f0f\u6e05\u7406\u88ab\u4f5c\u8005\u5b9a\u4e49\u4e3a\uff1a",(0,a.jsx)(n.code,{children:"Heuristically scan some cells looking for stale entries."}),"\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"    private boolean cleanSomeSlots(int i, int n) {\n        boolean removed = false;\n        Entry[] tab = table;\n        int len = tab.length;\n        do {\n            i = nextIndex(i, len);\n            Entry e = tab[i];\n            if (e != null && e.get() == null) {\n                n = len;\n                removed = true;\n                i = expungeStaleEntry(i);\n            }\n        } while ( (n >>>= 1) != 0);\n        return removed;\n    }\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(15098).A+"",width:"1434",height:"924"})}),"\n",(0,a.jsx)(n.h3,{id:"threadlocalmap\u6269\u5bb9\u673a\u5236",children:"ThreadLocalMap\u6269\u5bb9\u673a\u5236"}),"\n",(0,a.jsxs)(n.p,{children:["\u5728 ",(0,a.jsx)(n.code,{children:"ThreadLocalMap.set()"})," \u65b9\u6cd5\u7684\u6700\u540e\uff0c\u5982\u679c\u6267\u884c\u5b8c\u542f\u53d1\u5f0f\u6e05\u7406\u5de5\u4f5c\u540e\uff0c\u672a\u6e05\u7406\u5230\u4efb\u4f55\u6570\u636e\uff0c\u4e14\u5f53\u524d\u6563\u5217\u6570\u7ec4\u4e2d ",(0,a.jsx)(n.code,{children:"Entry"})," \u7684\u6570\u91cf\u5df2\u7ecf\u8fbe\u5230\u4e86\u5217\u8868\u7684\u6269\u5bb9\u9608\u503c(",(0,a.jsx)(n.code,{children:"len*2/3"}),")\uff0c\u5c31\u5f00\u59cb\u6267\u884c ",(0,a.jsx)(n.code,{children:"rehash()"})," \u903b\u8f91\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"    private void set(ThreadLocal<?> key, Object value) {\n        // ...\n        if (!cleanSomeSlots(i, sz) && sz >= threshold)\n            rehash();\n    }\n\n    private void rehash() {\n        expungeStaleEntries();\n        // Use lower threshold for doubling to avoid hysteresis\n        if (size >= threshold - threshold / 4)\n            resize();\n    }\n\n    private void expungeStaleEntries() {\n        Entry[] tab = table;\n        int len = tab.length;\n        for (int j = 0; j < len; j++) {\n            Entry e = tab[j];\n            if (e != null && e.get() == null)\n                expungeStaleEntry(j);\n        }\n    }\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5728 ",(0,a.jsx)(n.code,{children:"expungeStaleEntries()"})," \u65b9\u6cd5\u4e2d\u4f1a\u8fdb\u884c\u63a2\u6d4b\u5f0f\u6e05\u7406\u5de5\u4f5c\uff0c\u4ece ",(0,a.jsx)(n.code,{children:"table"})," \u7684\u8d77\u59cb\u4f4d\u7f6e\u5f80\u540e\u6e05\u7406\uff0c\u4e0a\u9762\u6709\u5206\u6790\u6e05\u7406\u7684\u8be6\u7ec6\u6d41\u7a0b\u3002\u6e05\u7406\u5b8c\u6210\u4e4b\u540e\uff0c ",(0,a.jsx)(n.code,{children:"table\u4e2d"})," \u53ef\u80fd\u6709\u4e00\u4e9b ",(0,a.jsx)(n.code,{children:"key"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u7684 ",(0,a.jsx)(n.code,{children:"Entry"})," \u6570\u636e\u88ab\u6e05\u7406\u6389\uff0c\u6240\u4ee5\u6b64\u65f6\u901a\u8fc7\u5224\u65ad ",(0,a.jsx)(n.code,{children:"size >= threshold - threshold / 4"})," \u4e5f\u5c31\u662f ",(0,a.jsx)(n.code,{children:"size >= threshold * 3/4"})," \u6765\u51b3\u5b9a\u662f\u5426\u6269\u5bb9\u3002\u6211\u4eec\u8fd8\u8bb0\u5f97\u4e0a\u9762\u8fdb\u884c ",(0,a.jsx)(n.code,{children:"rehash()"})," \u7684\u9608\u503c\u662f ",(0,a.jsx)(n.code,{children:"size >= threshold"}),"\uff0c\u8fd9\u4e24\u4e2a\u9608\u503c\u5bb9\u6613\u6df7\u6dc6\uff0c\u6240\u4ee5\u4e00\u5b9a\u8981\u6e05\u695a\u8fd9\u4e24\u4e2a\u7684\u533a\u522b\uff1a"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l(33882).A+"",width:"1483",height:"511"})}),"\n",(0,a.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\u5c31\u662f\u6700\u5173\u952e\u7684\u6269\u5bb9\u65b9\u6cd5\u7684\u5b9e\u73b0\u4e86\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"    private void resize() {\n        Entry[] oldTab = table;\n        int oldLen = oldTab.length;\n        int newLen = oldLen * 2;\n        Entry[] newTab = new Entry[newLen];\n        int count = 0;\n\n        for (int j = 0; j < oldLen; ++j) {\n            Entry e = oldTab[j];\n            if (e != null) {\n                ThreadLocal<?> k = e.get();\n                if (k == null) {\n                    e.value = null; // Help the GC\n                } else {\n                    int h = k.threadLocalHashCode & (newLen - 1);\n                    while (newTab[h] != null)\n                        h = nextIndex(h, newLen);\n                    newTab[h] = e;\n                    count++;\n                }\n            }\n        }\n\n        setThreshold(newLen);\n        size = count;\n        table = newTab;\n    }\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u6269\u5bb9\u540e\u7684 ",(0,a.jsx)(n.code,{children:"tab"})," \u7684\u5927\u5c0f\u4e3a ",(0,a.jsx)(n.code,{children:"oldLen * 2"})," \uff0c\u63a5\u7740\u904d\u5386\u8001\u7684\u6563\u5217\u8868\uff0c\u91cd\u65b0\u8ba1\u7b97 ",(0,a.jsx)(n.code,{children:"hash"})," \u4f4d\u7f6e\uff0c\u7136\u540e\u653e\u5230\u65b0\u7684 ",(0,a.jsx)(n.code,{children:"tab"})," \u6570\u7ec4\u4e2d\uff0c\u5982\u679c\u51fa\u73b0 ",(0,a.jsx)(n.code,{children:"hash"})," \u51b2\u7a81\u5219\u5f80\u540e\u5bfb\u627e\u6700\u8fd1\u7684 ",(0,a.jsx)(n.code,{children:"entry"})," \u4e3a ",(0,a.jsx)(n.code,{children:"null"})," \u7684\u69fd\u4f4d\uff0c\u904d\u5386\u5b8c\u6210\u4e4b\u540e\uff0c ",(0,a.jsx)(n.code,{children:"oldTab"})," \u4e2d\u6240\u6709\u7684 ",(0,a.jsx)(n.code,{children:"entry"})," \u6570\u636e\u90fd\u5df2\u7ecf\u653e\u5165\u5230\u65b0\u7684 ",(0,a.jsx)(n.code,{children:"tab"})," \u4e2d\u4e86\u3002\u91cd\u65b0\u8ba1\u7b97 ",(0,a.jsx)(n.code,{children:"tab"})," \u4e0b\u6b21\u6269\u5bb9\u7684\u9608\u503c\u3002"]}),"\n",(0,a.jsx)(n.h2,{id:"threadlocal\u7684\u591a\u7ebf\u7a0b\u7ee7\u627f",children:"ThreadLocal\u7684\u591a\u7ebf\u7a0b\u7ee7\u627f"}),"\n",(0,a.jsxs)(n.p,{children:["\u6709\u4e9b\u4e1a\u52a1\u573a\u666f\u9700\u8981\u5728\u591a\u7ebf\u7a0b\u4e4b\u524d\u4f20\u9012 ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u7684\u503c\uff0c\u4f8b\u5982\uff1a"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7cfb\u7edf \u6216 \u5168\u94fe\u8def\u538b\u6d4b\uff08\u5373\u94fe\u8def\u6253\u6807\uff09"}),"\n",(0,a.jsx)(n.li,{children:"\u65e5\u5fd7\u6536\u96c6\u8bb0\u5f55\u7cfb\u7edf\u4e0a\u4e0b\u6587"}),"\n",(0,a.jsx)(n.li,{children:"Session\u7ea7Cache"}),"\n",(0,a.jsx)(n.li,{children:"\u5e94\u7528\u5bb9\u5668\u6216\u4e0a\u5c42\u6846\u67b6\u8de8\u5e94\u7528\u4ee3\u7801\u7ed9\u4e0b\u5c42SDK\u4f20\u9012\u4fe1\u606f"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"inheritablethreadlocal",children:"InheritableThreadLocal"}),"\n",(0,a.jsxs)(n.p,{children:["\u6211\u4eec\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u7684\u65f6\u5019\uff0c\u5728\u5f02\u6b65\u573a\u666f\u4e0b\u662f\u65e0\u6cd5\u7ed9\u5b50\u7ebf\u7a0b\u5171\u4eab\u7236\u7ebf\u7a0b\u4e2d\u521b\u5efa\u7684\u7ebf\u7a0b\u526f\u672c\u6570\u636e\u7684\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cJDK \u4e2d\u8fd8\u6709\u4e00\u4e2a ",(0,a.jsx)(n.code,{children:"InheritableThreadLocal"})," \u7c7b\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5176\u5b9e\u73b0\u539f\u7406\u662f\u5b50\u7ebf\u7a0b\u662f\u901a\u8fc7\u5728\u7236\u7ebf\u7a0b\u4e2d\u901a\u8fc7\u8c03\u7528 ",(0,a.jsx)(n.code,{children:"new Thread()"})," \u65b9\u6cd5\u6765\u521b\u5efa\u5b50\u7ebf\u7a0b\uff0c",(0,a.jsx)(n.code,{children:"Thread#init"})," \u65b9\u6cd5\u5728 ",(0,a.jsx)(n.code,{children:"Thread"})," \u7684\u6784\u9020\u65b9\u6cd5\u4e2d\u88ab\u8c03\u7528\u3002\u5728 ",(0,a.jsx)(n.code,{children:"init"})," \u65b9\u6cd5\u4e2d\u62f7\u8d1d\u7236\u7ebf\u7a0b\u6570\u636e\u5230\u5b50\u7ebf\u7a0b\u4e2d\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'private void init(ThreadGroup g, Runnable target, String name,\n                      long stackSize, AccessControlContext acc,\n                      boolean inheritThreadLocals) {\n    if (name == null) {\n        throw new NullPointerException("name cannot be null");\n    }\n\n    if (inheritThreadLocals && parent.inheritableThreadLocals != null)\n        this.inheritableThreadLocals =\n            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);\n    this.stackSize = stackSize;\n    tid = nextThreadID();\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u4f46 ",(0,a.jsx)(n.code,{children:"InheritableThreadLocal"})," \u4ecd\u7136\u6709\u7f3a\u9677\uff0c\u4e00\u822c\u6211\u4eec\u505a\u5f02\u6b65\u5316\u5904\u7406\u90fd\u662f\u4f7f\u7528\u7684\u7ebf\u7a0b\u6c60\uff0c\u800c ",(0,a.jsx)(n.code,{children:"InheritableThreadLocal"})," \u662f\u5728new ",(0,a.jsx)(n.code,{children:"Thread"})," \u4e2d\u7684 ",(0,a.jsx)(n.code,{children:"init()"})," \u65b9\u6cd5\u7ed9\u8d4b\u503c\u7684\uff0c\u800c\u7ebf\u7a0b\u6c60\u662f\u7ebf\u7a0b\u590d\u7528\u7684\u903b\u8f91\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f1a\u5b58\u5728\u95ee\u9898\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5f53\u7136\uff0c\u6709\u95ee\u9898\u51fa\u73b0\u5c31\u4f1a\u6709\u89e3\u51b3\u95ee\u9898\u7684\u65b9\u6848\uff0c\u963f\u91cc\u5df4\u5df4\u5f00\u6e90\u4e86\u4e00\u4e2a ",(0,a.jsx)(n.code,{children:"TransmittableThreadLocal"})," \u7ec4\u4ef6\u5c31\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002"]}),"\n",(0,a.jsx)(n.h3,{id:"transmittablethreadlocal",children:"TransmittableThreadLocal"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"TransmittableThreadLocal(TTL)"}),"\uff0c\u89e3\u51b3\u4e86 ",(0,a.jsx)(n.code,{children:"InheritableThreadLocal"})," \u7684\u4e0d\u8db3\uff0c\u5728\u4f7f\u7528\u7ebf\u7a0b\u6c60\u7b49\u4f1a\u6c60\u5316\u590d\u7528\u7ebf\u7a0b\u7684\u6267\u884c\u7ec4\u4ef6\u60c5\u51b5\u4e0b\uff0c\u63d0\u4f9b ",(0,a.jsx)(n.code,{children:"ThreadLocal"})," \u503c\u7684\u4f20\u9012\u529f\u80fd\uff0c\u5f88\u597d\u5730\u89e3\u51b3\u5f02\u6b65\u6267\u884c\u65f6\u4e0a\u4e0b\u6587\u4f20\u9012\u7684\u95ee\u9898\u3002\u5177\u4f53\u5b9e\u73b0\u53ef\u53c2\u8003",(0,a.jsx)(n.a,{href:"https://github.com/alibaba/transmittable-thread-local",children:"GitHub - alibaba/transmittable-thread-local"}),"\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"ttl\u4f7f\u7528\u6559\u7a0b",children:"TTL\u4f7f\u7528\u6559\u7a0b"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"\u76f4\u63a5\u4f7f\u7528\u65b9\u5f0f\uff1a"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();\n\n// =====================================================\n// \u5728\u7236\u7ebf\u7a0b\u4e2d\u8bbe\u7f6e\ncontext.set("value-set-in-parent");\n\n// =====================================================\n// \u5728\u5b50\u7ebf\u7a0b\u4e2d\u53ef\u4ee5\u8bfb\u53d6\uff0c\u503c\u662f"value-set-in-parent"\nString value = context.get();\n'})}),"\n",(0,a.jsxs)(n.ol,{start:"2",children:["\n",(0,a.jsxs)(n.li,{children:["\u4fee\u9970 ",(0,a.jsx)(n.code,{children:"Runnable"})," \u548c ",(0,a.jsx)(n.code,{children:"Callable"})]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();\n\n// =====================================================\n// \u5728\u7236\u7ebf\u7a0b\u4e2d\u8bbe\u7f6e\ncontext.set("value-set-in-parent");\n\nCallable call = new CallableTask();\n// \u989d\u5916\u7684\u5904\u7406\uff0c\u751f\u6210\u4fee\u9970\u4e86\u7684\u5bf9\u8c61ttlCallable\nCallable ttlCallable = TtlCallable.get(call);\nexecutorService.submit(ttlCallable);\n\n// =====================================================\n// Call\u4e2d\u53ef\u4ee5\u8bfb\u53d6\uff0c\u503c\u662f"value-set-in-parent"\nString value = context.get();\n'})}),"\n",(0,a.jsxs)(n.ol,{start:"3",children:["\n",(0,a.jsx)(n.li,{children:"\u4fee\u9970\u7ebf\u7a0b\u6c60"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'ExecutorService executorService = ...\n// \u989d\u5916\u7684\u5904\u7406\uff0c\u751f\u6210\u4fee\u9970\u4e86\u7684\u5bf9\u8c61executorService\nexecutorService = TtlExecutors.getTtlExecutorService(executorService);\n\nTransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();\n\n// =====================================================\n// \u5728\u7236\u7ebf\u7a0b\u4e2d\u8bbe\u7f6e\ncontext.set("value-set-in-parent");\n\nRunnable task = new RunnableTask();\nCallable call = new CallableTask();\nexecutorService.submit(task);\nexecutorService.submit(call);\n\n// =====================================================\n// Task\u6216\u662fCall\u4e2d\u53ef\u4ee5\u8bfb\u53d6\uff0c\u503c\u662f"value-set-in-parent"\nString value = context.get();\n'})}),"\n",(0,a.jsxs)(n.ol,{start:"4",children:["\n",(0,a.jsx)(n.li,{children:"Java Agent \u4fee\u9970"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"java -javaagent:path/to/transmittable-thread-local-2.x.y.jar \\\n    -cp classes \\\n    com.alibaba.demo.ttl.agent.AgentDemo\n\n# \u5982\u679c\u4fee\u6539\u4e86TTL jar\u6587\u4ef6\u540d \u6216 TTL\u7248\u672c\u662f 2.6.0 \u4e4b\u524d\n# \u5219\u8fd8\u9700\u8981\u663e\u5f0f\u8bbe\u7f6e -Xbootclasspath \u53c2\u6570\njava -javaagent:path/to/ttl-foo-name-changed.jar \\\n    -Xbootclasspath/a:path/to/ttl-foo-name-changed.jar \\\n    -cp classes \\\n    com.alibaba.demo.ttl.agent.AgentDemo\n\njava -javaagent:path/to/transmittable-thread-local-2.5.1.jar \\\n    -Xbootclasspath/a:path/to/transmittable-thread-local-2.5.1.jar \\\n    -cp classes \\\n    com.alibaba.demo.ttl.agent.AgentDemo\n"})}),"\n",(0,a.jsx)(n.h4,{id:"\u6838\u5fc3\u539f\u7406\u4ecb\u7ecd",children:"\u6838\u5fc3\u539f\u7406\u4ecb\u7ecd"}),"\n",(0,a.jsx)(n.h2,{id:"\u53c2\u8003\u8d44\u6599",children:"\u53c2\u8003\u8d44\u6599"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://javaguide.cn/java/concurrent/threadlocal.html",children:"JavaGuide - ThreadLocal\u8be6\u89e3"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://mp.weixin.qq.com/s/jEx-4XhNGOFdCo4Nou5tqg",children:"\u5fae\u4fe1\u516c\u4f17\u53f7 - Java AQS \u6838\u5fc3\u6570\u636e\u7ed3\u6784-CLH \u9501"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/alibaba/transmittable-thread-local",children:"GitHub - alibaba/transmittable-thread-local"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://blog.csdn.net/thewindkee/article/details/103726942",children:"CSDN - \u6d4b\u8bd5ThreadLocal \u5728gc\u540e\u5f15\u53d1\u7684threadLocalMap\u7684key\u4e3anull,\u4f46value\u4e0d\u4e3anull\u7684\u60c5\u51b5"})}),"\n"]})]})}function o(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},15098:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-clean-d73bf3240db5dd24c14133673f618fd3.png"},8574:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-ds-9857d8f72f372fd2c5c069a18b7accc5.png"},41288:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-expunge1-828ec51c26f66e55e23786ebcdc5e909.png"},78147:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-expunge2-23cda18419a3772313579c5fa2905fbc.png"},39520:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-get1-ea9900f7efba7c7d09f2df6320ac9d3c.png"},17851:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-get2-d91c72392473824b8d37c1fc0ae36abe.png"},3026:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-get3-48c3ca24f0be428e4ebdf3a91ca62169.png"},45925:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-hash-601f960a52c6c768c279bedc3c812061.png"},66485:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-reference-c242531ae24cbafd1d46a8ac02aaf938.png"},45802:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-reference2-577698b5a089874ccf4609f2f6df90cc.png"},33882:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-rehash-8dec85c79dc9cb1a63f7ab7e320b3a08.png"},23212:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-set1-949ccef106e922736e1ff4f37cade946.png"},43271:(e,n,l)=>{l.d(n,{A:()=>a});const a="data:image/png;base64,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"},24958:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-set3-d879925a28d2b7ae12f956102e91b80d.png"},65969:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-set4-a46c954c3aca3cb2c721154bd3e21cbd.png"},51752:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-set5-04938e81b989cb899294c4eb7ac76132.png"},53379:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-set6-0cc82dcaa85c79c309ccebd9c37612ae.png"},35802:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-set7-0521d1c53ba9810f37cb5597a4e2ece6.png"},35661:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-set8-973320a4d5dcefba1958f5a2bcc13e21.png"},95716:(e,n,l)=>{l.d(n,{A:()=>a});const a=l.p+"assets/images/threadlocal-set9-da17ad7c7e7e9b52a79620ab358a41d6.png"},28453:(e,n,l)=>{l.d(n,{R:()=>d,x:()=>s});var a=l(96540);const c={},r=a.createContext(c);function d(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:d(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);