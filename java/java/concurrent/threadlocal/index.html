<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-java docs-version-current docs-doc-page docs-doc-id-java/concurrent/threadlocal" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">ThreadLocal | Vyckey Computer Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://hoily.site/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://hoily.site/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://hoily.site/java/java/concurrent/threadlocal"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-java-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-java-current"><meta data-rh="true" property="og:title" content="ThreadLocal | Vyckey Computer Notes"><meta data-rh="true" name="description" content="介绍"><meta data-rh="true" property="og:description" content="介绍"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="http://hoily.site/java/java/concurrent/threadlocal"><link data-rh="true" rel="alternate" href="http://hoily.site/java/java/concurrent/threadlocal" hreflang="en"><link data-rh="true" rel="alternate" href="http://hoily.site/java/java/concurrent/threadlocal" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Vyckey Computer Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Vyckey Computer Notes Atom Feed"><link rel="stylesheet" href="/assets/css/styles.500dd4b8.css">
<script src="/assets/js/runtime~main.f9b04792.js" defer="defer"></script>
<script src="/assets/js/main.02b7b6d4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.jpeg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.jpeg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Vyckey Notes</b></a><a class="navbar__item navbar__link" href="/docs/">Computer</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/database">Database</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/database/mysql">MySQL</a></li><li><a class="dropdown__link" href="/database/redis">Redis</a></li><li><a class="dropdown__link" href="/database/elasticsearch">ES</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/java">Java</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/middleware">Middleware</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/middleware/rpc/dubbo">Dubbo</a></li><li><a class="dropdown__link" href="/middleware/mq/kafka">Kafka</a></li></ul></div><a class="navbar__item navbar__link" href="/bigdata">Bigdata</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/ai">AI</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/ai/deeplearning/transformer">Transformer</a></li><li><a class="dropdown__link" href="/ai/deeplearning/models">Models</a></li></ul></div><a class="navbar__item navbar__link" href="/frontend">Frontend</a><a class="navbar__item navbar__link" href="/material">Material</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/vyckey/vyckey-computer-notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/java/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/java/java/">Java</a><button aria-label="Collapse sidebar category &#x27;Java&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/java/java/collection/">Collection</a><button aria-label="Expand sidebar category &#x27;Collection&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/io/">IO</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/java/java/concurrent/">Concurrent</a><button aria-label="Collapse sidebar category &#x27;Concurrent&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/atomic">Atomic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/completablefuture">CompletableFuture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/lock">Lock</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/thread">Thread</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/java/java/concurrent/threadlocal">ThreadLocal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/transmittable_threadlocal">Transimittable ThreadLocal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/aqs">AQS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/program">Program</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/threadpool">ThreadPool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/threadpool_in_action">ThreadPool In Action</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/java/java/jvm/">JVM</a><button aria-label="Expand sidebar category &#x27;JVM&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/java/java/more/jni">more</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/java/java/util/date">util</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/java/framework/">Framework</a><button aria-label="Expand sidebar category &#x27;Framework&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/java/library/">Library</a><button aria-label="Expand sidebar category &#x27;Library&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/java/tools/">Tools</a><button aria-label="Expand sidebar category &#x27;Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/java/java/"><span itemprop="name">Java</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/java/java/concurrent/"><span itemprop="name">Concurrent</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">ThreadLocal</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ThreadLocal</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a href="#介绍" class="hash-link" aria-label="Direct link to 介绍" title="Direct link to 介绍">​</a></h2>
<blockquote>
<p>This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its get or set method) has its own, independently initialized copy of the variable. ThreadLocal instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID).</p>
</blockquote>
<p><code>ThreadLocal</code> 是一个将在多线程中为每一个线程创建单独的变 量副本的类; 当使用 <code>ThreadLocal</code> 来维护变量时, <code>ThreadLocal</code> 会为每个线程创建单独的变量副本, 避免因多线程操作共享变量而导致的数据不一致的情况。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用场景">使用场景<a href="#使用场景" class="hash-link" aria-label="Direct link to 使用场景" title="Direct link to 使用场景">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据结构">数据结构<a href="#数据结构" class="hash-link" aria-label="Direct link to 数据结构" title="Direct link to 数据结构">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocal数据结构">ThreadLocal数据结构<a href="#threadlocal数据结构" class="hash-link" aria-label="Direct link to ThreadLocal数据结构" title="Direct link to ThreadLocal数据结构">​</a></h3>
<p><code>Thread</code> 类有一个类型为 <code>ThreadLocal.ThreadLocalMap</code> 的实例变量 <code>threadLocals</code> ，也就是说每个线程有一个自己的 <code>ThreadLocalMap</code> 。<code>ThreadLocalMap</code> 有自己的独立实现，可以简单地将它的 <code>key</code> 视作 <code>ThreadLocal</code> （实际上 <code>key</code> 并不是 <code>ThreadLocal</code> 本身，而是它的一个弱引用）， <code>value</code> 为代码中放入的值。每个线程在往 <code>ThreadLocal</code> 里放值的时候，都会往自己的 <code>ThreadLocalMap</code> 里存，读也是以 <code>ThreadLocal</code> 作为引用，在自己的 <code>map</code> 里找对应的 <code>key</code> ，从而实现了线程隔离。 <code>ThreadLocalMap</code> 有点类似 <code>HashMap</code> 的结构，只是 <code>HashMap</code> 是由数组+链表实现的，而 <code>ThreadLocalMap</code> 中并没有链表结构。我们还要注意 <code>Entry</code> ， 它的 <code>key</code> 是 <code>ThreadLocal&lt;?&gt; k </code>，继承自 <code>WeakReference</code> ，也就是我们常说的弱引用类型。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-ds-9857d8f72f372fd2c5c069a18b7accc5.png" width="1486" height="1490" class="img_ev3q"></p>
<p>下面是来自 <code>ThreadLocal</code> 的部分核心源码，可以很清晰地看出上图的原理：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Thread</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">map </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ThreadLocalMap</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Entry</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">T</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setInitialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threadLocals</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Thread</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">map </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">createMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> firstValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threadLocals </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadLocalMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> firstValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> m </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocalmap数据结构">ThreadLocalMap数据结构<a href="#threadlocalmap数据结构" class="hash-link" aria-label="Direct link to ThreadLocalMap数据结构" title="Direct link to ThreadLocalMap数据结构">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * The initial capacity -- MUST be a power of two.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">INITIAL_CAPACITY</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * The table, resized as necessary.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * table.length MUST always be a power of two.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * The number of entries in the table.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * The next size value at which to resize.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> threshold</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Default to 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">WeakReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/** The value associated with this ThreadLocal. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Object</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocal的entry设计">ThreadLocal的Entry设计<a href="#threadlocal的entry设计" class="hash-link" aria-label="Direct link to ThreadLocal的Entry设计" title="Direct link to ThreadLocal的Entry设计">​</a></h3>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-reference-c242531ae24cbafd1d46a8ac02aaf938.png" width="1080" height="555" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="为什么entry要使用弱引用">为什么Entry要使用弱引用？<a href="#为什么entry要使用弱引用" class="hash-link" aria-label="Direct link to 为什么Entry要使用弱引用？" title="Direct link to 为什么Entry要使用弱引用？">​</a></h4>
<p>弱引用对象有更短暂的生命周期，不管内存空间是否剩余，都有可能会被回收。</p>
<p>假如每个 <code>key</code> 都强引用指向 <code>ThreadLocal</code> 的对象，也就是上图虚线那里是个强引用，那么这个 <code>ThreadLocal</code> 对象就会因为和 <code>Entry</code> 对象存在强引用关联而无法被GC回收， 造成<strong>内存泄漏</strong>，除非线程结束后，线程被回收了， <code>map</code> 也跟着回收。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="为什么还是会出现内存泄露">为什么还是会出现内存泄露？<a href="#为什么还是会出现内存泄露" class="hash-link" aria-label="Direct link to 为什么还是会出现内存泄露？" title="Direct link to 为什么还是会出现内存泄露？">​</a></h4>
<p>当把 <code>ThreadLocal</code> 对象的引用置为 <code>null</code> 后，没有任何强引用指向内存中的 <code>ThreadLocal</code> 实例，<code>threadLocals</code> 的 <code>key</code> 是它的弱引用，故它将会被GC回收。</p>
<p>但线程中 <code>threadLocals</code> 里的 <code>value</code> 却没有被回收，因为存在着一条从当前线程对象连接过来的强引用，且因为无法再通过 <code>ThreadLocal</code> 对象的 <code>get</code> 方法获取到这个 <code>value</code> ，它永远不会被访问到了，所以还存在内存泄漏问题。
同样的，只有在当前线程结束后，线程对象的引用不再存在于栈中，强引用断开，内存中的 Current <code>Thread</code>、<code>ThreadLocalMap</code>、<code>value</code> 才会全部被GC回收。</p>
<p>解决内存泄露的方法：当线程的某个 <code>ThreadLocal</code> 对象使用完了，马上调用 <code>remove</code> 方法，删除 <code>Entry</code> 对象。只要这个线程对象及时被GC回收，这个内存泄露问题影响不大，只发生在 <code>ThreadLocal</code> 对象的引用设为 <code>null</code> 到线程结束的这段时间内。但在使用线程池的时候，线程结束是不会被销毁的，会再次使用，就可能出现真正的内存泄露。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="在-threadlocalget的时候发生gc之后key-是否为null">在 ThreadLocal.get()的时候，发生GC之后，key 是否为null？<a href="#在-threadlocalget的时候发生gc之后key-是否为null" class="hash-link" aria-label="Direct link to 在 ThreadLocal.get()的时候，发生GC之后，key 是否为null？" title="Direct link to 在 ThreadLocal.get()的时候，发生GC之后，key 是否为null？">​</a></h4>
<p>网上有相关的源码调试可以进行测：<a href="https://blog.csdn.net/thewindkee/article/details/103726942" target="_blank" rel="noopener noreferrer">CSDN - 测试ThreadLocal 在gc后引发的threadLocalMap的key为null,但value不为null的情况</a>。</p>
<p><code>ThreadLocal.get()</code> 操作， <code>ThreadLocal</code> 的对象引用被Stack持有，此时还是有强引用存在的，所以 <code>key</code> 并不为 <code>null</code> ，也就是不会被GC回收，如下图所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-reference2-577698b5a089874ccf4609f2f6df90cc.png" width="1219" height="394" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocal底层实现">ThreadLocal底层实现<a href="#threadlocal底层实现" class="hash-link" aria-label="Direct link to ThreadLocal底层实现" title="Direct link to ThreadLocal底层实现">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocal的hash算法">ThreadLocal的Hash算法<a href="#threadlocal的hash算法" class="hash-link" aria-label="Direct link to ThreadLocal的Hash算法" title="Direct link to ThreadLocal的Hash算法">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> threadLocalHashCode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextHashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">AtomicInteger</span><span class="token plain"> nextHashCode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicInteger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HASH_INCREMENT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x61c88647</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextHashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> nextHashCode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getAndAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">HASH_INCREMENT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ThreadLocalMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> firstKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> firstValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">INITIAL_CAPACITY</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Entry偏移量hash计算方式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> firstKey</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threadLocalHashCode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">INITIAL_CAPACITY</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">firstKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> firstValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">setThreshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">INITIAL_CAPACITY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>ThreadLocalMap</code> 中hash算法很简单，<code>firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1)</code> 的值就是当前 <code>key</code> 在散列表中对应的数组下标位置。</p>
<p>每当创建一个 <code>ThreadLocal</code> 对象，这个 <code>ThreadLocal.nextHashCode</code> 这个值就会增长 <code>0x61c88647</code> 。这个值是<strong>斐波那契数</strong>，也叫<strong>黄金分割数</strong>，可以使散列效果非常好。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocalmap的hash冲突">ThreadLocalMap的Hash冲突<a href="#threadlocalmap的hash冲突" class="hash-link" aria-label="Direct link to ThreadLocalMap的Hash冲突" title="Direct link to ThreadLocalMap的Hash冲突">​</a></h3>
<p>虽然 <code>ThreadLocalMap</code> 中使用了黄金分割数来作为 <code>hash</code> 计算因子，大大减少了 <code>hash</code> 冲突的概率，但是仍然会存在冲突。<code>HashMap</code> 中解决冲突的方法是在数组上构造一个链表结构，冲突的数据挂载到链表上，如果链表长度超过一定数量则会转化成红黑树。而 <code>ThreadLocalMap</code> 中并没有链表结构，所以这里不能使用 <code>HashMap</code> 解决冲突的方式了。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-hash-601f960a52c6c768c279bedc3c812061.png" width="1478" height="424" class="img_ev3q"></p>
<blockquote>
<p>注明：示例  图中，绿色块Entry代表正常数据，灰色块代表Entry的key值为null，已被垃圾回收。白色块表示Entry为null。</p>
</blockquote>
<p>如上图所示，如果我们插入一个 <code>value=27</code> 的数据，通过 <code>hash</code> 计算后应该落入槽位 <code>4</code> 中，而槽位 <code>4</code> 已经有了 <code>Entry</code> 数据。此时就会线性向后查找，一直找到 <code>Entry</code> 为 <code>null</code> 的槽位才会停止查找，将当前元素放入此槽位中。当然迭代过程中还有其他的情况，比如遇到了 <code>Entry</code> 不为 <code>null</code> 且 <code>key</code> 值相等的情况，还有 <code>Entry</code> 中的 <code>key</code> 值为 <code>null</code> 的情况等等都会有不同的处理，后面会一一详细讲解。</p>
<p>这里还画了一个 <code>Entry</code> 中的 <code>key</code> 为 <code>null</code> 的数据（<code>Entry=2</code> 的灰色块数据），因为 <code>key</code> 值是弱引用类型，所以会有这种数据存在。在 <code>set</code> 过程中，如果遇到了 <code>key</code> 过期的 <code>Entry</code> 数据，实际上是会进行一轮探测式清理操作的，具体操作方式后面会讲到。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocalmap的get原理">ThreadLocalMap的get原理<a href="#threadlocalmap的get原理" class="hash-link" aria-label="Direct link to ThreadLocalMap的get原理" title="Direct link to ThreadLocalMap的get原理">​</a></h3>
<p>下面是 <code>ThreadLocalMap.get()</code> 方法的核心代码实现：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threadLocalHashCode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getEntryAfterMiss</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getEntryAfterMiss</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> tab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">expungeStaleEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>第一种情况： 通过查找 <code>key</code> 值计算出散列表中 <code>slot</code> 位置，然后该 <code>slot</code> 位置中的 <code>Entry.key</code> 和查找的 <code>key</code> 一致，则直接返回：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-get1-ea9900f7efba7c7d09f2df6320ac9d3c.png" width="1342" height="404" class="img_ev3q"></p>
<p>第二种情况： <code>slot</code> 位置中的 <code>Entry.key</code> 和要查找的 <code>key</code> 不一致。我们以 <code>get(ThreadLocal1)</code> 为例，通过 <code>hash</code> 计算后，正确的 <code>slot</code> 位置应该是 <code>4</code> ，而 <code>index=4</code> 的槽位已经有了数据，且 <code>key</code> 值不等于 <code>ThreadLocal1</code> ，所以需要继续往后迭代查找。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-get2-d91c72392473824b8d37c1fc0ae36abe.png" width="1288" height="423" class="img_ev3q"></p>
<p>迭代到 <code>index=5</code> 的数据时，此时 <code>Entry.key=null</code> ，触发一次<strong>探测式数据回收</strong>操作，即执行 <code>expungeStaleEntry()</code> 方法（参考后续的介绍），执行完后，<code>index 5,8</code>的数据都会被回收，而<code>index 6,7</code>的数据都会前移。<code>index 6,7</code>前移之后，继续从 <code>index=5</code> 往后迭代，于是就在 <code>index=5</code> 找到了 <code>key</code> 值相等的 <code>Entry</code> 数据，如下图所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-get3-48c3ca24f0be428e4ebdf3a91ca62169.png" width="1443" height="421" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocalmap的set原理">ThreadLocalMap的set原理<a href="#threadlocalmap的set原理" class="hash-link" aria-label="Direct link to ThreadLocalMap的set原理" title="Direct link to ThreadLocalMap的set原理">​</a></h3>
<p>下面是 <code>ThreadLocalMap.set()</code> 方法的核心代码实现：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// We don&#x27;t use a fast path as with get() because it is at</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// least as common to use set() to create new entries as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// it is to replace existing ones, in which case, a fast</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// path would fail more often than not.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> tab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threadLocalHashCode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Entry</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">replaceStaleEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> sz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">cleanSomeSlots</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sz</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> sz </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> threshold</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rehash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>往 <code>ThreadLocalMap</code> 中 <code>set</code> 数据（新增或者更新数据）分为好几种情况，针对不同的情况我们画图来说明。</p>
<p>第一种情况： 通过hash计算后的槽位对应的Entry数据为空，这里直接将数据放到该槽位即可：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-set1-949ccef106e922736e1ff4f37cade946.png" width="1494" height="363" class="img_ev3q"></p>
<p>第二种情况： 槽位数据不为空，<code>key</code> 值与当前 <code>ThreadLocal</code> 通过 <code>hash</code> 计算获取的 <code>key</code> 值一致：这里直接更新该槽位的数据。</p>
<p><img decoding="async" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABLwAAAF4CAMAAABpQBANAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFcUExURf///8/Pz7Kysmt/a+Xl5TIyMv9mZvLy8sz/zP+ZmX9/f+/v7++Rkcx/f7BxcXpWVveVld6IiJJiYkE2NszMzEA2Nm1tbV5ISJKSkkdHR/j4+N/f315eXrCwsMb3xmh6aG1PT3p6evv7+6urq6bMpnZ2dt7e3rq6uuPj43qSej4+PjQ0NHpERMxZWZGwkZqamv7+/ks/P8TExEtLS/dkZDo6OjY2Nuzs7LPes1ZWVqKiovX19dXV1YmJiTMzM+np6VNTU2lpabBSUu9iYl49PZJLS2VlZcnJyZ6enk5OToSEhEJCQt5eXqioqGJiYsDvwNvb20VFRY2Njb+/v1paWnJyctjY2P39/bW1tZeXl9LS0qWlpVNeU0VLRV1HR/Hx8aFqam1BQXh4eLe3t3x8fF5tXoZcXOTk5FJdUsR8fHGGcUs4OLt3d5m7mdODg4aihuiOjrd1dadQULtVVYKYp18AAB+0SURBVHja7J3/TxrLFsDXhiOhfN+7AURICo1grOZWqBqqBrUVKa3E2rR5rYm27770pnn3h/fy/v/kzQyLitXeYgV25DNpXXaZD2EnJx/OGZZZx/FbyBlo4WF2YWFhYSfGMnCwsLDICxYWFhZ5wcLCwiIvWFhY5AULCws7QTbst1D49g0WFhZ23CzWh4WFpWyEhYWFRV6wsLCwyAsWFhZ5MXCwsLDI6+/ZrgSidQkUWFjkNRQrAWkECiws8hpSXpEANOQFC4u8kBcsLCzyQl6wsMgLeSEvWFjkhbwIMlhY5IW8YGFhkRfygoW9J2zQl8UIirxYugQWliVxyLxgYWEpG5EXLCzyQl7ICxYWeSEvggwWFnldtIR7rVxSSfPr6dX0Dc+ft/SjWCqZuPn52KO07vU1hbxgYZHXGOR1rp07kVdCksgLFhZ5WScv140jL1hY5HXn8kolszGVHEk2FssmdMWYcLVr+vJSz7h660q81yvS38SyIp8v5KV39eGIK5Lod+q9CvKChUVedy6vVFK7SfsrmVL/dC51WV7KQ/HVtNrGz3ul/4poSKtOi8+XlzFfQu8q+lus3wl5wcIir9HIS5sqlo2bCjB9mj4vFH15qWdTybjZ9nv5GZsx0kXZqHvorn4HvxPygoVFXqORl6i0ylR8+rvFiJvo2WZgzsvIy73olV5VG5WmuQNzXmZXPfZF5XdCXrCwyGtEmZeuBU1OFTGW+db3zHXyivcuo0hE+jVmJJ69mnnFzbxXvxPygoVFXiOSV8RVttG1Y/qzcs7XUyWogQn7C3n5vbSXYtlkKr0aV9src17JlJlD+/YfvxPygoVFXqOSV8TV9aL0rsXSediN8vJ7qYow+1lt46qG/EuXjbqaTJiqspd96T2/E/KChbWFtXxJHNed4JI4W16tWiy+8z78GWXpElhYlsT5YeZ19ZrT0/REfts40z5S2/fnd3Wsqr3Fp3xCwsJSNv6UvFTBFx//D7ObJ901kQfq0Xajm1ko7Tbm1j+pvdb67sfaGUEGC4u8nACuKlF+l1kXedJ4uPXde87oFGzt/bsNggwWFnkFTV7v3oosdR43r33P+YPthujnwwQZLCzyCpa85te6D8I/es9HHxvSIshgYZFXcOQV3d7Ucvrb9/z0QE+Aec83CTJYWOQVAHkV30p7iPNtyZyvL4IMFhZ5TVJeIoUPQ5zvQVdk7iRPkMHCIq9Jtv+KLJ2UhzvfWkGkUSPIYGGR1+Saq/Ku0PDn++6VSOaIIIOFRV6TabGsrN/ut42b7SVpE2SwsNMqr2C0253vxvYmQQYLi7zsk5fZDf1eJshgYSkbrbvpbLklrRBBBgt712zo+hYeZneUbFDk9QvnW52TpcOgjzMsrG0smdfIMy/HOSuJHJf5dIWFpWy0TF6O83hJWhsEGSws8rJNXs5RXeoVAhQWFnnZJi9nY1d28gQoLCzysk1eTv74AwEKC4u87JMXLCws8rJXXtXOIgEKC4u8rJNXeUfelwlQWFjkZV3mNf9WFvIEKCws8rJuzkvZK7NJgMLCIq+bWjyZuvl2j197d6pNf02Nf8Leq0srTIDCwiKv4eWVXl018kpIcgLyCoVeSeGMAIWFRV7DyiueTT/S8nLd+ETk5TRfSSNKgMLCIi8/nzpN9/64ojMqJaZYNq5VFYukkiKu+uv2l0Z9lP7b0nKU13lt7OwgL1jYX2bDfguFb99Gyf6svFLJhM6mIvF4JJZNXJaXtpZ69hfldZfnO78YvHGGhbWNvT9lY8LXla4IB+Slk69Iwr20KP2EMy9YWFjKxsiAkrSN4nrNZndAXmYZ50uiCoS8TnIEKCws8vLzLZVxGWO57neZ1xXNTVxeR+vymACFhUVexkWnp2kjr/SqkVdvrisb01NgkUQ8OBP2prVlfYYAhYVFXub+itpOqkhMfjXyUhKT1c8q7YplRRKRgMnL2Za3IQIUFhZ5WbckTr4lO2cEKCws8rJuPa+NumTKBCgsLPKybjHC+SXJEaCwsMjLvpVUa0+kTYDCwiIv+5aBPuk0CVBYWOTFGvawsMgLeY1PXmUCFBYWedknr83OMQEKC4u87JOXty4zBCgs7BQviTNqeY3sfI+l3mTZE1jYKV4Sx9Y5r82GdPh0hYWlbLRvwv7DmtQIUFjYeyivYLQRnm9b5qIEKCzsfZNXNxju6o7wfPNdWSBAYWHvm7z6TWR2Eq2Xco34fBdfywMCFBYWeVknL+fx6zYBCguLvOyT19MNAhQWFnlZKC9YWFjkZa28QmECFBYWedknr5O1jwQoLCzysk9eM7IUIkBhYZGXfWXjP6VEgMLCIi/75NVckhkCFBZ2uuX1bFlfFL9i2beNv0uBAIWF/XnWlmUxhpPX3sD+m5dvbi+vsZ1vc04es+wJLOy9WRLndpnXHcprfOdblbkmn66wsNNdNvbktbe/J7I3u6JqyOUXy/97+XJ5Xx3d3w/qRaotyRGgsLBTP+f18sXsnjbXv9+YzOvZsjqwov6/+PImqPLaWntIgMLCknmpzGv5mXq84stLHXvxcmV2RR0M6s+D5glQWFjkZcrG2UvyWjFHelt+2wgLi7ysktebLytfXgRaXpsEKCws8vpeXrP7X/YCvapEde6IAIWFnfKLVPfO5TW7r79tNPLS8/dBlte2PCRAYWH5edD3bW+o6frxy2t+fa1JgMLCIq+rTX/dGOzFCN9fvtaLAIWFRV6m7cvebMDl9UlenxGgsLDIy75loLvSJkBhYZGXffKqST1PgMLCIi/r5PW00b+JIwEKC/sjNnR9Cw+zOw52YvIa+/k+l50/JzfOsLC2sGRegft5UL71YJNPV1jYe1Q2/jaJxm8bYWGR16+xDZlM2yFQYGGR16+w5ahqi9GBtjW4uzjM7s+y5Ymcb2i6AtTrfVDkFjOVH7O5ouMVoje/VDGnXstc5RuKFkp5RIC8GLjxss1CferGqqiVczfyqusXCXkZ5IW8GLhxs+VXMoO8biuvQqmoHlU6h8gLeTFwY2dz0plSeXkFnThFM9V6Ka+KSZ1ERQsiWkdFkVLnQl5q1xyu1EUd8TsZeXkZ1eOPUk3LK6egvOOVqiJ96RGTyAt2dOyWvM5PpbwKhWi+lHPMfJVXPzCmOoyqhxWnWFhUJeG5vPRutKB2xXOiNdUpbDppeYV06tUpevo1PL/TsfLYpUyMmEResCNiG1KbTnl5jkqT8lG1zZeKIZWCmTpSbfIl73LZqHqETddcsf9Suq+RV1QdrrT0314aq5lFlaIVKsQk8mLgRs22ZWFq57y0vNQ2XzLfQHq68lMbdWhAXmbXKzRLnl9om749eSmzFTuOybzMl5jq4YbTFyExibxgR8mGniydTb28iob1zIyWZ1ItdexK5hU1s/P6YFinaz15OcVS5qCfwTk5X16VTJSYRF4M3MjZlvwx5fJyioUPTjSXNzLSCZgSUPHqnJdnpsOiNS2v4nnm5VTqpUpfXpW6vnzi0NFzacQV8mLgRs4+kN1pl5f+PlGLSlWEbTMHpgpAXTbqStAITdeJ5gJXted38uXl5LxQv2wsdXTm1ZaBu5ETk8gLdlRsuHuYZ6zuijVlI2N179iw30Lh2zdY2ECztYUNxur+sVgflsyLsaJshIWFhUVe085W//UPxgoWFnnZxx7LNmMFC4u8LMy8ZIexgoVFXvaxYZEwYwULi7zsY3ekyljBwiIv+9hjOWasYGGRl31sVRqMFSws8rKP3RTZYKxgYZGXfeyOWVmCsYKFRV6WsTn5yFjBwiIv+9hm9HzX692LMN+pfN9ZrxXTWxRGzN0mGGdY5MXABYXN9RajOqjXr5FX0evdXCKsPeYxzrAOS+KwHEdA2I2Fw8NjvbBLY2v30/nR49qlLp92F/XGdGOcYVkSB+tPnO0XgUX/FvaX7iGhqsWLNEsvHxoeuMUE4wxL2cjATYxtrz2/WV76RmF9fel7Eyq2mGOcYZEXAxcA9rmUfiSv8P/ZO9emNJI1AKuHt3BlzW5SlEG85ATBC1YBgQJEIMoXDVJ4v6AmJ1XZ7NmtrbO7///bmRlmEDfKDDSGaXzeDzHt8IzN29MP3c3QTKzmLHuZ3zFhfnHhYpg8wyIvEucDdl8WH5DXas7+Mgln5LXU/hEMd3+hPXmGRV4kbmTsjjQ8rHk5zgp2vjyaPMMiLxI3UjaTF8NLsYflFQkHbYktOUtgYfIMi7xI3MjZcDNdzUupnrx9fM3LHoG1v+r+ZnGVPMMiLxI3cvZM7LgkV7CwyEsjNjbfdlfyilzBwiIvndjrtrzmyBUsLPLSit3ZtOS1Ta5gYZGXXuyFJa8bcgULi7z0YvdNd+Vj5AoWFnlpxtYNedXIFSwsW+LoxqYNeV2TK1hYtsTRjQ0VRCbJFSws00bt2IQUYuQKFhZ5aceudbaVIFewsMhLJ7aUJlewsMhLQ7YZJlewsH6R16EQBEF4jD0fyYvWIAjCe/hKXtOqwSm6TzGpGn55IhOqMZRTjM0TGbNcIC/khbyQF/JCXsgLeSEv5IW8kBcdFnkhL+SFvJAX8kJeyAt5IS/khbyQF/JCXsOTV+DhCPZT7IvFPMgLeSEv77V41DmMvJAX8kJeTBuRF/JCXsgLeSEv5IW8yAXyQl7IC3khL+SFvJAX8kJeyAt5IS/khbyQF/JCXshrZPLa+mN5evroo4hsKHSVrU8icYXeZtViOiXy8Uilwy6/ebOsXIvp6Y24gryaRiojavJyz6ZrLswWTY2DvDak90XxvOQV30Bed5ESs7sf/bql1FXin7aUhgrtWmz9aVyrKgqdjouKvNq1MPu9gryyX/cnWydNFXltfYpPb/2u1CLLb1LWacZAXilGXl0mR15d2diID0Fey2/iSvMcuxaWQHrYx7Vtl//4Q0Fedi22fo+/URl5mfE1oiIvKwcundblFHFzsLKxgbzGSV7GK1IKed27zK0O++uRSldxw91P4cirpwZd5ZXaSClNG+1aLKvKa7+mLq/UhkqLWLRLMjTpsHHk9Y92RV735fVJabUp/uZvkSFoIyU9p5+uS0W/HvlDXpHdrOq08eijkrysQVd8LOQlHtb/kNczlpd1vQ8+YYtLyrjKNoYy8hp8zct0ji/k9fWkpbZgHzdeSv5GXl5XVJHXs5dXryVi15HXsoeu8tS1MDusD+SV3a3tD+FWCbU1r7GZNjrvPiAvX8graEcgOHj0xT69Nqw1ryHJq8fyWe9TWLd7uM0xnl5ebutdHuWl+BZKe8Fejz6PvPwmr0ed48uR19Fy71ukPLwxf/QxpTrm+XNLado4Pe2HkVfTZb3Lo7xc3il0y4XZGu53W+iw5mVIOMW0kWlj7wX7DYWlcnNZNTWtqg3zLCq18Ie8rOFf75mjq3nEw/08Lm9efBK3e++0WbB3uUcVeT1beXkKTtHffV58PGiY00ZulRhJLpAX8kJeyAt5IS/khbyQF/JCXsiLDou8kBfyQl7IC3khL+SFvJAX8kJeyAt5IS/kxSmQF/JCXsgLeSEv5IW8kBfyQl7IC3khL+SFvMgF8kJeyAt5jZW8fLYlDvJCXnRYctFdC222xEFeyIsOSy58O238l2pwiu5TzKmGX57IjGoM5RRj80TGJhc+kldSCIIgPEbSR/IKT92L7fvFFS/FdHpw1o706eCs/XedWgzCOrVIu7Cn1apLrjq16Ofv3j9qnGJg1i7e1aJ/9q4WA7N2sasWg14b1im2la6N7loMeG20TzH4dWUcvVeLwdrXPoXKtRFJq11XZlz6SF6wfbCJRI1cwcIiL+3Y9cK8rJMrWFjkpRubNqb8p+QKFhZ56cbuGvJqRMkVLCzy0ou9sd5tWSNXsLDISy/2wJLXHrmChUVeWrFl+5a4Y3IFC4u8dGJb9l16p+QKFhZ56cTuObcYl8kVLCzy0odd6HxAYopcwcJ+y373LXFgPUakI69zcgUL64MtcWC9PTh2cvfZ1EtyBQvLtFEX9mY31363MXleWyFXsLDISyP2uC4tKWTJFSws8tKMzUuxIQFyBQuLvPRiP0th4lwmyRUsLPLSi72U+sSM3JIrWFjkpReblb2JFXlLrmBhkZde7Ip8nagYoy9yBQvrRV5vh7Jr/nyRpCuzB3I9Uc5LmVzBwnqR15C+82ONpCuzJclOTFxEdsgVLKw3eU2oRwJ5qbNl2QySK1hY5KUdG5ZdcgULi7z0Y2/lC7mChUVe+rEX0jR/rFUvyRUs7Lds4J8xJHk1OycM3j9/MNArgv0Ux5v97URuzJ9VqZIrWNhvgpGXb9l1ObGKk3JOrmBhmTbqwzblwirGcs63ZpMrWFjkpQG7KGvt4ox8IFewsMhLF3ZV8uV2MevMG8kVLCzy8j+7LRd2MXoiFXIFC4u89GAzJTlziqdyQK5gYZGXHuyxJKNOsSKNILmChUVeWrARSdwVS7ljcgULqySvsIgsTazmrI0jwsjrydhow9xRwimuRskVLKySvEKRqGGutrTCb6PI68nYJesdRnIFCzvMaWNkyfLY3CrTxidjY3U5I1ewsMOVV/StJa+lCGteT8eeSen+0cu3FXIFC6smr6XFkOvAy5BX/XCvNneR+PJ1Zub0w1S2crzw204xVI6RdA8PzhxK6/7RA5kjV7CwSvKK5CxrLfVa8TLl9VjkS4nI1ORqoBiMZmiwRx48aX/rxt3RQF5uyBUsbDcbtCPg/KenvEKLbWnZc8ce8rrOnp2ttaaWVpq36eqXvdJuPXfSSOYLXR4r7CauW9nLBUNkg0UgOHj4mQ2dy+0/f1eVvbF9vrCwg7D9jbw6zlqdC00MtuYV3G9dfzmvzzeSXR7LL85sh9eL5QyvNmasOB9m7DpaTMo+r8ywsINOG8OLtrNcZo3eFuzLlaXTWj3XyG92LFaamToOhKLPu8F+2yxUvj2altICFzcs7KDysgxjiCsSmVCX193fDYVvD0qGxd7bDkvW0pOWw55jg13V7I8y3j9arss1Fzcs7OAL9t5iwFslouHri/pJZ0LZSNyumnPJ59Vga5K7euhoVpJFLm5YWH/Kyzm6s1bdnU/as8n8XNNR2HNosJ3kZvbhoxdSHV2dF2W0sUhnhtVCXnYc39bmO8Oww3RlJxAb+waLlsxPZD94dP1rcHR1llEHnRlWJ3m1i4GVi/mGo7Dz60qxfDW+DRabM8cYPqyzyA+jDOQFq6O82hH6ZabeWdHf214wl/PHr8E+H8hJGXkhL9jx288rejaTcyaSyZmVYjA2Xg12LYX1Xmy02kJedGZYfTcjDLUSnbWw8w/GICwzJg22JJv7PdltSQaQF50ZVvOdVIsrNeeuisJFaycY073BMtvifMnZo2xCFmPIi84Mq7e82mygeegshZ1U90Ndd4Xp1mCxA9lMu7HF3N2tqsiLzgyrs7zacfblxPmQUW2lWI5p2GCxC9lsubOV/Ps15EVnhh0beVkRjnQW83OnlWAxo1ODRWtS2PfC3kqygrzozLD9bonjXV5TI9pSI9CsJZ1B2NzS+k5Ii21APmc3DSd5Yw/k5Pj713nk8mKLGFilLXH8PfLqOnpzOu9sHbabXrCmkX5+tYl9kfeHGY9srCb1ECMvRiKwD8hrXj3yftjDPraWcAZhm4m1QDTm0wbLXCal8It3NlRqMW2kM8N+W5gfzkfRbvzy5IvNvXxh03k7shy98luDlS9ESp/7YcusedGZYR8ohBbMqCzci97F/W+PBjL+evI31aRtMNmNVKKxK780WCwtUtjunw2URyavH//98kHBzLbz++qx45149eKH2dc/Pn78xSvrUbPIC7Y/eY3xk9/5UHIMJnVTYZlR1zlzVpD3c1f9swvztajf5OVoZyjy+vG1IC9Y5HW/uH/Q6CislD5uK2wkdY6dNeT9bmAQdrUhtdAYy+vlf/76CXnBIq+HilMHnXmknH9YD11lvnedy1Xz0+XhAZ+vYa/DzOjkNSsvzMGR8e8LU0Ozr/96N3snr9nX8u6l8fN/7376uf0o+8HGI0R++u+dvIyi9euX78T4jf0g6yw/Iy9Y5NWDzc4kN52N8w9vd2JX36vOV+vnIu/rl4M/39V5OSyPSl6z/2/v7H/SSMIAHBtHAvsBbHrFok10GysRSVeUGqwICuJnjVYUtUnrx6VN0/vhcv//DzezCxQt9kD5Wu+ZVGFgnrK+s3nyvrPsrnJTTPnLkP9ULhVtklcspkfClnwMR+qjgpd6UEFKdUp8NXmZrrFkV9aI+vfGIOQFi7zaYp10KFNX2Nrk28Oq4/T2c53VsvqonP2ov/fbjsjmByOvv5SpTKkmVQFa1s9CsSYv+a6hcq6mUZ70PCM1ykZ3hBrqDaindcgLFnl1wjrH18m1eha2N3227Dg9+VwnnVXmWkw/eptHJ8XLw0HIKyasWsUn5LPolO4dHry15qXkpR7royz1YHiW+ykvt2vE/q6JyhuEvGCR1wNY5+Jt060mMuvbI938dr49W/YOdaa7ss32rijEByCvKSNm1nIq1zLfG55pIS9vlOHWh16NGQnfzbz0sNk0CHnBIq+Hso6jPf+401DY2lqyEHp9+LjPrY7k5ry8rpB2urbN46eDWfOKLphBd5XrUnnq89dIsHnNq1letVHKS6ZMqizpMvPumpfhrnTp3+uDkBcs8noc61RHb3azolliycL09nGis899fzbTOCqwfpxwur7NWv/lJZ1kqSOE7nex1Ir7vfKqj5IV4aW0VCQsa0hVNqpouK7y/g/D7dUGIS9Y5NUV1qnayxefpnfEbY292zu4zm2/Sq+OLv/KOoHExbPcZCaZbBzMXMxNqG+UdX+bny9u9Vded1v0c5TTg2AHwHI5jrabpmnLWx9y67+e/bmmbNZoa411f+8a1eXtU0370rNtLotkLj/IS+JYFpfEgR2KS+Jg/f9mq7Ztx/NbZyvjoReVl+9anJeeWaxcr2xpcdvWer3N9rgQ2TcDy7wMUVu4J/OCpWz0Hes41arymde06q1v6/dhm0cWRWaFq0qwTyIvAuc7NhASYn0CebFvIC8C5zt2dk/sJZAX+wbyInC+Y/PrBzbyYt9AXgTOh+yh/JmIIy/2DeRF4PzHxgs7x8iLfQN5ETjfsRNZIQ4ukBf7BvIicH5j4x+OhJj+hrzYN5AXgfMb++V8TmTGNeTFvoG8CJzf2PzuO3F02n15Dbgxv7DI6+mzhy8KNvJi30BeBM6H7LLsjrzNUzaybyAvAuc/9kRkZp4jL/aNp8uOtm6BTrqww8impzNCFLYPu/O5A5cX8wt7p2H9J8xqKztCzH2cIPOCpWwkcD5j7eOyEHsB5AWLvAic79jT0Lj8vXoTR16wyIvA+Yt15E9IvAyl48gLFnkROJ+xnwrqVrp/pm3kBYu8YP3FJrbV3XTnQnnkBYu8YH3GJlYmk0eqdpxAXrDIC9Zf7ERa/RJzJyunceQFi7xg/cWmF927s62fby0jL1jkBesnVnudc+8Afi2fx3slr0jYCN57s0chzKAec0+5NpEXLPKC7YB9Pzte2ZZPt5OV0Hk6YfdRXroVCUYXvHejUzrygkVesA9gd+e8e3xXZtJ9y7xUs8w2BiEvWOQFe++79uHs+MnimhCvZGfmqPIilFs5S69qncvLsrxf0QUhDNdLZjgiH023UFyIBg3501CbKy9DDkBesMgL9uGsvfpa3bW20rj6343snRSykwfl8snMdFvyMmJ6MPo5GrmMBM2Y3iwvZS35bpO85ID2Ey/kBduCDdTaaODhDfbpsPnTrZsP57mZcvZY9g6aLmXahmL0mKcrbymrSV5umqVPRZuSNE9jRkxvU17MEewdFuvD/qabeHO6OrL17Hj2rL01L9NSxoqEhSoSb8nL9Z/x03K1atEtNMm8YCkbYXvGtiev6JQxpbvGUtXjncyreSm/1r2VjCEvWOQFOyh5RcJTMpVSxrK8zMtd6xKmu8KlWxHjTrHYbtWIvGCRF2xP5RU0lZ1UkXjpZV5BS4ivKs8yhZCiqsvLLSKl4sz2jjUiL1jkBdtjeXF6ECzygkVeyAsWecEiL1jkReCQF/KCRV6wyAt5wSIvWOTF/CIvAgeLvGCRFyzyQl6wyAsWeTFHsMgLFnnBckkc2CfODlxezBEsl8SBJfOCpWyE/R/Ja8CNOYJFXrAPYScH7K5J5ggWecE+ghVirL9NpVzMESzygkVesMgLFnkhL1jkBYu8kBcs8oJFXswv8iJwsMgLFnnBIi/kBYu8YJEXcwTLHw/bA3ml1FdL55eQFyzygvWZvErFW/3NTeQFi7xgkRdzBMslcWA7YTuWV/EqVRKl4tK8LCJTqfl/xOaP/bGx/dJ+2/JijmC5JA5s39e8NsaKJWWuTS/zSskXluY3xsY2Nsm8YCkbYYe6bCyWUvL5/JInL/XaxvzS0nwKecEiL9jhltfVfpO81NFH+Uqq/aOQyAsWecEOibzGNjc2N1iwh0VesL6T1/7VVRF5wSIv2GGVl1qwLxUb8tr/oY42Knm56/fICxZ5wQ6nvO5v7ho+8oJFXrB+k9dGJycNIS9Y5AU7HPLa/1Eq8g17WOQF68PMi9ODYJEXLPJijmAJHCzygkVesMgLecEiL1jkxRzBtmJHW7dAJ13Y/w0rxB/9bUIwR7CtWawP2wlbEf1uWeYIlrIR9vGsrWlaQrvVft9d7WRwK9ZmjmCRFywsLPIicLCwsMgLFhYWFnnBwsIiLwIHCwuLvGBhYWGRFywsLCx/PCwsLPKChYWFRV6wsLCwyAsWFhZ5EThYWNghYAO1Nhp4eIOFhYXtN4v1YWFhKRthYWFhkRcsLCws8oKFhUVeBA4WFhZ5wcLCwiIvWFhY5EXgYGFhkRcsLCxs19l/AZObyhB4bD80AAAAAElFTkSuQmCC" width="1212" height="376" class="img_ev3q"></p>
<p>第三种情况： 槽位数据不为空，往后遍历过程中，在找到 <code>Entry</code> 为 <code>null</code> 的槽位之前，没有遇到 <code>key</code> 过期的 <code>Entry</code> 。遍历散列数组，线性往后查找，如果找到 <code>Entry</code> 为 <code>null</code> 的槽位，则将数据放入该槽位中，或者往后遍历过程中，遇到了 <code>key</code> 值相等的数据，直接更新即可。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-set3-d879925a28d2b7ae12f956102e91b80d.png" width="1238" height="398" class="img_ev3q"></p>
<p>第四种情况： 槽位数据不为空，往后遍历过程中，在找到 <code>Entry</code> 为 <code>null</code> 的槽位之前，遇到 <code>key</code> 过期的 <code>Entry</code> ，如下图，往后遍历过程中，遇到了 <code>index=7</code> 的槽位数据 Entry 的 <code>key=null</code>：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-set4-a46c954c3aca3cb2c721154bd3e21cbd.png" width="1318" height="404" class="img_ev3q"></p>
<p>散列数组下标为 <code>7</code> 位置对应的 <code>Entry</code> 数据 <code>key</code> 为 <code>null</code> ，表明此数据 <code>key</code> 值已经被垃圾回收掉了。此时就会执行 <code>replaceStaleEntry()</code> 方法，该方法含义是替换过期数据的逻辑，以 <code>index=7</code> 位起点开始遍历，进行<strong>探测式数据清理</strong>工作（后一章节会详细介绍），最后替换新的值 。</p>
<p>替换完成后也是进行过期元素清理工作，清理工作主要是有两个方法：<code>expungeStaleEntry()</code> 和 <code>cleanSomeSlots()</code> ，具体细节后续章节详细介绍。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocalmap清理机制">ThreadLocalMap清理机制<a href="#threadlocalmap清理机制" class="hash-link" aria-label="Direct link to ThreadLocalMap清理机制" title="Direct link to ThreadLocalMap清理机制">​</a></h3>
<p><code>ThreadLocalMap</code> 过期 <code>key</code> 的两种清理方式：<strong>探测式清理(<code>expungeStaleEntry()</code>)</strong>、<strong>启发式清理(<code>cleanSomeSlots()</code>)</strong>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="探测式清理">探测式清理<a href="#探测式清理" class="hash-link" aria-label="Direct link to 探测式清理" title="Direct link to 探测式清理">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="replacestaleentry">replaceStaleEntry()<a href="#replacestaleentry" class="hash-link" aria-label="Direct link to replaceStaleEntry()" title="Direct link to replaceStaleEntry()">​</a></h5>
<p>该方法主要用在 <code>ThreadLocalMap.set()</code> 方法，用来清理数据，并进行填充 <code>Entry</code>。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">replaceStaleEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> staleSlot</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> tab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Back up to check for prior stale entry in current run.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// We clean out whole runs at a time to avoid continual</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// incremental rehashing due to garbage collector freeing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// up refs in bunches (i.e., whenever the collector runs).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> slotToExpunge </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> staleSlot</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prevIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">staleSlot</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prevIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                slotToExpunge </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Find either the key or trailing null slot of run, whichever</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// occurs first</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">staleSlot</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// If we find key, then we need to swap it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// with the stale entry to maintain hash table order.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// The newly stale slot, or any other stale slot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// encountered above it, can then be sent to expungeStaleEntry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// to remove or rehash all of the other entries in run.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">staleSlot</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">staleSlot</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// Start expunge at preceding stale entry if it exists</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slotToExpunge </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> staleSlot</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    slotToExpunge </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">cleanSomeSlots</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">expungeStaleEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slotToExpunge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// If we didn&#x27;t find stale entry on backward scan, the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// first stale entry seen while scanning for key is the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// first still present in the run.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> slotToExpunge </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> staleSlot</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                slotToExpunge </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// If key not found, put new entry in stale slot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">staleSlot</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">staleSlot</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// If there are any other stale entries in run, expunge them</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slotToExpunge </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> staleSlot</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">cleanSomeSlots</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">expungeStaleEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slotToExpunge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>假定散列数组下标为 <code>7</code> 位置对应的 <code>Entry</code> 数据 <code>key</code> 为 <code>null</code> ：</li>
</ol>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-set4-a46c954c3aca3cb2c721154bd3e21cbd.png" width="1318" height="404" class="img_ev3q"></p>
<ol start="2">
<li>以当前 <code>staleSlot</code> 开始向前迭代查找，找其他过期的数据，然后更新过期数据起始扫描下标 <code>slotToExpunge</code> 。<code>for</code> 循环迭代，直到碰到 <code>Entry</code> 为 <code>null</code> 结束。初始化探测式清理过期数据扫描的开始位置：<code>slotToExpunge = staleSlot = 7</code> 。以当前节点(<code>index=7</code>)向前迭代，检测是否有过期的 <code>Entry</code> 数据，如果有则更新 <code>slotToExpunge</code> 值。碰到 <code>null</code> 则结束探测。以上图为例 <code>slotToExpunge</code> 被更新为 <code>0</code> 。</li>
</ol>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-set5-04938e81b989cb899294c4eb7ac76132.png" width="1347" height="470" class="img_ev3q"></p>
<ol start="3">
<li>接着开始以 <code>staleSlot</code> 位置(<code>index=7</code>)向后迭代，如果找到了相同 <code>key</code> 值的 <code>Entry</code> 数据：</li>
</ol>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-set6-0cc82dcaa85c79c309ccebd9c37612ae.png" width="1353" height="487" class="img_ev3q"></p>
<ol start="4">
<li>从当前节点 <code>staleSlot</code> 向后查找 <code>key</code> 值相等的 <code>Entry</code> 元素，找到后更新 <code>Entry</code> 的值并交换 <code>staleSlot</code> 元素的位置( <code>staleSlot</code> 位置为过期元素)，更新 <code>Entry</code> 数据，然后开始进行过期 <code>Entry</code> 的清理工作，如下图所示：</li>
</ol>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-set7-0521d1c53ba9810f37cb5597a4e2ece6.png" width="1336" height="361" class="img_ev3q"></p>
<ol start="5">
<li>向后遍历过程中，如果没有找到相同 <code>key</code> 值的 <code>Entry</code> 数据，直到 <code>Entry</code> 为 <code>null</code> 则停止寻找。创建新的 <code>Entry</code> ，替换 <code>table[stableSlot]</code> 位置：</li>
</ol>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-set8-973320a4d5dcefba1958f5a2bcc13e21.png" width="1336" height="397" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/threadlocal-set9-da17ad7c7e7e9b52a79620ab358a41d6.png" width="1341" height="398" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="expungestaleentry">expungeStaleEntry()<a href="#expungestaleentry" class="hash-link" aria-label="Direct link to expungeStaleEntry()" title="Direct link to expungeStaleEntry()">​</a></h5>
<p>探测式清理 <code>expungeStaleEntry</code> 方法，遍历散列数组，从开始位置向后探测清理过期数据，将过期数据的 <code>Entry</code> 设置为 <code>null</code> ，沿途中碰到未过期的数据则将此数据 <code>rehash</code> 后重新在 <code>table</code> 数组中定位，如果定位的位置已经有了数据，则会将未过期的数据放到最靠近此位置的 <code>Entry=null</code> 的桶中，使 <code>rehash</code> 后的 <code>Entry</code> 数据距离正确的桶的位置更近一些。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">expungeStaleEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> staleSlot</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> tab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// expunge entry at staleSlot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">staleSlot</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">staleSlot</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Rehash until we encounter null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">staleSlot</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                size</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> h </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threadLocalHashCode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// Unlike Knuth 6.4 Algorithm R, we must scan until</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// null because multiple entries could have been stale.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        h </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>如下图，<code>set(27)</code> 经过 <code>hash</code> 计算后应该落到 <code>index=4</code> 的桶中，由于 <code>index=4</code> 桶已经有了数据，所以往后迭代最终数据放入到 <code>index=7</code> 的桶中，放入后一段时间后 <code>index=5</code> 中的 <code>Entry</code> 数据 <code>key</code> 变为了 <code>null</code> 。如果再有其他数据 <code>set</code> 到 <code>map</code> 中，就会触发探测式清理操作。</li>
</ol>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-expunge1-828ec51c26f66e55e23786ebcdc5e909.png" width="1373" height="324" class="img_ev3q"></p>
<ol start="2">
<li>执行探测式清理后，<code>index=5</code> 的数据被清理掉，继续往后迭代，到 <code>index=7</code>  的元素时，经过 <code>rehash</code> 后发现该元素正确的 <code>index=4</code> ，而此位置已经有了数据，往后查找离 <code>index=4</code> 最近的 <code>Entry=null</code> 的节点(刚被探测式清理掉的数据：<code>index=5</code> )，找到后移动 <code>index=7</code> 的数据到 <code>index=5</code> 中，此时桶的位置离正确的位置 <code>index=4</code> 更近了。经过一轮探测式清理后， <code>key</code> 过期的数据会被清理掉，没过期的数据经过 <code>rehash</code> 重定位后所处的桶位置理论上更接近 <code>i = key.hashCode &amp; (tab.len - 1)</code> 的位置。这种优化会提高整个散列表查询性能。</li>
</ol>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-expunge2-23cda18419a3772313579c5fa2905fbc.png" width="1351" height="384" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="启发式清理">启发式清理<a href="#启发式清理" class="hash-link" aria-label="Direct link to 启发式清理" title="Direct link to 启发式清理">​</a></h4>
<p>探测式清理是以当前 <code>Entry</code> 往后清理，遇到值为 <code>null</code> 则结束清理，属于线性探测清理。而启发式清理被作者定义为：<code>Heuristically scan some cells looking for stale entries.</code>。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cleanSomeSlots</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> removed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> tab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Entry</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                removed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">expungeStaleEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&gt;&gt;&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> removed</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-clean-d73bf3240db5dd24c14133673f618fd3.png" width="1434" height="924" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocalmap扩容机制">ThreadLocalMap扩容机制<a href="#threadlocalmap扩容机制" class="hash-link" aria-label="Direct link to ThreadLocalMap扩容机制" title="Direct link to ThreadLocalMap扩容机制">​</a></h3>
<p>在 <code>ThreadLocalMap.set()</code> 方法的最后，如果执行完启发式清理工作后，未清理到任何数据，且当前散列数组中 <code>Entry</code> 的数量已经达到了列表的扩容阈值(<code>len*2/3</code>)，就开始执行 <code>rehash()</code> 逻辑：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">cleanSomeSlots</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sz</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> sz </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> threshold</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rehash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rehash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">expungeStaleEntries</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Use lower threshold for doubling to avoid hysteresis</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> threshold </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> threshold </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">resize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">expungeStaleEntries</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> tab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Entry</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">expungeStaleEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>expungeStaleEntries()</code> 方法中会进行探测式清理工作，从 <code>table</code> 的起始位置往后清理，上面有分析清理的详细流程。清理完成之后， <code>table中</code> 可能有一些 <code>key</code> 为 <code>null</code> 的 <code>Entry</code> 数据被清理掉，所以此时通过判断 <code>size &gt;= threshold - threshold / 4</code> 也就是 <code>size &gt;= threshold * 3/4</code> 来决定是否扩容。我们还记得上面进行 <code>rehash()</code> 的阈值是 <code>size &gt;= threshold</code>，这两个阈值容易混淆，所以一定要清楚这两个的区别：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/threadlocal-rehash-8dec85c79dc9cb1a63f7ab7e320b3a08.png" width="1483" height="511" class="img_ev3q"></p>
<p>接下来就是最关键的扩容方法的实现了：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">resize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> oldTab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> oldLen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldTab</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> newLen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldLen </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> newTab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">newLen</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> oldLen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Entry</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldTab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Help the GC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> h </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threadLocalHashCode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newLen </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newTab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        h </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    newTab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    count</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">setThreshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newTab</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>扩容后的 <code>tab</code> 的大小为 <code>oldLen * 2</code> ，接着遍历老的散列表，重新计算 <code>hash</code> 位置，然后放到新的 <code>tab</code> 数组中，如果出现 <code>hash</code> 冲突则往后寻找最近的 <code>entry</code> 为 <code>null</code> 的槽位，遍历完成之后， <code>oldTab</code> 中所有的 <code>entry</code> 数据都已经放入到新的 <code>tab</code> 中了。重新计算 <code>tab</code> 下次扩容的阈值。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocal的多线程继承">ThreadLocal的多线程继承<a href="#threadlocal的多线程继承" class="hash-link" aria-label="Direct link to ThreadLocal的多线程继承" title="Direct link to ThreadLocal的多线程继承">​</a></h2>
<p>有些业务场景需要在多线程之前传递 <code>ThreadLocal</code> 的值，例如：</p>
<ol>
<li>分布式跟踪系统 或 全链路压测（即链路打标）</li>
<li>日志收集记录系统上下文</li>
<li>Session级Cache</li>
<li>应用容器或上层框架跨应用代码给下层SDK传递信息</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="inheritablethreadlocal">InheritableThreadLocal<a href="#inheritablethreadlocal" class="hash-link" aria-label="Direct link to InheritableThreadLocal" title="Direct link to InheritableThreadLocal">​</a></h3>
<p>我们使用 <code>ThreadLocal</code> 的时候，在异步场景下是无法给子线程共享父线程中创建的线程副本数据的。为了解决这个问题，JDK 中还有一个 <code>InheritableThreadLocal</code> 类。</p>
<p>其实现原理是子线程是通过在父线程中通过调用 <code>new Thread()</code> 方法来创建子线程，<code>Thread#init</code> 方法在 <code>Thread</code> 的构造方法中被调用。在 <code>init</code> 方法中拷贝父线程数据到子线程中：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ThreadGroup</span><span class="token plain"> g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Runnable</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> stackSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">AccessControlContext</span><span class="token plain"> acc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> inheritThreadLocals</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">NullPointerException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;name cannot be null&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inheritThreadLocals </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inheritableThreadLocals </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inheritableThreadLocals </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ThreadLocal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createInheritedMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inheritableThreadLocals</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stackSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stackSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextThreadID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>但 <code>InheritableThreadLocal</code> 仍然有缺陷，一般我们做异步化处理都是使用的线程池，而 <code>InheritableThreadLocal</code> 是在new <code>Thread</code> 中的 <code>init()</code> 方法给赋值的，而线程池是线程复用  的逻辑，所以这里会存在问题。</p>
<p>当然，有问题出现就会有解决问题的方案，阿里巴巴开源了一个 <code>TransmittableThreadLocal</code> 组件就可以解决这个问题。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transmittablethreadlocal">TransmittableThreadLocal<a href="#transmittablethreadlocal" class="hash-link" aria-label="Direct link to TransmittableThreadLocal" title="Direct link to TransmittableThreadLocal">​</a></h3>
<p><code>TransmittableThreadLocal(TTL)</code>，解决了 <code>InheritableThreadLocal</code> 的不足，在使用线程池等会池化复用线程的执行组件情况下，提供 <code>ThreadLocal</code> 值的传递功能，很好地解决异步执行时上下文传递的问题。具体实现可参考<a href="https://github.com/alibaba/transmittable-thread-local" target="_blank" rel="noopener noreferrer">GitHub - alibaba/transmittable-thread-local</a>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ttl使用教程">TTL使用教程<a href="#ttl使用教程" class="hash-link" aria-label="Direct link to TTL使用教程" title="Direct link to TTL使用教程">​</a></h4>
<ol>
<li>直接使用方式：</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">TransmittableThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">TransmittableThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// =====================================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 在父线程中设置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;value-set-in-parent&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// =====================================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 在子线程中可以读取，值是&quot;value-set-in-parent&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">String</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>修饰 <code>Runnable</code> 和 <code>Callable</code></li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">TransmittableThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">TransmittableThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// =====================================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 在父线程中设置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;value-set-in-parent&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Callable</span><span class="token plain"> call </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CallableTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 额外的处理，生成修饰了的对象ttlCallable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Callable</span><span class="token plain"> ttlCallable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">TtlCallable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">call</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executorService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">submit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ttlCallable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// =====================================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Call中可以读取，值是&quot;value-set-in-parent&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">String</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>修饰线程池</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">ExecutorService</span><span class="token plain"> executorService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 额外的处理，生成修饰了的对象executorService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executorService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">TtlExecutors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTtlExecutorService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">executorService</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">TransmittableThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">TransmittableThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// =====================================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 在父线程中设置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;value-set-in-parent&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Runnable</span><span class="token plain"> task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RunnableTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Callable</span><span class="token plain"> call </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CallableTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executorService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">submit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executorService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">submit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">call</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// =====================================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Task或是Call中可以读取，值是&quot;value-set-in-parent&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">String</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>Java Agent 修饰</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java -javaagent:path/to/transmittable-thread-local-2.x.y.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -cp classes \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    com.alibaba.demo.ttl.agent.AgentDemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果修改了TTL jar文件名 或 TTL版本是 2.6.0 之前</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 则还需要显式设置 -Xbootclasspath 参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java -javaagent:path/to/ttl-foo-name-changed.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -Xbootclasspath/a:path/to/ttl-foo-name-changed.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -cp classes \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    com.alibaba.demo.ttl.agent.AgentDemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java -javaagent:path/to/transmittable-thread-local-2.5.1.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -Xbootclasspath/a:path/to/transmittable-thread-local-2.5.1.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -cp classes \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    com.alibaba.demo.ttl.agent.AgentDemo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="核心原理介绍">核心原理介绍<a href="#核心原理介绍" class="hash-link" aria-label="Direct link to 核心原理介绍" title="Direct link to 核心原理介绍">​</a></h4>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="#参考资料" class="hash-link" aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li><a href="https://javaguide.cn/java/concurrent/threadlocal.html" target="_blank" rel="noopener noreferrer">JavaGuide - ThreadLocal详解</a></li>
<li><a href="https://mp.weixin.qq.com/s/jEx-4XhNGOFdCo4Nou5tqg" target="_blank" rel="noopener noreferrer">微信公众号 - Java AQS 核心数据结构-CLH 锁</a></li>
<li><a href="https://github.com/alibaba/transmittable-thread-local" target="_blank" rel="noopener noreferrer">GitHub - alibaba/transmittable-thread-local</a></li>
<li><a href="https://blog.csdn.net/thewindkee/article/details/103726942" target="_blank" rel="noopener noreferrer">CSDN - 测试ThreadLocal 在gc后引发的threadLocalMap的key为null,但value不为null的情况</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/java/tags/java">java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/java/tags/concurrent">concurrent</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/java/tags/threadlocal">threadlocal</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-05-17T03:36:20.000Z" itemprop="dateModified">May 17, 2025</time></b> by <b>vyckey</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/java/java/concurrent/thread"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Thread</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/java/java/concurrent/transmittable_threadlocal"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Transimittable ThreadLocal</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#介绍" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#使用场景" class="table-of-contents__link toc-highlight">使用场景</a></li><li><a href="#数据结构" class="table-of-contents__link toc-highlight">数据结构</a><ul><li><a href="#threadlocal数据结构" class="table-of-contents__link toc-highlight">ThreadLocal数据结构</a></li><li><a href="#threadlocalmap数据结构" class="table-of-contents__link toc-highlight">ThreadLocalMap数据结构</a></li><li><a href="#threadlocal的entry设计" class="table-of-contents__link toc-highlight">ThreadLocal的Entry设计</a><ul><li><a href="#为什么entry要使用弱引用" class="table-of-contents__link toc-highlight">为什么Entry要使用弱引用？</a></li><li><a href="#为什么还是会出现内存泄露" class="table-of-contents__link toc-highlight">为什么还是会出现内存泄露？</a></li><li><a href="#在-threadlocalget的时候发生gc之后key-是否为null" class="table-of-contents__link toc-highlight">在 ThreadLocal.get()的时候，发生GC之后，key 是否为null？</a></li></ul></li></ul></li><li><a href="#threadlocal底层实现" class="table-of-contents__link toc-highlight">ThreadLocal底层实现</a><ul><li><a href="#threadlocal的hash算法" class="table-of-contents__link toc-highlight">ThreadLocal的Hash算法</a></li><li><a href="#threadlocalmap的hash冲突" class="table-of-contents__link toc-highlight">ThreadLocalMap的Hash冲突</a></li><li><a href="#threadlocalmap的get原理" class="table-of-contents__link toc-highlight">ThreadLocalMap的get原理</a></li><li><a href="#threadlocalmap的set原理" class="table-of-contents__link toc-highlight">ThreadLocalMap的set原理</a></li><li><a href="#threadlocalmap清理机制" class="table-of-contents__link toc-highlight">ThreadLocalMap清理机制</a><ul><li><a href="#探测式清理" class="table-of-contents__link toc-highlight">探测式清理</a><ul><li><a href="#replacestaleentry" class="table-of-contents__link toc-highlight">replaceStaleEntry()</a></li><li><a href="#expungestaleentry" class="table-of-contents__link toc-highlight">expungeStaleEntry()</a></li></ul></li><li><a href="#启发式清理" class="table-of-contents__link toc-highlight">启发式清理</a></li></ul></li><li><a href="#threadlocalmap扩容机制" class="table-of-contents__link toc-highlight">ThreadLocalMap扩容机制</a></li></ul></li><li><a href="#threadlocal的多线程继承" class="table-of-contents__link toc-highlight">ThreadLocal的多线程继承</a><ul><li><a href="#inheritablethreadlocal" class="table-of-contents__link toc-highlight">InheritableThreadLocal</a></li><li><a href="#transmittablethreadlocal" class="table-of-contents__link toc-highlight">TransmittableThreadLocal</a><ul><li><a href="#ttl使用教程" class="table-of-contents__link toc-highlight">TTL使用教程</a></li><li><a href="#核心原理介绍" class="table-of-contents__link toc-highlight">核心原理介绍</a></li></ul></li></ul></li><li><a href="#参考资料" class="table-of-contents__link toc-highlight">参考资料</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Notes</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/java">Java</a></li><li class="footer__item"><a class="footer__link-item" href="/ai">AI</a></li></ul></div><div class="col footer__col"><div class="footer__title">E-mail</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:vyckeyolyland@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Google E-mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:vyckey@qq.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">QQ E-mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/vyckey/vyckey-computer-notes" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Vyckey's Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>