<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-java docs-version-current docs-doc-page docs-doc-id-java/concurrent/lock" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Lock | Vyckey Computer Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://hoily.site/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://hoily.site/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://hoily.site/java/java/concurrent/lock"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-java-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-java-current"><meta data-rh="true" property="og:title" content="Lock | Vyckey Computer Notes"><meta data-rh="true" name="description" content="在多线程或多进程中访问共享资源，如果没有锁会导致程序出现不可预期的问题，数据不一致，并发死锁等问题。"><meta data-rh="true" property="og:description" content="在多线程或多进程中访问共享资源，如果没有锁会导致程序出现不可预期的问题，数据不一致，并发死锁等问题。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="http://hoily.site/java/java/concurrent/lock"><link data-rh="true" rel="alternate" href="http://hoily.site/java/java/concurrent/lock" hreflang="en"><link data-rh="true" rel="alternate" href="http://hoily.site/java/java/concurrent/lock" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Vyckey Computer Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Vyckey Computer Notes Atom Feed"><link rel="stylesheet" href="/assets/css/styles.500dd4b8.css">
<script src="/assets/js/runtime~main.f9b04792.js" defer="defer"></script>
<script src="/assets/js/main.02b7b6d4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.jpeg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.jpeg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Vyckey Notes</b></a><a class="navbar__item navbar__link" href="/docs/">Computer</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/database">Database</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/database/mysql">MySQL</a></li><li><a class="dropdown__link" href="/database/redis">Redis</a></li><li><a class="dropdown__link" href="/database/elasticsearch">ES</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/java">Java</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/middleware">Middleware</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/middleware/rpc/dubbo">Dubbo</a></li><li><a class="dropdown__link" href="/middleware/mq/kafka">Kafka</a></li></ul></div><a class="navbar__item navbar__link" href="/bigdata">Bigdata</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/ai">AI</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/ai/deeplearning/transformer">Transformer</a></li><li><a class="dropdown__link" href="/ai/deeplearning/models">Models</a></li></ul></div><a class="navbar__item navbar__link" href="/frontend">Frontend</a><a class="navbar__item navbar__link" href="/material">Material</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/vyckey/vyckey-computer-notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/java/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/java/java/">Java</a><button aria-label="Collapse sidebar category &#x27;Java&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/java/java/collection/">Collection</a><button aria-label="Expand sidebar category &#x27;Collection&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/io/">IO</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/java/java/concurrent/">Concurrent</a><button aria-label="Collapse sidebar category &#x27;Concurrent&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/atomic">Atomic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/completablefuture">CompletableFuture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/java/java/concurrent/lock">Lock</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/thread">Thread</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/threadlocal">ThreadLocal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/transmittable_threadlocal">Transimittable ThreadLocal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/aqs">AQS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/program">Program</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/threadpool">ThreadPool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/java/java/concurrent/threadpool_in_action">ThreadPool In Action</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/java/java/jvm/">JVM</a><button aria-label="Expand sidebar category &#x27;JVM&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/java/java/more/jni">more</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/java/java/util/date">util</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/java/framework/">Framework</a><button aria-label="Expand sidebar category &#x27;Framework&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/java/library/">Library</a><button aria-label="Expand sidebar category &#x27;Library&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/java/tools/">Tools</a><button aria-label="Expand sidebar category &#x27;Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/java/java/"><span itemprop="name">Java</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/java/java/concurrent/"><span itemprop="name">Concurrent</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lock</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>锁有什么用？</h1>
<p>在多线程或多进程中访问共享资源，如果没有锁会导致程序出现不可预期的问题，数据不一致，并发死锁等问题。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="乐观锁和悲观锁">乐观锁和悲观锁<a href="#乐观锁和悲观锁" class="hash-link" aria-label="Direct link to 乐观锁和悲观锁" title="Direct link to 乐观锁和悲观锁">​</a></h2>
<p><strong>乐观锁</strong>和<strong>悲观锁</strong>是并发控制中的两种不同的策略。</p>
<ul>
<li><strong>乐观锁</strong>：假设并发冲突的概率很小，因此在读取数据时不加锁，只有在更新数据时才进行锁定。 在更新数据时，先读取数据，判断数据是否被其他线程修改过，如果没有则进行更新，否则放弃更新并进行重试。<strong>乐观锁适用于读多写少的场景，可以提高并发性能。</strong></li>
<li><strong>悲观锁</strong>：假设并发冲突的概率很大，因此在读取数据时就进行锁定，防止其他线程修改数据。在更新数据时，先进行锁定，然后进行更新，更新完成后释放锁。<strong>悲观锁适用于写多读少的场景，可以保证数据的一致性。</strong></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="乐观锁的实现方法">乐观锁的实现方法<a href="#乐观锁的实现方法" class="hash-link" aria-label="Direct link to 乐观锁的实现方法" title="Direct link to 乐观锁的实现方法">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="版本号">版本号<a href="#版本号" class="hash-link" aria-label="Direct link to 版本号" title="Direct link to 版本号">​</a></h4>
<p>版本号实现乐观锁的要点：当版本相等或大于时更新。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> xxx_table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">version</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">version</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">version</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> ${some_version}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>假设有一个用户表，其中包含用户的基本信息和版本号字段。当用户信息被修改时，版本号会自动加1。在更新用户信息时，使用版本号实现乐观锁可以避免并发修改导致数据不一致的问题。</p>
<p>例如，假设用户A的信息如下：</p>
<table><thead><tr><th>id</th><th>name</th><th>age</th><th>version</th></tr></thead><tbody><tr><td>1</td><td>Tom</td><td>20</td><td>1</td></tr></tbody></table>
<p>此时，用户B也想修改用户A的信息，并且同时发起了更新请求，此时用户A和用户B的信息如下：</p>
<table><thead><tr><th>id</th><th>name</th><th>age</th><th>version</th><th>success</th></tr></thead><tbody><tr><td>1</td><td>Tom</td><td>20</td><td>2</td><td>true</td></tr><tr><td>1</td><td>Tom</td><td>20</td><td>1</td><td>false</td></tr></tbody></table>
<p>假设用户A的信息被先更新了，此时版本号变成了2，用户B的更新请求会失败，因为版本号不一致。此时用户B需要重新获取最新的版本号，并且重新发起更新请求。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cas算法">CAS算法<a href="#cas算法" class="hash-link" aria-label="Direct link to CAS算法" title="Direct link to CAS算法">​</a></h4>
<p>CAS（Compare and Swap）算法是一种并发控制算法，用于解决多线程并发访问共享资源时的数据一致性问题。它通过比较共享变量的值和期望值是否相等来判断是否有其他线程已经修改了共享变量的值，如果相等，则将共享变量的值修改为新值，否则不做任何操作。CAS算法是一种乐观锁，它不需要像悲观锁一样在每次访问共享资源时都进行加锁和解锁操作，因此可以提高并发性能。CAS算法常用于实现无锁数据结构和并发控制。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CAS(V,E,N) // 其中V：需要操作的共享变量，E：预期值，N：新值</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当且仅当 V 的值等于 A 时，CAS通过原子方式用新值B来更新 V 的值，否则不会执行任何操作（比较和替换是一个原子操作）。一般情况下是一个自旋操作，即不断的重试。一般来说，会有CPU的原子指令来支持CAS操作。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="什么是aba问题">什么是ABA问题？<a href="#什么是aba问题" class="hash-link" aria-label="Direct link to 什么是ABA问题？" title="Direct link to 什么是ABA问题？">​</a></h5>
<p>ABA问题是指当一个线程A读取该变量的值，然后另一个线程B修改了该变量的值并将其改回原来的值，最后线程A再次读取该变量的值时，它会发现该变量的值没有发生变化，因此认为没有其他线程修改过该变量，而实际上变量的值已经被修改了。这种情况称为ABA问题，因为变量的值从A变成了B再变回A。ABA问题可能会导致程序出现错误，例如在CAS（Compare and Swap）操作中，它  可能会误判变量的值没有发生变化，从而造成线程安全问题。为了解决ABA问题，可以采用版本号等机制来避免。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="自旋锁详解">自旋锁详解<a href="#自旋锁详解" class="hash-link" aria-label="Direct link to 自旋锁详解" title="Direct link to 自旋锁详解">​</a></h5>
<p>自旋是一种如果出现线程竞争，但是此处的逻辑线程执行起来非常快，某些没有获取到资源的线程也能在不久后的将来获取到资源并执行时，OS让没有获取到资源的线程执行几个<strong>空循环</strong>的操作等待资源的情况。而自旋这种操作也的确可以提升效率，因为自旋锁只是在逻辑上阻塞了线程，在用户态的情况下让线程停止了执行，<strong>并没有真正意义上在内核态中挂起对应的内核线程</strong>，从而可以减少很多内核挂起/放下线程耗费的资源。但问题是<strong>当线程越来越多竞争很激烈时，占用CPU的时间变长会导致性能急剧下降</strong>，因此Java虚拟机内部一般对于自旋锁有一定的次数限制，可能是50或者100次循环后就放弃，直接让OS挂起内核线程，让出CPU资源。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="只能保证一个共享变量的原子操作">只能保证一个共享变量的原子操作<a href="#只能保证一个共享变量的原子操作" class="hash-link" aria-label="Direct link to 只能保证一个共享变量的原子操作" title="Direct link to 只能保证一个共享变量的原子操作">​</a></h5>
<p>当对一个共享变量执行操作时CAS能保证其原子性，如果对多个共享变量进行操作,CAS就不能保证其原子性。有一个解决方案是利用对象整合多个共享变量，即一个类中的成员变量就是这几个共享变量。然后将这个对象做CAS操作就可以保证其原子性。atomic中提供了 <code>AtomicReference</code> 来保证引用对象之间的原子性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="悲观锁">悲观锁<a href="#悲观锁" class="hash-link" aria-label="Direct link to 悲观锁" title="Direct link to 悲观锁">​</a></h3>
<p>Java中的悲观锁有以下几种：</p>
<ol>
<li><code>synchronized</code> 关键字：通过在方法或代码块前加上 <code>synchronized</code> 关键字，实现对共享资源的互斥访问。</li>
<li><code>ReentrantLock</code> 类：<code>ReentrantLock</code> 是JDK提供的一种可重入锁，它提供了比 <code>synchronized</code> 更多的灵活性和功能，如可中断锁、公平锁等。</li>
<li><code>Semaphore</code> 类： <code>Semaphore</code> 是一种计数信号量，它可以控制同时访问某个资源的线程数量。</li>
<li><code>ReadWriteLock</code> 接口： <code>ReadWriteLock</code> 接口提供了读写锁的实现，它允许多个线程同时读取共享资源，但只允许一个线程写入共享资源，从而提高了并发性能。</li>
<li><code>StampedLock</code> 类： <code>StampedLock</code> 是JDK8新增的一种锁机制，它支持乐观读、悲观读和写锁，可以根据实际情况选择不同的锁机制来提高并发性能。</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="synchronized">synchronized<a href="#synchronized" class="hash-link" aria-label="Direct link to synchronized" title="Direct link to synchronized">​</a></h2>
<p><code>synchronized</code> 是Java中的关键字，用于实现同步机制。当一个方法或代码块被 <code>synchronized</code> 修饰时，它在同一时刻只能被一个线程访问，其他线程需要等待。这样可以保证多个线程访问共享资源时的数据安全性和一致性。 <code>synchronized</code> 可以用于修饰方法、代码块和静态方法。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用场景">使用场景<a href="#使用场景" class="hash-link" aria-label="Direct link to 使用场景" title="Direct link to 使用场景"> ​</a></h3>
<ul>
<li>实例方法：<code>public synchronized void func() {}</code> 。</li>
<li>静态方法：<code>public static synchronized void func() {}</code> 。</li>
<li>实例代码块：<code>synchronized(this) {}</code> 。</li>
<li>静态代码块：<code>synchronized(SomeClass.class) {}</code> 。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="反编译synchronized加以理解">反编译synchronized加以理解<a href="#反编译synchronized加以理解" class="hash-link" aria-label="Direct link to 反编译synchronized加以理解" title="Direct link to 反编译synchronized加以理解">​</a></h3>
<p>现在来进一步分析synchronized的具体底层实现，编写如下示例代码：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SynchronizedTest</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">method1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;synchronized method&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">method2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SynchronizedTest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;synchronized block&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用 <code>javap -v SynchronizedTest.class</code> 命令查看字节码信息，下面是精简过的字节码信息：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public synchronized void method1();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    descriptor: ()V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flags: ACC_PUBLIC, ACC_SYNCHRONIZED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Code:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stack=2, locals=1, args_size=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         3: ldc           #3                  // String synchronized method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         8: return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void method2();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    descriptor: ()V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flags: ACC_PUBLIC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Code:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stack=2, locals=3, args_size=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         0: ldc           #5                  // class com/hoily/service/whale/infrastructure/SynchronizedTest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2: dup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         3: astore_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         4: monitorenter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         5: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         8: ldc           #6                  // String synchronized block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        10: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        13: aload_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        14: monitorexit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        15: goto          23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        18: astore_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        19: aload_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        20: monitorexit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        21: aload_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        22: athrow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        23: return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Exception table:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         from    to  target type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             5    15    18   any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            18    21    18   any</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于同步方法，没有特别的指令标识，但方法有一个 <code>ACC_SYNCHRONIZED</code> 的标识。</p>
<p>对于同步代码块，使用 <code>monitorenter</code> 指令获得锁，然后指定同步中代码块，最后通过 <code>monitorexit</code> 释放锁。</p>
<p>关于 <code>monitor</code> 指令，详见<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorenter" target="_blank" rel="noopener noreferrer">链接</a></p>
<p>每个对象都与一个监视器相关联。 当且仅当监视器有所有者时，它才会被锁定。 执行 <code>monitorenter</code> 的线程试图获得与 <code>objectref</code> 关联的监视器的所有权，如下所示：</p>
<ol>
<li>如果与 <code>objectref</code> 关联的监视器的条目计数为零，则线程进入监视器并将其条目计数设置为一。 线程就是监视器的所有者。</li>
<li>如果线程已经拥有与 <code>objectref</code> 关联的监视器，它会重新进入监视器，并增加其条目计数。</li>
<li>如果另一个线程已经拥有与 <code>objectref</code> 关联的监视器，则该线程将阻塞，直到监视器的条目计数为零，然后再次尝试获得所有权。</li>
</ol>
<p>关于 <code>monitorexit</code> 指令，详见<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorexit" target="_blank" rel="noopener noreferrer">链接</a></p>
<ol>
<li>执行 <code>monitorexit</code> 的线程必须是与 <code>objectref</code> 引用的实例关联的监视器的所有者。</li>
<li>线程递减与 <code>objectref</code> 关联的监视器的条目计数。 如果结果是条目计数的值为零，则线程退出监视器并且不再是它的所有者。 其他阻塞进入监视器的线程被允许尝试这样做。</li>
</ol>
<p>关于 <code>ACC_SYNCHRONIZED</code> ，详见<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.11.10" target="_blank" rel="noopener noreferrer">链接</a></p>
<ol>
<li>作为方法调用和返回的一部分，方法级同步是隐式执行的。 同步方法在运行时常量池的 <code>method_info</code> 结构中通过 <code>ACC_SYNCHRONIZED</code> 标志进行区分，该标志由方法调用指令检查。</li>
<li>当调用设置了 <code>ACC_SYNCHRONIZED</code> 的方法时，执行线程进入监视器，调用方法本身，然后退出监视器，无论方法调用是正常完成还是突然完成。 在执行线程拥有监视器期间，没有其他线程可以进入它。 如果在调用 <code>synchronized</code> 方法时抛出异常，并且 <code>synchronized</code> 方法没有处理该异常，则在 <code>synchronized</code> 方法重新抛出异常之前自动退出该方法的监视器。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monitor监视器">monitor监视器<a href="#monitor监视器" class="hash-link" aria-label="Direct link to monitor监视器" title="Direct link to monitor监视器">​</a></h3>
<p>Monitor监视器可以理解为一种同步工具，或者说是同步机制，它通常被描述成一个对象。操作系统的<strong>管程</strong>是概念原理， <code>ObjectMonitor</code> 是它的原理实现。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="操作系统的管程">操作系统的管程<a href="#操作系统的管程" class="hash-link" aria-label="Direct link to 操作系统的管程" title="Direct link to 操作系统的管程">​</a></h4>
<ul>
<li>管程是一种程序结构，结构内的多个子程序（对象或模块）形成的多个工作线程互斥访问共享资源。</li>
<li>这些共享资源一般是硬件设备或一群变量。管程实现了在一个时间点，最多只有一个线程在执行管程的某个子程序。</li>
<li>与那些通过修改数据结构实现互斥访问的并发程序设计相比，管程实现很大程度上简化了程序设计。</li>
<li>管程提供了一种机制，线程可以临时放弃互斥访问，等待某些条件得到满足后，重新获得执行权恢复它的互斥访问。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="objectmonitor">ObjectMonitor<a href="#objectmonitor" class="hash-link" aria-label="Direct link to ObjectMonitor" title="Direct link to ObjectMonitor">​</a></h4>
<p>每个对象都存在一个与之关联的monitor，线程对monitor持有的方式以及持有时机决定了 <code>synchronized</code> 的锁状态以及 <code>synchronized</code> 的 状态升级方式。monitor是通过C++中 <code>ObjectMonitor</code> 实现，代码可以通过<a href="https://hg.openjdk.org/jdk8u/jdk8u/hotspot/" target="_blank" rel="noopener noreferrer">openjdk hotspot链接</a>进行下载openjdk中hotspot版本的源码，具体文件路径在 <code>src\share\vm\runtime\objectMonitor.hpp</code> ，具体源码为：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// initialize the monitor, exception the semaphore, all other fields</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// are simple integers or pointers​</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ObjectMonitor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _header       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _count        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 记录owner线程获取锁的次数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _waiters      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _recursions   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 锁的重入次数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _object       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _owner        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 指向持有ObjectMonitor的对象的线程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">_WaitSet</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 存放处于wait状态的线程队列</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _WaitSetLock  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _Responsible  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _succ         </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _cxq          </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FreeNext      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">_EntryList</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 存放处于鞥带锁block状态的线程队列</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _SpinFreq     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _SpinClock    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OwnerIsThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _previous_owner_tid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>工作原理</strong></p>
<p>Java Monitor 的工作机理如图所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/object_monitor-800f758a5bd9867741efcaf1b8ecbf99.awebp" width="1304" height="779" class="img_ev3q"></p>
<ol>
<li>想要获取 <code>monitor</code> 的线程,首先会进入 <code>_EntryList</code> 队列。</li>
<li>当某个线程获取到对象的 <code>monitor</code> 后,进入 <code>_Owner</code> 区  域，设置为当前线程,同时计数器 <code>_count</code> 加 <code>1</code>。</li>
<li>如果线程调用了 <code>wait()</code> 方法，则会进入 <code>_WaitSet</code> 队列。它会释放 <code>monitor</code> 锁，即 <code>_owner</code> 赋值为 <code>null</code> , <code>_count</code> 自减 <code>1</code> ,进入 <code>_WaitSet</code> 队列阻塞等待。</li>
<li>如果其他线程调用 <code>notify()</code> / <code>notifyAll()</code> ，会唤醒 <code>_WaitSet</code> 中的某个线程，该线程再次尝试获取 <code>monitor</code> 锁，成功即进入 <code>_Owner</code> 区域。</li>
<li>同步方法执行完毕了，线程退出临界区，会将 <code>monitor</code> 的 <code>owner</code> 设为 <code>null</code>，并释放监视锁。</li>
</ol>
<p>上述的过程等价于：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">synchronized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//进入_EntryList队列</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// do something</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//进入_WaitSet队列</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="对象与objectmonitor的关联">对象与ObjectMonitor的关联<a href="#对象与objectmonitor的关联" class="hash-link" aria-label="Direct link to 对象与ObjectMonitor的关联" title="Direct link to 对象与ObjectMonitor的关联">​</a></h4>
<p>对象是如何跟monitor关联的呢？直接先看图：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/object_monitor__object-c68fec16da448de224bde38627620866.awebp" width="1214" height="1003" class="img_ev3q"></p>
<p>对象头主要包括两部分数据：</p>
<ul>
<li><strong>Mark Word</strong> : 用于存储对象自身的运行时数据，它是实现轻量级锁和偏向锁的关键。</li>
<li><strong>Class Pointer</strong> : 是对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例</li>
</ul>
<p><strong>Mark Word</strong> 用于存储对象自身的运行时数据，如哈希码（HashCode）、GC分代年龄、锁状态标志、线程持有的锁、偏向线程 ID、偏向时间戳等。</p>
<p>在32位的HotSpot虚拟机中，如果对象处于未被锁定的状态下，那么<strong>Mark Word</strong>的32bit空间里的25位用于存储对象哈希码，4bit用于存储对象分代年龄，2bit用于存储锁标志位，1bit固定为0，表示非偏向锁。其他状态如上图所示。</p>
<p><code>synchronized</code> 是重量级锁，也就是说 <code>synchronized</code> 的对象锁，<strong>Mark Word</strong>锁标识位为 <code>10</code> ，其中指针指向的是Monitor对象的起始地址。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="锁类型">锁类型<a href="#锁类型" class="hash-link" aria-label="Direct link to 锁类型" title="Direct link to 锁类型">​</a></h3>
<p>Java 提供了很方便的线程同步的内置锁 <code>synchronized</code> ，可以极大地简化并发模型。但早期 <code>synchronized</code> 的实现性能较低，比较耗费资源，Java 6 之后对 <code>synchronized</code> 的实现做了进一步的升级和优化，提高了并发性能。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="偏向锁">偏向锁<a href="#偏向锁" class="hash-link" aria-label="Direct link to 偏向锁" title="Direct link to 偏向锁">​</a></h4>
<p>偏向锁解决优化锁性能的<strong>出发点是“不存在多线程锁竞争，总是由同一线程获取锁的”</strong> 经验数据。</p>
<p>偏向锁的处理过程是，如果一个线程获得了锁，那么锁就进入偏向模式，此时 <code>Mark Word</code> 的结构也变为偏向锁结构，当这个线程再次请求锁时，无需再做任何同步操作，即获取锁的过程，这样就省去了大量有关锁申请的操作，从而也就提供程序的性能。换句通俗易懂的话说：偏向锁其中的“偏”是偏心的偏。它的意思就是说，这个锁会<strong>偏向于第一个获得它的线程，在接下来的执行过程中，假如该锁没有被其他线程所获取，没有其他线程来竞争该锁，那么持有偏向锁的线程将永远不需要进行同步操作</strong>。在此线程之后的执行过程中，如果再次进入或者退出同一段同步块代码，并不再需要去进行加锁或者解锁操作，而是会做以下的步骤：</p>
<ol>
<li>Load-and-test，也就是简单判断一下当前线程id是否与Markword当中的线程id是否一致。</li>
<li>如果一致，则说明此线程已经成功获得了锁，继续执行下面的代码。</li>
<li>如果不一致，则要检查一下对象是否还是可偏向，即“是否偏向锁”标志位的值。</li>
<li>如果还未偏向，则利用CAS操作来竞争锁，也即是第一次获取锁时的操作。</li>
</ol>
<p>但是当第二个线程来尝试获取锁时，如果此对象已经偏向了，并且不是偏向自己，则说明存在了竞争。此时会根据该锁的线程竞争情况，可能会产生偏向撤销，重新偏向，但大部分情况下就是膨胀成轻量级锁了。所以，对于没有锁竞争的场合，偏向锁有很好的优化效果，毕竟极有可能连续多次是同一个线程申请相同的锁。但是对于锁竞争比较激烈的场合，偏向锁就失效了，因为这样场合极有可能每次申请锁的线程都是不相同的，因此这种场合下不应该使用偏向锁，否则会得不偿失。</p>
<p><strong>偏向锁膨胀过程</strong></p>
<ol>
<li>当第一个线程进入的时候发现是匿名偏向状态，则会用 <code>CAS</code> 指令把 <code>mark word</code> 中的 <code>threadid</code> 替换为当前线程的id如果替换成功，则证明成功拿到锁，失败则锁膨胀;</li>
<li>当线程第二次进入同步块时，如果发现线程id和对象头中的偏向 线程id一致，则经过一些比较之后，在当前线程栈的 <code>lock record</code> 中添加一个空的 <code>Displaced Mark Word</code> ，由于操作的是私有线程栈，所以不需要 <code>CAS</code> 操作， <code>synchronized</code> 带来的开销基本可以忽略;</li>
<li>当其他线程进入同步块中时，发现偏向线程不是当前线程，则进入到撤销偏向锁的逻辑，当达到全局安全点时，锁开始膨胀为轻量级锁，原来的线程仍然持有锁，如果发现偏向线程挂了，那么就把偏向锁撤销，并将对象头内的 <code>MarkWord</code> 改为无锁状态，锁膨胀，</li>
<li>但是需要注意的是，偏向锁失败后，并不会立即膨胀为重量级锁，而是先升级为轻量级锁。</li>
</ol>
<p><strong>偏向锁撤销过程</strong></p>
<ol>
<li>在一个安全点停止拥有锁的线程。</li>
<li>遍历线程栈，如果存在锁记录的话，需要修复锁记录和 <code>Markword</code> ，使其变成无锁状态。</li>
<li>唤醒当前线程，将当前锁升级成轻量级锁。</li>
</ol>
<p>所以，如果程序中大量同步代码块大多数情况下都是有两个及以上的线程竞争的话，那么偏向锁就会是一种累赘，对于这种情况，我们可以一开始就通过 <code>XX:-UseBiasedLocking</code> 把偏向锁这个默认功能给关闭，从而做到性能上的优化。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="轻量级锁">轻量级锁<a href="#轻量级锁" class="hash-link" aria-label="Direct link to 轻量级锁" title="Direct link to 轻量级锁">​</a></h4>
<p>倘若偏向锁失败，<code>synchronized</code> 并不会立即升级为重量级锁，它还会尝试使用一种称为轻量级锁的优化手段，此时 <code>MarkWord</code> 的结构也变为轻量级锁的结构。</p>
<p>轻量级锁能够提升锁性能的<strong>出发点是“对绝大部分的锁，在整个同步周期内都不存在竞争”</strong>，这个依据是根据一些经验得到的。</p>
<p><strong>轻量级锁膨胀过程</strong></p>
<p>当锁膨胀为轻量级锁时，首先判断是否有线程持有锁(判断 <code>mark work</code>)，如果是，则在当前线程栈中创建一个 <code>lock record</code> 复制 <code>mark word</code>并且 <code>CAS</code> 的把当前线程栈的 <code>lock record</code> 的地址放到对象头中(细节：之前持有偏向锁的线程会优先进行 <code>CAS</code> 并将锁信息指针更改到对象头内 <code>mark word</code> 中)，如果成功，则说明获取到轻量级锁，如果失败，则说明锁已经被占用了，此时记录线程的重入次数(把 <code>lock record</code> 的 <code>mark word</code> 设置为 <code>null</code> )，锁会自旋（自适应自旋），确保在竞争不激烈的情况下仍然可以不膨胀为重量级锁从而减少消耗，如果 <code>CAS</code> 失败，则说明线程出现竞争，需要膨胀为重量级的锁。</p>
<p>轻量级锁主要有两种类型：</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="自旋锁">自旋锁<a href="#自旋锁" class="hash-link" aria-label="Direct link to 自旋锁" title="Direct link to 自旋锁">​</a></h5>
<p>自旋锁是指当一个线程尝试获取某个锁时，如果该锁已被其他线程占用，就<strong>一直循环检测锁是否被释放</strong>，而不是进入线程挂起或睡眠状态，避免了内核态与用户态的切换，线程阻塞与线程切换，很大程度地提高了锁的性能。</p>
<p>当然，自旋锁也是有适用范围的，自旋锁适用于锁保护的临界区很小的情况，临界区很小的话，锁占用的时间就很短。对于竞争线程多处理器少，大量线程自旋会比较浪费。自旋锁也会占用CPU，对于计算密集型任务，也会比较占用资源。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="自适应自旋锁">自适应自旋锁<a href="#自适应自旋锁" class="hash-link" aria-label="Direct link to 自适应自旋锁" title="Direct link to 自适应自旋锁">​</a></h5>
<p><strong>自适应自旋解决的是“锁竞争时间不确定”的问题</strong>。JVM很难感知到确切的锁竞争时间，而交给用户分析就违反了JVM的设计初衷。自适应自旋假定不同线程持有同一个锁对象的时间基本相当，竞争程度趋于稳定，因此，可以根据上一次自旋的时间与结果调整下一次自旋的时间。可以参考如下策略：</p>
<ul>
<li>如果在同一个锁对象上，自旋等待刚刚成功获得过锁，并且持有锁的线程正在运行中，那么虚拟机就会认为这次自旋也很有可能再次成功，进而它将允许自旋等待持续相对更长的时间，比如100个循环。</li>
<li>相反的，如果对于某个锁，自旋很少成功获得过，那在以后要获取这个锁时将可能减少自旋时间甚至省略自旋过程，以避免浪费处理器资源。</li>
</ul>
<p>然而，自适应自旋也不能彻底地解决竞争时间不确定的问题，如果默认的自旋次数设置不合理（过高或过低），那么自适应的过程将很难收敛到合适的值。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="重量级锁">重量级锁<a href="#重量级锁" class="hash-link" aria-label="Direct link to 重量级锁" title="Direct link to 重量级锁">​</a></h4>
<p>在JDK 1.6之前， <code>synchronized</code> 的实现使用了监视器模型（monitor），监视器锁可以认为直接对应底层操作系统中的互斥量（mutex）。这种同步方式的成本非常高，包括系统调用引起的内核态与用户态切换、线程阻塞造成的线程切换等。因此被称这种锁为“重量级锁”。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="样例代码分析">样例代码分析<a href="#样例代码分析" class="hash-link" aria-label="Direct link to 样例代码分析" title="Direct link to 样例代码分析">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ObjectHead</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/** </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        无锁态：虚拟机刚启动时 new 出来的对象处于无锁状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Object</span><span class="token plain"> obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 查看对象内部信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parseInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toPrintable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/** </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        匿名偏向锁：休眠4S后再创建出来的对象处于匿名偏向锁状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        PS：当一个线程在执行被synchronized关键字修饰的代码或方法时，如果看到该锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        对象是处于匿名偏向锁状态的（标志位为偏向锁但是对象头中MrakWord内threadID</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        为空），那么这个线程将会利用cas机制把自己的线程ID设置到mrakword中，此后</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        如果没有其他线程来竞争该锁，那么这个线程再执行被需要获取该锁的代码将不需</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        要经过任何获取锁和释放锁的过程。</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Object</span><span class="token plain"> obj1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parseInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toPrintable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/** </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        轻量级锁：对于真正的无锁态对象obj加锁之后的对象处于轻量级锁状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 查看对象内部信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parseInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toPrintable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/** </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        重量级锁：调用wait方法之后锁对象直接膨胀为重量级锁状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 查看对象内部信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parseInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toPrintable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>输出结果：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.Object object internals:  锁标志位状态：001：真正意义上无锁状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      8     4        (object header)                           e5 01 00 20 (11100101 00000001 00000000 00100000) (536871397)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     12     4        (loss due to the next object alignment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Instance size: 16 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.Object object internals:  锁标志位状态：101：匿名偏向锁状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      8     4        (object header)                           e5 01 00 20 (11100101 00000001 00000000 00100000) (536871397)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     12     4        (loss due to the next object alignment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Instance size: 16 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.Object object internals:  锁标志位状态：000：轻量级锁状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      0     4        (object header)                           18 f5 41 01 (00011000 11110101 01000001 00000001) (21099800)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      8     4        (object header)                           e5 01 00 20 (11100101 00000001 00000000 00100000) (536871397)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     12     4        (loss due to the next object alignment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Instance size: 16 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.Object object internals:  锁标志位状态：010：重量级锁状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      0     4        (object header)                           5a de db 17 (01011010 11011110 11011011 00010111) (400285274)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      8     4        (object header)                           e5 01 00 20 (11100101 00000001 00000000 00100000) (536871397)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     12     4        (loss due to the next object alignment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Instance size: 16 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**抛出异常原因：违法的监控状态异常。当某个线程试图等待一个自己并不拥有的对象（Obj）的监控器或者通知其他线程等待该对象（Obj）的监控器时，抛出该异常。**/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Exception in thread &quot;Thread-0&quot;: java.lang.IllegalMonitorStateException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.lang.Object.wait(Native Method)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.lang.Object.wait(Object.java:502)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.sixstar.springbootvolatilesynchronized.Synchronized.ObjectHead.lambda$main$0(ObjectHead.java:27)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.lang.Thread.run(Thread.java:748)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="三种锁的总结">三种锁的总结<a href="#三种锁的总结" class="hash-link" aria-label="Direct link to 三种锁的总结" title="Direct link to 三种锁的总结">​</a></h4>
<table><thead><tr><th>锁类型</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>偏向锁</td><td>加锁和解锁不需要额外的消耗，和执行非同步代码相比仅存在纳秒级别的差距</td><td>如果线程间存在锁竞争，会带来额外的锁撤销的消耗</td><td>适用只有一个线程访问的同步块场景</td></tr><tr><td>轻量级锁</td><td>竞争的线程不会阻塞，提高了程序的相应速度</td><td>如果始终得不到锁竞争的线程，使用自旋会消耗CPU</td><td>追求响应时间，同步块执行非常快</td></tr><tr><td>重量级锁</td><td>线程竞争不使用自旋，不会消耗CPU</td><td>线程阻塞，相应时间缓慢</td><td>追求吞吐量，同步块执行较慢</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="锁优化">锁优化<a href="#锁优化" class="hash-link" aria-label="Direct link to 锁优化" title="Direct link to 锁优化">​</a></h3>
<p>在JDK1.6之前， <code>synchronized</code> 的实现才会直接调用 <code>ObjectMonitor</code> 的enter和exit，这种锁被称之为重量级锁。从JDK6开始，HotSpot虚拟机开发团队对Java中的锁进行优化，如增加了适应性自旋、锁消除、锁粗化、轻量级锁和偏向锁等优化策略。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="锁消除">锁消除<a href="#锁消除" class="hash-link" aria-label="Direct link to 锁消除" title="Direct link to 锁消除">​</a></h4>
<p>锁削除是指虚拟机即时编译器在运行时，对一些代码上要求同步，但是被检测到不可能存在共享数据竞争的锁进行削除。</p>
<p>日常代码开发中，有一些开发者，在没并发情况下，也使用加锁。如没并发可能，直接上来就 <code>ConcurrentHashMap</code> 。这种情况下锁消除就可以避免锁的资源消耗。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="锁粗化">锁粗化<a href="#锁粗化" class="hash-link" aria-label="Direct link to 锁粗化" title="Direct link to 锁粗化">​</a></h4>
<p>锁粗话概念比较好理解，就是将<strong>多个连续的加锁、解锁操作连接在一起</strong>，扩展成一个范围更大的锁。</p>
<p>为何需要锁租化？在使用同步锁的时候，需要让同步块的作用范围尽可能小—仅在共享数据的实际作用域中才进行同步，这样做的目的是 为了使需要同步的操作数量尽可能缩小，如果存在锁竞争，那么等待锁的线程也能尽快拿到锁。但是如果一系列的连续加锁解锁操作，可能会导致不必要的性能损耗，所以引入锁粗话的概念。</p>
<p>锁租化比喻，举个例子，买门票进动物园。老师带一群小朋友去参观，验票员如果知道他们是个集体，就可以把他们看成一个整体（锁租化），一次性验票过，而不需要一个个找他们验票。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="object中的内置锁">Object中的内置锁<a href="#object中的内置锁" class="hash-link" aria-label="Direct link to Object中的内置锁" title="Direct link to Object中的内置锁">​</a></h2>
<p>每个 <code>Object</code> 中，都存在两个池：</p>
<ul>
<li><strong>锁池(monitor set)</strong>：假设某个线程T正在持有某个对象的锁，其他线程想要执行这个对象的同步语句( <code>synchronized</code> )，亦即获取该对象的锁，则这个新的线程会进入锁池中，进行抢锁。</li>
<li><strong>等待池(wait set)</strong>：假设一个线程T调用了某个对象的 <code>wait()</code> 方法，线程T就会释放该对象的锁，同时线程T就进入到了该对象的等待池中。</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">native</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">notify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">native</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">notifyAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">native</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> nanos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="wait方法">wait()方法<a href="#wait方法" class="hash-link" aria-label="Direct link to wait()方法" title="Direct link to wait()方法">​</a></h3>
<p>导致<strong>当前线程等待</strong>，直到另外一个线程调用该对象的 <code>notify()</code> 或 <code>notifyAll()</code> 或达到一个指定的超时时间。</p>
<p>当前线程必须拥有该对象的监视器。</p>
<p>此方法导致当前线程（称为 T）将自身置于此对象的等待集中，然后放弃对此对象的任何和所有同步声明。 线程 T 出于线程调度目的而被禁用并处于休眠状态，直到发生以下四种情况之一：</p>
<ol>
<li><strong>某个其他线程调用了该对象的 <code>notify()</code> 方法，而线程 T 恰好被任意选择为要被唤醒的线程。</strong></li>
<li><strong>其他某个线程为此对象调用 <code>notifyAll()</code> 方法。</strong></li>
<li><strong>一些其他线程中断线程 T。</strong></li>
<li><strong>指定的实时时间或多或少已经过去。但是，如果超时为零，则不会考虑实时，线程只是等待直到收到通知。</strong></li>
</ol>
<p>然后从该对象的等待集中删除线程 T，并重新启用线程调度。 然后它以通常的方式与其他线程竞争在对象上同步的权利； 一旦它获得了对象的控制权，它对该对象的所有同步声明都将恢复到之前的状态——即，恢复到调用 <code>wait()</code> 方法时的状态。 线程 T 然后从 <code>wait()</code> 方法的调用返回。 因此，从 <code>wait()</code> 方法返回时，对象和线程 T 的同步状态与调用 <code>wait()</code> 方法时的状态完全相同。</p>
<p>线程也可以在没有被通知、中断或超时的情况下被唤醒，这就是所谓的<strong>虚假唤醒</strong>。 虽然这在实践中很少发生，但应用程序必须通过测试应该导致线程被唤醒的条件来防止它，如果条件不满足则继续等待。 换句话说，等待应该总是在循环中发生，就像这样：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">condition does not hold</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Perform action appropriate to condition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="notify方法">notify()方法<a href="#notify方法" class="hash-link" aria-label="Direct link to notify()方法" title="Direct link to notify()方法">​</a></h3>
<p><strong>唤醒</strong>在此对象的监视器上<strong>等待的单个线程</strong>。 如果有任何线程正在等待该对象，则选择唤醒其中一个线程。<strong>选择是任意的</strong>，由实现自行决定。 线程通过调用其中一种等待方法在对象的监视器上等待。</p>
<p>在当前线程放弃对该对象的锁定之前，被唤醒的线程将无法继续。被唤醒的线程将以通常的方式与可能正在积极竞争同步该对象的任何其他线程进行竞争。<code>notify</code> 后，当前线程不会马上释放该对象锁，<code>wait</code> 所在的线程并不能马上获取该对象锁，要等到程序退出 <code>synchronized</code> 代码块后，当前线程才会释放锁，<code>wait</code> 所在的线程也才可以获取该对象锁。</p>
<p>此方法只能由作为此对象监视器所有者的线程调用。 线程通过以下三种方式之一成为对象监视器的所有者：</p>
<ol>
<li>通过执行该对象的同步实例方法 <code>synchronized(this){}</code>。</li>
<li>通过执行在对象上同步的同步语句的主体 ``。</li>
<li>对于类类型的对象，通过执行该类的同步静态方法 <code>static synchronized(T.class)</code>。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="notifyall方法">notifyAll()方法<a href="#notifyall方法" class="hash-link" aria-label="Direct link to notifyAll()方法" title="Direct link to notifyAll()方法">​</a></h3>
<p>唤醒在此对象的监视器上等待的所有线程。 线程通过调用其中一种等待方法在对象的监视器上等待。</p>
<p>在当前线程放弃对该对象的锁定之前，被唤醒的线程将无法继续。 被唤醒的线程将以通常的方式与可能正在积极竞争同步该对象的任何其他线程进行竞争。此方法只能由作为此对象监视器所有者的线程调用。</p>
<p><code>notifyAll()</code> 使所有原来在该对象上 <code>wait()</code> 的线程统统退出 <code>wait()</code> 的状态（即全部被唤醒，不再等待 <code>notify()</code> 或 <code>notifyAll()</code>，但由于此时还没有获取到该对象锁，因此还不能继续往下执行），变成等待获取该对象上的锁，一旦该对象锁被释放（<code>notifyAll</code> 线程退出调用了 <code>notifyAll()</code> 的 <code>synchronized</code> 代码块的时候），他们就会去竞争。如果其中一个线程获得了该对象锁，它就会继续往下执行，在它退出 <code>synchronized</code> 代码块，释放锁后，其他的已经被唤醒的线程将会继续竞争获取该锁，一直进行下去，直到所有被唤醒的线程都执行完毕。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="waitnotifynotifyall为什么必须放在synchronized中">wait()、notify()、notifyAll()为什 么必须放在synchronized中？<a href="#waitnotifynotifyall为什么必须放在synchronized中" class="hash-link" aria-label="Direct link to wait()、notify()、notifyAll()为什么必须放在synchronized中？" title="Direct link to wait()、notify()、notifyAll()为什么必须放在synchronized中？">​</a></h3>
<p>JVM 在运行时会强制检查 <code>wait()</code> 和 <code>notify()</code> 有没有在 <code>synchronized</code> 代码中，如果没有的话就会报非法监视器状态异 <code>IllegalMonitorStateException</code> 。根本原因就是为了防止多线程并发运行时，程序的执行混乱问题。</p>
<p>假设 <code>wait()</code> 和 <code>notify()</code> 可以不加锁，我们用它们来实现一个自定义阻塞队列。 这里的阻塞队列是指读操作阻塞，也就是当读取数据时，如果有数据就返回数据，如果没有数据则阻塞等待数据。代码示例如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyBlockingQueue</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Queue</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">LinkedList</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 唤醒线程继续执行（这里的线程指的是执行 take 方法的线程）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">notify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ③</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * 如果队列里面有数据则返回数据，如果没有数据就阻塞等待数据（阻塞式执行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">take</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 使用 while 判断是否有数据（这里使用 while 而非 if 是为了防止虚假唤醒）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ①  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 没有任务，先阻塞等待</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ②</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 返回数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th>步骤</th><th>线程1</th><th>线程2</th></tr></thead><tbody><tr><td>1</td><td>执行步骤 ① 判断当前队列中没有数据</td><td></td></tr><tr><td>2</td><td></td><td>执行步骤 ③ 将数据添加到队列，并唤醒线程1继续执行</td></tr><tr><td>3</td><td>执行步骤 ② 线程 1 进入休眠状态</td><td></td></tr></tbody></table>
<p>如果不添加 <code>synchronized</code>，按照上面的步骤，线程 1 执行完判断之后，尚未执行休眠之前，此时另一个线程添加数据到队列中。然而这时线程 1 已经执行过判断了，所以就会直接进入休眠状态，从而导致队列中的那条数据永久性不能被读取。而添加了 <code>synchronized</code> 则不会出现这种问题。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="jdk-中内置的工具锁">JDK 中内置的工具锁<a href="#jdk-中内置的工具锁" class="hash-link" aria-label="Direct link to JDK 中内置的工具锁" title="Direct link to JDK 中内置的工具锁">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="锁的一些特性">锁的一些特性<a href="#锁的一些特性" class="hash-link" aria-label="Direct link to 锁的一些特性" title="Direct link to 锁的一些特性">​</a></h3>
<p>公平锁和非公平锁：</p>
<ul>
<li><strong>公平锁</strong>： 锁被释放之后，先申请的线程先得到锁。性能较差一些，因为公平锁为了保证时间上的绝对顺序，上下文切换更频繁。</li>
<li><strong>非公平锁</strong>：锁被释放之后，后申请的线程可能会先获取到锁，是随机或者按照其他优先级排序的。性能更好，但可能会导致某些线程永远无法获取到锁。</li>
</ul>
<p>共享锁和独占锁：</p>
<ul>
<li><strong>共享锁</strong>：一把锁可以被多个线程同时获得。</li>
<li><strong>独占锁</strong>：一把锁只能被一个线程获得。</li>
</ul>
<p>可中断锁和不可中断锁：</p>
<ul>
<li><strong>可中断锁</strong>：获取锁的过程中可以被中断，不需要一直等到获取锁之后 才能进行其他逻辑处理。 <code>ReentrantLock</code> 就属于是可中断锁。</li>
<li><strong>不可中断锁</strong>：一旦线程申请了锁，就只能等到拿到锁以后才能进行其他的逻辑处理。 <code>synchronized</code> 就属于是不可中断锁。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reentrantlock">ReentrantLock<a href="#reentrantlock" class="hash-link" aria-label="Direct link to ReentrantLock" title="Direct link to ReentrantLock">​</a></h3>
<p><code>ReentrantLock</code> 提供了与 <code>synchronized</code> 类似的同步功能，但其提供了更灵活、更强大的功能，比如<strong>轮询、超时、中断、公平/非公平锁</strong>等高级功能。</p>
<p><code>ReentrantLock</code> 实现了 <code>Lock</code> 接口，是一个可重入且独占式的锁，里面有一个内部类 <code>Sync</code>，<code>Sync</code> 继承 <code>AQS</code>（<code>AbstractQueuedSynchronizer</code>），添加锁和释放锁的大部分操作实际上都是在 <code>Sync</code> 中实现的。 <code>ReentrantLock</code> 默认使用非公平锁，也可以通过构造器来显式地指定使用公平锁。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">Lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Acquires the lock.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Acquires the lock unless the current thread is {@linkplain Thread#interrupt interrupted}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lockInterruptibly</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Acquires the lock only if it is free at the time of invocation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tryLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Acquires the lock if it is free within the given waiting time and the</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * current thread has not been {@linkplain Thread#interrupt interrupted}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tryLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token plain"> unit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Releases the lock.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Returns a new {@link Condition} instance that is bound to this {@code Lock} instance.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Condition</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reentrantreadwritelock">ReentrantReadWriteLock<a href="#reentrantreadwritelock" class="hash-link" aria-label="Direct link to ReentrantReadWriteLock" title="Direct link to ReentrantReadWriteLock">​</a></h3>
<p><code>ReentrantReadWriteLock</code> 实现了 <code>ReadWriteLock</code> ，是一个可重入的读写锁，既可以保证多个线程同时读的效率，同时又可以保证有写入操作时的线程安全。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ReadWriteLock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Returns the lock used for reading.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Lock</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">readLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Returns the lock used for writing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Lock</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">writeLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stampedlock">StampedLock<a href="#stampedlock" class="hash-link" aria-label="Direct link to StampedLock" title="Direct link to StampedLock">​</a></h3>
<p><code>StampedLock</code> 是 JDK 1.8 引入的性能更好的读写锁，不可重入且不支持条件变量 <code>Condition</code>。不同于一般的 <code>Lock</code> 类，<code>StampedLock</code> 并不是直接实现 <code>Lock</code> 或 <code>ReadWriteLock</code> 接口，而是基于 <code>CLH</code> 锁 独立实现的。</p>
<p><code>StampedLock</code> 提供了三种模式的读写控制模式：</p>
<ul>
<li>写锁：独占锁，一把锁只能被一个线程获得。当一个线程获取写锁后，其他请求读锁和写锁的线程必须等待。类似于 ReentrantReadWriteLock 的写锁，不过这里的写锁是不可重入的。</li>
<li>读锁 （悲观读）：共享锁，没有线程获取写锁的情况下，多个线程可以同时持有读锁。如果己经有线程持有写锁，则其他线程请求获取该读锁会被阻塞。类似于 ReentrantReadWriteLock 的读锁，不过这里的读锁是不可重入的。</li>
<li>乐观读：允许多个线程获取乐观读以及读锁。同时允许一个写线程获取写锁。</li>
</ul>
<p>另外， <code>StampedLock</code> 还支持这三种锁在一定条件下进行相互转换。</p>
<p><code>StampedLock</code> 比较适合读多写少的场景，因为其采用乐观锁的机制，所以比 <code>ReadWriteLock</code> 性能更好。不过，需要注意的是 <code>StampedLock</code> 不可重入，不支持条件变量 <code>Condition</code> ，对中断操作支持也不友好（使用不当容易导致 CPU 飙升）。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="semaphore">Semaphore<a href="#semaphore" class="hash-link" aria-label="Direct link to Semaphore" title="Direct link to Semaphore">​</a></h3>
<p><code>synchronized</code> 和 <code>ReentrantLock</code> 都是一次只允许一个线程访问某个资源，而 <code>Semaphore</code> (信号量)可以用来控制<strong>同时访问特定资源的线程数量</strong>。</p>
<p><code>Semaphore</code> 通常用于那些资源有明确访问数量限制的场景。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="countdownlatch">CountDownLatch<a href="#countdownlatch" class="hash-link" aria-label="Direct link to CountDownLatch" title="Direct link to CountDownLatch">​</a></h3>
<p><code>CountDownLatch</code> 可以使一个或多个线程等待，直到其他线程的一系列操作完成，用来实现多线程屏障。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用场景-1">使用场景<a href="#使用场景-1" class="hash-link" aria-label="Direct link to 使用场景" title="Direct link to 使用场景">​</a></h4>
<p>场景一：等待n个线程执行完毕，实现多线程屏障</p>
<p>将 <code>CountDownLatch</code> 的计数器初始化为 <code>n</code> ，每当一个任务线程执行完毕，就将计数器减 <code>1</code>（<code>countdownlatch.countDown()</code>），当计数器的值变为 <code>0</code> 时，在 <code>CountDownLatch</code> 上 <code>await()</code> 的线程就会被唤醒。</p>
<p>场景二：尽可能地让多个线程并行执行</p>
<p>多个线程在某一时刻同时开始执行，类似于赛跑，将多个线程放到起点，等待发令枪响，然后同时开跑。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cyclicbarrier">CyclicBarrier<a href="#cyclicbarrier" class="hash-link" aria-label="Direct link to CyclicBarrier" title="Direct link to CyclicBarrier">​</a></h3>
<p><code>CyclicBarrier</code> 和 <code>CountDownLatch</code> 非常类似，它也可以实现多线程屏障，但是它的功能比 <code>CountDownLatch</code> 更加复杂和强大。主要应用场景和 <code>CountDownLatch</code> 类似。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><code>CyclicBarrier</code> 和 <code>CountDownLatch</code> 有什么区别？</div><div class="admonitionContent_BuS1"><ol>
<li><code>CountDownLatch</code> 是多个线程都进行了 <code>countDown</code> 之后才会触发事件，唤醒 <code>await</code> 在 <code>latch</code> 上的线程，执行完 <code>countDown</code> 操作之后会继续自己线程的工作。而 <code>CyclicBarrier</code> 是一个栅栏，用于同步所有调用 <code>await</code> 方法的线程，等到所有的方法都执行了 <code>await</code> 方法后，所有的线程才会返回各自执行自己的工作。</li>
<li><code>CountDownLatch</code> 计数器只能使用一次，而 <code>CyclicBarrier</code> 的计数器可以调用 <code>reset()</code> 方法重置，能处理更加复杂的业务场景。</li>
</ol></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="synchronousqueue">SynchronousQueue<a href="#synchronousqueue" class="hash-link" aria-label="Direct link to SynchronousQueue" title="Direct link to SynchronousQueue">​</a></h3>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a href="#参考资料" class="hash-link" aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li><a href="https://juejin.cn/post/7078545790594973733" target="_blank" rel="noopener noreferrer">掘金 - (四)深入理解Java并发编程之无锁CAS机制、魔法类Unsafe、原子包Atomic</a></li>
<li><a href="https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html" target="_blank" rel="noopener noreferrer">JavaGuide - Java并发常见面试题总结</a></li>
<li><a href="https://javaguide.cn/java/concurrent/aqs.html" target="_blank" rel="noopener noreferrer">JavaGuide - AQS详解</a></li>
<li><a href="https://juejin.cn/post/6844903918653145102" target="_blank" rel="noopener noreferrer">掘金 - Synchronized解析—如果你愿意一层一层剥开我的心</a></li>
<li><a href="https://juejin.cn/post/7067322092936495112" target="_blank" rel="noopener noreferrer">掘金 - 为什么wait和notify必须放在synchronized中？</a></li>
<li><a href="https://juejin.cn/post/6844903550586191885" target="_blank" rel="noopener noreferrer">掘金 - 浅谈偏向锁、轻量级锁、重量级锁</a></li>
<li><a href="https://juejin.cn/post/6977744582725681182" target="_blank" rel="noopener noreferrer">掘金 - (二)彻底理解Java并发编程之Synchronized关键字实现原理剖析</a></li>
<li><a href="https://segmentfault.com/a/1190000015808032" target="_blank" rel="noopener noreferrer">Segmentfault - StampedLock 底层原理分析</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/java/tags/java">java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/java/tags/concurrent">concurrent</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/java/tags/lock">lock</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-05-17T03:36:20.000Z" itemprop="dateModified">May 17, 2025</time></b> by <b>vyckey</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/java/java/concurrent/completablefuture"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">CompletableFuture</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/java/java/concurrent/thread"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Thread</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#乐观锁和悲观锁" class="table-of-contents__link toc-highlight">乐观锁和悲观锁</a><ul><li><a href="#乐观锁的实现方法" class="table-of-contents__link toc-highlight">乐观锁的实现方法</a><ul><li><a href="#版本号" class="table-of-contents__link toc-highlight">版本号</a></li><li><a href="#cas算法" class="table-of-contents__link toc-highlight">CAS算法</a><ul><li><a href="#什么是aba问题" class="table-of-contents__link toc-highlight">什么是ABA问题？</a></li><li><a href="#自旋锁详解" class="table-of-contents__link toc-highlight">自旋锁详解</a></li><li><a href="#只能保证一个共享变量的原子操作" class="table-of-contents__link toc-highlight">只能保证一个共享变量的原子操作</a></li></ul></li></ul></li><li><a href="#悲观锁" class="table-of-contents__link toc-highlight">悲观锁</a></li></ul></li><li><a href="#synchronized" class="table-of-contents__link toc-highlight">synchronized</a><ul><li><a href="#使用场景" class="table-of-contents__link toc-highlight">使用场景</a></li><li><a href="#反编译synchronized加以理解" class="table-of-contents__link toc-highlight">反编译synchronized加以理解</a></li><li><a href="#monitor监视器" class="table-of-contents__link toc-highlight">monitor监视器</a><ul><li><a href="#操作系统的管程" class="table-of-contents__link toc-highlight">操作系统的管程</a></li><li><a href="#objectmonitor" class="table-of-contents__link toc-highlight">ObjectMonitor</a></li><li><a href="#对象与objectmonitor的关联" class="table-of-contents__link toc-highlight">对象与ObjectMonitor的关联</a></li></ul></li><li><a href="#锁类型" class="table-of-contents__link toc-highlight">锁类型</a><ul><li><a href="#偏向锁" class="table-of-contents__link toc-highlight">偏向锁</a></li><li><a href="#轻量级锁" class="table-of-contents__link toc-highlight">轻量级锁</a><ul><li><a href="#自旋锁" class="table-of-contents__link toc-highlight">自旋锁</a></li><li><a href="#自适应自旋锁" class="table-of-contents__link toc-highlight">自适应自旋锁</a></li></ul></li><li><a href="#重量级锁" class="table-of-contents__link toc-highlight">重量级锁</a></li><li><a href="#样例代码分析" class="table-of-contents__link toc-highlight">样例代码分析</a></li><li><a href="#三种锁的总结" class="table-of-contents__link toc-highlight">三种锁的总结</a></li></ul></li><li><a href="#锁优化" class="table-of-contents__link toc-highlight">锁优化</a><ul><li><a href="#锁消除" class="table-of-contents__link toc-highlight">锁消除</a></li><li><a href="#锁粗化" class="table-of-contents__link toc-highlight">锁粗化</a></li></ul></li></ul></li><li><a href="#object中的内置锁" class="table-of-contents__link toc-highlight">Object中的内置锁</a><ul><li><a href="#wait方法" class="table-of-contents__link toc-highlight">wait()方法</a></li><li><a href="#notify方法" class="table-of-contents__link toc-highlight">notify()方法</a></li><li><a href="#notifyall方法" class="table-of-contents__link toc-highlight">notifyAll()方法</a></li><li><a href="#waitnotifynotifyall为什么必须放在synchronized中" class="table-of-contents__link toc-highlight">wait()、notify()、notifyAll()为什么必须放在synchronized中？</a></li></ul></li><li><a href="#jdk-中内置的工具锁" class="table-of-contents__link toc-highlight">JDK 中内置的工具锁</a><ul><li><a href="#锁的一些特性" class="table-of-contents__link toc-highlight">锁的一些特性</a></li><li><a href="#reentrantlock" class="table-of-contents__link toc-highlight">ReentrantLock</a></li><li><a href="#reentrantreadwritelock" class="table-of-contents__link toc-highlight">ReentrantReadWriteLock</a></li><li><a href="#stampedlock" class="table-of-contents__link toc-highlight">StampedLock</a></li><li><a href="#semaphore" class="table-of-contents__link toc-highlight">Semaphore</a></li><li><a href="#countdownlatch" class="table-of-contents__link toc-highlight">CountDownLatch</a><ul><li><a href="#使用场景-1" class="table-of-contents__link toc-highlight">使用场景</a></li></ul></li><li><a href="#cyclicbarrier" class="table-of-contents__link toc-highlight">CyclicBarrier</a></li><li><a href="#synchronousqueue" class="table-of-contents__link toc-highlight">SynchronousQueue</a></li></ul></li><li><a href="#参考资料" class="table-of-contents__link toc-highlight">参考资料</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Notes</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/java">Java</a></li><li class="footer__item"><a class="footer__link-item" href="/ai">AI</a></li></ul></div><div class="col footer__col"><div class="footer__title">E-mail</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:vyckeyolyland@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Google E-mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:vyckey@qq.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">QQ E-mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/vyckey/vyckey-computer-notes" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Vyckey's Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>